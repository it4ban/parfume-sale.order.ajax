// @ts-nocheck
BX.namespace("BX.Sale.OrderAjaxComponent"),function(){"use strict";BX.Sale&&BX.Sale.Input&&BX.Sale.Input.Utils&&(BX.Sale.Input.Utils.asMultiple=function(e){if(null==e||""===e)return[];if(e.constructor===Array){for(var t,i=0,s=e.length;i<s;)null==(t=e[i])||""===t?(e.splice(i,1),--s):++i;return e.length?e:[""]}return[e]}),BX.Sale.OrderAjaxComponent={initializePrimaryFields:function(){this.BXFormPosting=!1,this.regionBlockNotEmpty=!1,this.locationsInitialized=!1,this.locations={},this.cleanLocations={},this.locationsTemplate="",this.pickUpMapFocused=!1,this.options={},this.activeSectionId="",this.firstLoad=!0,this.initialized={},this.mapsReady=!1,this.lastSelectedDelivery=0,this.deliveryLocationInfo={},this.deliveryPagination={},this.deliveryCachedInfo=[],this.paySystemPagination={},this.validation={},this.hasErrorSection={},this.pickUpPagination={},this.timeOut={},this.changeUserData=void 0,this.isMobile=BX.browser.IsMobile(),this.isHttps="https:"===window.location.protocol,this.orderSaveAllowed=!1,this.socServiceHiddenNode=!1,this.currentDeliveryOwner="",this.deliveryData=null,this.customProperties=[],this.customPropertiesHtml=[]},init:function(e){this.initializePrimaryFields(),this.result=e.result||{},this.prepareLocations(e.locations),this.params=e.params||{},this.signedParamsString=e.signedParamsString||"",this.siteId=e.siteID||"",this.ajaxUrl=e.ajaxUrl||"",this.templateFolder=e.templateFolder||"",this.defaultBasketItemLogo=this.templateFolder+"/images/product_logo.png",this.defaultStoreLogo=this.templateFolder+"/images/pickup_logo.png",this.defaultDeliveryLogo=this.templateFolder+"/images/delivery_logo.png",this.defaultPaySystemLogo=this.templateFolder+"/images/pay_system_logo.png",this.deliveryTypeById=e.deliveryTypeById||{},this.orderData=e.orderData||[],this.userProfile=e.userProfile||[],this.orderBlockNode=BX(e.orderBlockId),this.totalBlockNode=BX(e.totalBlockId),this.mobileTotalBlockNode=BX(e.totalBlockId+"-mobile"),this.savedFilesBlockNode=BX("bx-soa-saved-files"),this.orderSaveBlockNode=BX("bx-soa-orderSave"),this.mainErrorsNode=BX("bx-soa-main-notifications"),this.authBlockNode=BX(e.authBlockId),this.authHiddenBlockNode=BX(e.authBlockId+"-hidden"),this.basketBlockNode=BX(e.basketBlockId),this.basketHiddenBlockNode=BX(e.basketBlockId+"-hidden"),this.regionBlockNode=BX(e.regionBlockId),this.regionHiddenBlockNode=BX(e.regionBlockId+"-hidden"),this.paySystemBlockNode=BX(e.paySystemBlockId),this.paySystemHiddenBlockNode=BX(e.paySystemBlockId+"-hidden"),this.deliveryBlockNode=BX(e.deliveryBlockId),this.deliveryHiddenBlockNode=BX(e.deliveryBlockId+"-hidden"),this.pickUpBlockNode=BX(e.pickUpBlockId),this.pickUpHiddenBlockNode=BX(e.pickUpBlockId+"-hidden"),this.propsBlockNode=BX(e.propsBlockId),this.propsHiddenBlockNode=BX(e.propsBlockId+"-hidden"),this.result.SHOW_AUTH&&(this.authBlockNode.style.display="",BX.addClass(this.authBlockNode,"bx-active"),this.authGenerateUser="Y"!==this.result.AUTH.new_user_registration_email_confirmation&&"Y"!==this.result.AUTH.new_user_phone_required),this.totalBlockNode&&(this.totalInfoBlockNode=this.totalBlockNode.querySelector(".bx-soa-cart-total"),this.totalGhostBlockNode=this.totalBlockNode.querySelector(".bx-soa-cart-total-ghost")),this.options.deliveriesPerPage=parseInt(e.params.DELIVERIES_PER_PAGE),this.options.paySystemsPerPage=parseInt(e.params.PAY_SYSTEMS_PER_PAGE),this.options.pickUpsPerPage=parseInt(e.params.PICKUPS_PER_PAGE),this.options.showWarnings=!!e.showWarnings,this.options.propertyValidation=!!e.propertyValidation,this.options.priceDiffWithLastTime=!1,this.options.pickUpMap=e.pickUpMap,this.options.propertyMap=e.propertyMap,this.options.totalPriceChanged=!1,this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||this.initFirstSection(),this.initOptions(),this.editOrder(),this.bindEvents(),this.orderBlockNode.removeAttribute("style"),this.basketBlockScrollCheck(),"Y"===this.params.USE_ENHANCED_ECOMMERCE&&this.setAnalyticsDataLayer("checkout"),"Y"===this.params.USER_CONSENT&&this.initUserConsent()},sendRequest:function(e,t){var i;if(this.startLoader()){this.firstLoad=!1;var s={action:e=BX.type.isNotEmptyString(e)?e:"refreshOrderAjax",actionData:t,cancel:!1};BX.Event.EventEmitter.emit("BX.Sale.OrderAjaxComponent:onBeforeSendRequest",s),s.cancel?this.endLoader():"saveOrderAjax"===s.action?((i=BX("bx-soa-order-form"))&&(i.querySelector("input[type=hidden][name=sessid]").value=BX.bitrix_sessid()),BX.ajax.submitAjax(BX("bx-soa-order-form"),{url:this.ajaxUrl,method:"POST",dataType:"json",data:{via_ajax:"Y",action:"saveOrderAjax",sessid:BX.bitrix_sessid(),SITE_ID:this.siteId,signedParamsString:this.signedParamsString},onsuccess:BX.proxy(this.saveOrderWithJson,this),onfailure:BX.proxy(this.handleNotRedirected,this)})):BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:this.getData(s.action,s.actionData),onsuccess:BX.delegate((function(e){switch(e.redirect&&e.redirect.length&&(document.location.href=e.redirect),this.saveFiles(),s.action){case"refreshOrderAjax":this.refreshOrder(e);break;case"confirmSmsCode":case"showAuthForm":this.firstLoad=!0,this.refreshOrder(e);break;case"enterCoupon":e&&e.order?(this.deliveryCachedInfo=[],this.refreshOrder(e)):this.addCoupon(e);break;case"removeCoupon":e&&e.order?(this.deliveryCachedInfo=[],this.refreshOrder(e)):this.removeCoupon(e)}BX.cleanNode(this.savedFilesBlockNode),this.endLoader()}),this),onfailure:BX.delegate((function(){this.endLoader()}),this)})}},getData:function(e,t){var i={order:this.getAllFormData(),sessid:BX.bitrix_sessid(),via_ajax:"Y",SITE_ID:this.siteId,signedParamsString:this.signedParamsString};return i[this.params.ACTION_VARIABLE]=e,"enterCoupon"!==e&&"removeCoupon"!==e||(i.coupon=t),i},getAllFormData:function(){var e,t=BX("bx-soa-order-form"),i=BX.ajax.prepareForm(t);for(e in i.data)i.data.hasOwnProperty(e)&&""==e&&delete i.data[e];return i&&i.data?i.data:{}},refreshOrder:function(e){if(e.error)this.showError(this.mainErrorsNode,e.error),this.animateScrollTo(this.mainErrorsNode,800,20);else if(e.order.SHOW_AUTH){var t;t=e.order.OK_MESSAGE&&e.order.OK_MESSAGE.length||e.order.SMS_AUTH&&"OK"===e.order.SMS_AUTH.TYPE?"bx-step-good":"bx-step-bad",this.addAnimationEffect(this.authBlockNode,t),BX.merge(this.result,e.order),this.editAuthBlock(),this.showAuthBlock(),this.showErrors(e.order.ERROR,!1),this.animateScrollTo(this.authBlockNode)}else this.isPriceChanged(e),this.activeSectionId!==this.deliveryBlockNode.id&&(this.deliveryCachedInfo=[]),this.result=e.order,this.prepareLocations(e.locations),this.locationsInitialized=!1,this.maxWaitTimeExpired=!1,this.pickUpMapFocused=!1,this.deliveryLocationInfo={},this.initialized={},this.clearHiddenBlocks(),this.initOptions(),this.editOrder(),this.mapsReady&&this.initMaps(),BX.saleOrderAjax&&BX.saleOrderAjax.initDeferredControl();return!0},saveOrderWithJson:function(e){var t=!1;e&&e.order&&((e=e.order).REDIRECT_URL?("Y"===this.params.USE_ENHANCED_ECOMMERCE&&this.setAnalyticsDataLayer("purchase",e.ID),(window.b24order=window.b24order||[]).push({id:e.ID,sum:this.result.TOTAL.ORDER_PRICE}),t=!0,location.href=e.REDIRECT_URL):e.SHOW_AUTH?(this.result.SHOW_AUTH=e.SHOW_AUTH,this.result.AUTH=e.AUTH,this.result.SMS_AUTH=e.SMS_AUTH,this.editAuthBlock(),this.showAuthBlock(),this.animateScrollTo(this.authBlockNode)):this.showErrors(e.ERROR,!0,!0)),t||this.handleNotRedirected()},handleNotRedirected:function(){this.endLoader(),this.disallowOrderSave()},startLoader:function(){return!0!==this.BXFormPosting&&(this.BXFormPosting=!0,this.loadingScreen||(this.loadingScreen=new BX.PopupWindow("loading_screen",null,{overlay:{backgroundColor:"white",opacity:1},events:{onAfterPopupShow:BX.delegate((function(){BX.cleanNode(this.loadingScreen.popupContainer),BX.removeClass(this.loadingScreen.popupContainer,"popup-window"),this.loadingScreen.popupContainer.appendChild(BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})),this.loadingScreen.popupContainer.removeAttribute("style"),this.loadingScreen.popupContainer.style.display="block"}),this)}}),BX.addClass(this.loadingScreen.overlay.element,"bx-step-opacity")),this.loadingScreen.overlay.element.style.opacity="0",this.loadingScreen.show(),this.loadingScreen.overlay.element.style.opacity="0.6",!0)},endLoader:function(){this.BXFormPosting=!1,this.loadingScreen&&this.loadingScreen.isShown()&&this.loadingScreen.close()},htmlspecialcharsEx:function(e){return e.replace(/&amp;/g,"&amp;amp;").replace(/&lt;/g,"&amp;lt;").replace(/&gt;/g,"&amp;gt;").replace(/&quot;/g,"&amp;quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},saveFiles:function(){if(this.result.ORDER_PROP&&this.result.ORDER_PROP.properties){var e,t,i=this.result.ORDER_PROP.properties;for(e=0;e<i.length;e++)"FILE"==i[e].TYPE&&(t=this.orderBlockNode.querySelector('div[data-property-id-row="'+i[e].ID+'"]'))&&this.savedFilesBlockNode.appendChild(t)}},animateScrollTo:function(e,t,i){if(e){var s=BX.GetWindowScrollPos().scrollTop,a=BX.pos(this.orderBlockNode),r=BX.pos(e).top-(this.isMobile?50:0);i&&(r-=parseInt(i)),r+window.innerHeight>a.bottom&&(r=a.bottom-window.innerHeight+17),new BX.easing({duration:t||800,start:{scroll:s},finish:{scroll:r},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate((function(e){window.scrollTo(0,e.scroll)}),this)}).animate()}},checkKeyPress:function(e){if(13==e.keyCode){var t,i,s=e.target||e.srcElement;if(!s.getAttribute("data-send"))return(t=s.getAttribute("data-next"))&&(i=this.orderBlockNode.querySelector("input[name="+t+"]"))&&i.focus(),BX.PreventDefault(e)}},getSizeString:function(e,t){var i=1073741824,s=1048576;return e=parseInt(e),t=parseInt(t),e>i?parseFloat(e/i).toFixed(t)+" Gb":e>s?parseFloat(e/s).toFixed(t)+" Mb":e>1024?parseFloat(e/1024).toFixed(t)+" Kb":e+" B"},getFileAccepts:function(e){var t,i,s=[],a=e.split(","),r={json:"application/json",javascript:"application/javascript","octet-stream":"application/octet-stream",ogg:"application/ogg",pdf:"application/pdf",zip:"application/zip",gzip:"application/gzip",aac:"audio/aac",mp3:"audio/mpeg",gif:"image/gif",jpeg:"image/jpeg",png:"image/png",svg:"image/svg+xml",tiff:"image/tiff",css:"text/css",csv:"text/csv",html:"text/html",plain:"text/plain",php:"text/php",xml:"text/xml",mpeg:"video/mpeg",mp4:"video/mp4",quicktime:"video/quicktime",flv:"video/x-flv",doc:"application/msword",docx:"application/msword",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel"};for(t=0;t<a.length;t++)i=r[i=BX.util.trim(a[t])]||i,s.push(i);return s.join(",")},uniqueText:function(e,t){var i,s,a=[];for(t=t||"<br>",i=(e=e||"").split(t),i=BX.util.array_unique(i),s=0;s<i.length;s++)""!=i[s]&&a.push(BX.util.trim(i[s]));return a.join(t)},getImageSources:function(e,t){return!!(e&&t&&e[t])&&{src_1x:e[t+"_SRC"],src_2x:e[t+"_SRC_2X"],src_orig:e[t+"_SRC_ORIGINAL"]}},getErrorContainer:function(e){e&&e.appendChild(BX.create("DIV",{props:{className:"alert alert-danger"},style:{display:"none"}}))},showError:function(e,t,i){BX.type.isArray(t)&&(t=t.join("<br>"));var s=e.querySelector(".alert.alert-danger");s&&t.length&&(BX.cleanNode(s),s.appendChild(BX.create("DIV",{html:t})),!this.hasErrorSection[e.id]?(s.style.opacity=0,s.style.display="",new BX.easing({duration:300,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.opacity=e.opacity/100},complete:function(){s.removeAttribute("style")}}).animate()):s.style.display="",i&&BX.addClass(e,"bx-step-error"))},showErrors:function(e,t,i){var s,a,r,o=this.orderBlockNode.querySelectorAll("div.alert.alert-danger");for(a=0;a<o.length;a++)s=BX.findParent(o[a],{className:"bx-soa-section"}),BX.removeClass(s,"bx-step-error"),o[a].style.display="none",BX.cleanNode(o[a]);if(e&&!(BX.util.object_keys(e).length<1)){for(a in e)if(e.hasOwnProperty(a))switch(r=e[a],a.toUpperCase()){case"MAIN":this.showError(this.mainErrorsNode,r),this.animateScrollTo(this.mainErrorsNode,800,20),t=!1;break;case"AUTH":"none"==this.authBlockNode.style.display?(this.showError(this.mainErrorsNode,r,!0),this.animateScrollTo(this.mainErrorsNode,800,20),t=!1):this.showError(this.authBlockNode,r,!0);break;case"REGION":(i||"true"===this.regionBlockNode.getAttribute("data-visited"))&&(this.showError(this.regionBlockNode,r,!0),this.showError(this.regionHiddenBlockNode,r));break;case"DELIVERY":(i||"true"===this.deliveryBlockNode.getAttribute("data-visited"))&&(this.showError(this.deliveryBlockNode,r,!0),this.showError(this.deliveryHiddenBlockNode,r));break;case"PAY_SYSTEM":(i||"true"===this.paySystemBlockNode.getAttribute("data-visited"))&&(this.showError(this.paySystemBlockNode,r,!0),this.showError(this.paySystemHiddenBlockNode,r));break;case"PROPERTY":(i||"true"===this.propsBlockNode.getAttribute("data-visited"))&&(this.showError(this.propsBlockNode,r,!0),this.showError(this.propsHiddenBlockNode,r))}t&&this.scrollToError()}},showBlockErrors:function(e){var t,i,s=e.querySelector("div.alert.alert-danger");if(s){switch(BX.removeClass(e,"bx-step-error"),s.style.display="none",BX.cleanNode(s),e.id){case this.regionBlockNode.id:t=this.regionHiddenBlockNode,i=this.result.ERROR.REGION;break;case this.deliveryBlockNode.id:t=this.deliveryHiddenBlockNode,i=this.result.ERROR.DELIVERY;break;case this.paySystemBlockNode.id:t=this.paySystemHiddenBlockNode,i=this.result.ERROR.PAY_SYSTEM;break;case this.propsBlockNode.id:t=this.propsHiddenBlockNode,i=this.result.ERROR.PROPERTY}i&&BX.util.object_keys(i).length&&(this.showError(e,i,!0),this.showError(t,i))}},checkNotifications:function(){var e,t,i,s,a,r,o=this.mainErrorsNode.querySelector('[data-type="informer"]');o&&(this.firstLoad&&this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL?(i=(e=(t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active")).length&&"true"==t[t.length-1].getAttribute("data-visited"))?"success":"warning",s=(e?this.params.MESS_SUCCESS_PRELOAD_TEXT:this.params.MESS_FAIL_PRELOAD_TEXT).split("#ORDER_BUTTON#").join(this.params.MESS_ORDER),o.appendChild(BX.create("DIV",{props:{className:"row"},children:[BX.create("DIV",{props:{className:"col-xs-12"},style:{position:"relative",paddingLeft:"48px"},children:[BX.create("DIV",{props:{className:"icon-"+i}}),BX.create("DIV",{html:s})]})]})),BX.addClass(o,"alert alert-"+i),o.style.display=""):BX.hasClass(o,"alert")&&(a=BX.GetWindowScrollPos().scrollTop,r=BX.pos(o),new BX.easing({duration:300,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.linear,step:function(e){o.style.opacity=e.opacity/100},complete:function(){a>r.top&&window.scrollBy(0,-(r.height+20)),o.style.display="none",BX.cleanNode(o),o.removeAttribute("class"),o.removeAttribute("style")}}).animate()))},checkPreload:function(e){var t;switch(e.id){case this.regionBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PERSON_TYPE;break;case this.paySystemBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PAY_SYSTEM;break;case this.deliveryBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.DELIVERY;break;case this.pickUpBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PICK_UP;break;default:t=!0}return t},checkBlockErrors:function(e){var t,i,s,a,r,o;if((t=BX(e.id+"-hidden"))&&(s=(i=t.querySelector("div.alert.alert-danger"))&&"none"!=i.style.display,a=t.querySelector("div.alert.alert-warning.alert-show"),!s))for(r=t.querySelectorAll("div.tooltip"),o=0;o<r.length;o++)if("opened"==r[o].getAttribute("data-state")){s=!0;break}return s?BX.addClass(e,"bx-step-error"):a?BX.addClass(e,"bx-step-warning"):BX.removeClass(e,"bx-step-error bx-step-warning"),!s},scrollToError:function(){var e,t,i=this.orderBlockNode.querySelectorAll("div.bx-soa-section.bx-active");for(e in i)if(i.hasOwnProperty(e)&&(t=i[e].querySelector(".alert.alert-danger"))&&"none"!=t.style.display){this.animateScrollTo(i[e]);break}},showWarnings:function(){var e,t,i=this.orderBlockNode.querySelectorAll("div.bx-soa-section.bx-active"),s=this.getSelectedDelivery();for(e=0;e<i.length;e++)BX.removeClass(i[e],"bx-step-warning"),"false"==i[e].getAttribute("data-visited")&&BX.removeClass(i[e],"bx-step-completed");if(s&&s.CALCULATE_ERRORS?(BX.addClass(this.deliveryBlockNode,"bx-step-warning"),t="<strong>"+this.params.MESS_DELIVERY_CALC_ERROR_TITLE+"</strong>",this.params.MESS_DELIVERY_CALC_ERROR_TEXT.length&&(t+="<br><small>"+this.params.MESS_DELIVERY_CALC_ERROR_TEXT+"</small>"),this.showBlockWarning(this.deliveryBlockNode,t),this.showBlockWarning(this.deliveryHiddenBlockNode,t),this.activeSectionId!=this.deliveryBlockNode.id&&(BX.addClass(this.deliveryBlockNode,"bx-step-completed"),BX.bind(this.deliveryBlockNode.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this)))):BX.hasClass(this.deliveryBlockNode,"bx-step-warning")&&this.activeSectionId!=this.deliveryBlockNode.id&&BX.removeClass(this.deliveryBlockNode,"bx-step-warning"),this.result.WARNING&&this.options.showWarnings)for(e in this.result.WARNING)if(this.result.WARNING.hasOwnProperty(e))switch(e.toUpperCase()){case"DELIVERY":"true"===this.deliveryBlockNode.getAttribute("data-visited")&&(this.showBlockWarning(this.deliveryBlockNode,this.result.WARNING[e],!0),this.showBlockWarning(this.deliveryHiddenBlockNode,this.result.WARNING[e],!0));break;case"PAY_SYSTEM":"true"===this.paySystemBlockNode.getAttribute("data-visited")&&(this.showBlockWarning(this.paySystemBlockNode,this.result.WARNING[e],!0),this.showBlockWarning(this.paySystemHiddenBlockNode,this.result.WARNING[e],!0))}},notifyAboutWarnings:function(e){if(BX.type.isDomNode(e))switch(e.id){case this.deliveryBlockNode.id:this.showBlockWarning(this.deliveryBlockNode,this.result.WARNING.DELIVERY,!0);break;case this.paySystemBlockNode.id:this.showBlockWarning(this.paySystemBlockNode,this.result.WARNING.PAY_SYSTEM,!0)}},showBlockWarning:function(e,t,i){var s,a,r,o=e.querySelector(".alert.alert-danger"),l="";if(o){if(BX.type.isString(t))l=t;else for(s in t)t.hasOwnProperty(s)&&t[s]&&(l+=t[s]+"<br>");if(!l)return;for(s in r=e.querySelectorAll(".alert.alert-warning"))if(r.hasOwnProperty(s)&&BX.type.isDomNode(r[s])&&-1!==r[s].innerHTML.indexOf(l))return;a=BX.create("DIV",{props:{className:"alert alert-warning"+(i?" alert-hide":" alert-show")},html:l}),BX.prepend(a,o.parentNode),BX.addClass(e,"bx-step-warning")}},showPagination:function(e,t){if(t&&e){var i,s,a,r,o,l,n=[];switch(e){case"delivery":i=this.deliveryPagination;break;case"paySystem":i=this.paySystemPagination;break;case"pickUp":i=this.pickUpPagination}if(i.pages.length>1){for(n.push(BX.create("LI",{attrs:{"data-action":"prev","data-entity":e},props:{className:"bx-pag-prev"},html:1==i.pageNumber?"<span>"+this.params.MESS_NAV_BACK+"</span>":'<a href=""><span>'+this.params.MESS_NAV_BACK+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}})),s=0;s<i.pages.length;s++)r=(a=parseInt(s)+1)==i.pageNumber?"bx-active":"",n.push(BX.create("LI",{attrs:{"data-action":a,"data-entity":e},props:{className:r},html:'<a href=""><span>'+a+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}}));n.push(BX.create("LI",{attrs:{"data-action":"next","data-entity":e},props:{className:"bx-pag-next"},html:i.pageNumber==i.pages.length?"<span>"+this.params.MESS_NAV_FORWARD+"</span>":'<a href=""><span>'+this.params.MESS_NAV_FORWARD+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}})),o=this.params.TEMPLATE_THEME||"",l=BX.create("DIV",{props:{className:"bx-pagination"+(o?" bx-"+o:"")},children:[BX.create("DIV",{props:{className:"bx-pagination-container"},children:[BX.create("UL",{children:n})]})]}),t.appendChild(BX.create("DIV",{style:{clear:"both"}})),t.appendChild(l)}}},doPagination:function(e){var t,i=e.target||e.srcElement,s="LI"==i.tagName?i:BX.findParent(i,{tagName:"LI"}),a=s.getAttribute("data-action"),r=s.getAttribute("data-entity");return BX.hasClass(s,"bx-active")||("prev"!=a&&"next"!=a||(t=parseInt(BX.findParent(s).querySelector(".bx-active").getAttribute("data-action")),a="next"==a?++t:--t),"delivery"==r?this.showDeliveryItemsPage(a):"paySystem"==r?this.showPaySystemItemsPage(a):"pickUp"==r&&this.showPickUpItemsPage(a)),BX.PreventDefault(e)},showDeliveryItemsPage:function(e){this.getCurrentPageItems("delivery",e);var t,i,s,a,r=this.getSelectedDelivery();for(r&&r.ID&&((t=this.deliveryBlockNode.querySelector("input[type=hidden][name=DELIVERY_ID]"))||(t=BX.create("INPUT",{props:{type:"hidden",name:"DELIVERY_ID",value:r.ID}}))),i=this.deliveryBlockNode.querySelector(".bx-soa-pp-item-container"),BX.cleanNode(i),BX.type.isDomNode(t)&&BX.prepend(t,BX.findParent(i)),s=0;s<this.deliveryPagination.currentPage.length;s++)a=this.createDeliveryItem(this.deliveryPagination.currentPage[s]),i.appendChild(a);this.showPagination("delivery",i)},showPaySystemItemsPage:function(e){this.getCurrentPageItems("paySystem",e);var t,i,s,a,r=this.getSelectedPaySystem();for(r&&r.ID&&((t=this.paySystemBlockNode.querySelector("input[type=hidden][name=PAY_SYSTEM_ID]"))||(t=BX.create("INPUT",{props:{type:"hidden",name:"PAY_SYSTEM_ID",value:r.ID}}))),i=this.paySystemBlockNode.querySelector(".bx-soa-pp-item-container"),BX.cleanNode(i),BX.type.isDomNode(t)&&BX.prepend(t,BX.findParent(i)),s=0;s<this.paySystemPagination.currentPage.length;s++)a=this.createPaySystemItem(this.paySystemPagination.currentPage[s]),i.appendChild(a);this.showPagination("paySystem",i)},showPickUpItemsPage:function(e){this.getCurrentPageItems("pickUp",e),this.editPickUpList(!1)},getCurrentPageItems:function(e,t){if(e&&void 0!==t){var i,s;switch(e){case"delivery":i=this.deliveryPagination,s=this.options.deliveriesPerPage;break;case"paySystem":i=this.paySystemPagination,s=this.options.paySystemsPerPage;break;case"pickUp":i=this.pickUpPagination,s=this.options.pickUpsPerPage}if(i&&s>0){if(t<=0||t>i.pages.length)return;i.pageNumber=t,i.currentPage=i.pages.slice(i.pageNumber-1,i.pageNumber)[0]}}},initPropsListForLocation:function(){var e,t,i,s;if(BX.saleOrderAjax&&this.result.ORDER_PROP&&this.result.ORDER_PROP.properties)for(BX.saleOrderAjax.cleanUp(),e=0;e<this.result.ORDER_PROP.properties.length;e++)if("LOCATION"==(i=this.result.ORDER_PROP.properties[e]).TYPE&&"Y"==i.MULTIPLE&&"Y"!=i.IS_LOCATION)for(t=0;t<this.locations[i.ID].length;t++)BX.saleOrderAjax.addPropertyDesc({id:i.ID+"_"+t,attributes:{id:i.ID+"_"+t,type:i.TYPE,valueSource:"DEFAULT"==i.SOURCE?"default":"form"}});else s={id:i.ID,type:i.TYPE,valueSource:"DEFAULT"==i.SOURCE?"default":"form"},!this.deliveryLocationInfo.city&&parseInt(i.INPUT_FIELD_LOCATION)>0&&(s.altLocationPropId=parseInt(i.INPUT_FIELD_LOCATION),this.deliveryLocationInfo.city=i.INPUT_FIELD_LOCATION),this.deliveryLocationInfo.loc||"Y"!=i.IS_LOCATION||(this.deliveryLocationInfo.loc=i.ID),this.deliveryLocationInfo.zip||"Y"!=i.IS_ZIP||(s.isZip=!0,this.deliveryLocationInfo.zip=i.ID),BX.saleOrderAjax.addPropertyDesc({id:i.ID,attributes:s})},bindEvents:function(){BX.bind(this.orderSaveBlockNode.querySelector("[data-save-button]"),"click",BX.proxy(this.clickOrderSaveAction,this)),BX.bind(window,"scroll",BX.proxy(this.totalBlockScrollCheck,this)),BX.bind(window,"resize",BX.throttle((function(){this.totalBlockResizeCheck(),this.alignBasketColumns(),this.basketBlockScrollCheck(),this.mapsReady&&this.resizeMapContainers()}),50,this)),BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(this.sendRequest,this))},initFirstSection:function(){var e=this.orderBlockNode.querySelector(".bx-soa-section.bx-active");BX.addClass(e,"bx-selected"),this.activeSectionId=e.id},initOptions:function(){var e,t,i;if(this.initPropsListForLocation(),this.propertyCollection=new BX.Sale.PropertyCollection(BX.merge({publicMode:!0},this.result.ORDER_PROP)),this.fadedPropertyCollection=new BX.Sale.PropertyCollection(BX.merge({publicMode:!0},this.result.ORDER_PROP)),this.options.propertyValidation&&this.initValidation(),this.initPagination(),this.options.showPreviewPicInBasket=!1,this.options.showDetailPicInBasket=!1,this.options.showPropsInBasket=!1,this.options.showPriceNotesInBasket=!1,this.result.GRID&&this.result.GRID.HEADERS)for(e=this.result.GRID.HEADERS,t=0;t<e.length;t++)"PREVIEW_PICTURE"===e[t].id&&(this.options.showPreviewPicInBasket=!0),"DETAIL_PICTURE"===e[t].id&&(this.options.showDetailPicInBasket=!0),"PROPS"===e[t].id&&(this.options.showPropsInBasket=!0),"NOTES"===e[t].id&&(this.options.showPriceNotesInBasket=!0);this.result.TOTAL&&(i=this.result.TOTAL,this.options.showOrderWeight=i.ORDER_WEIGHT&&parseFloat(i.ORDER_WEIGHT)>0,this.options.showPriceWithoutDiscount=parseFloat(i.ORDER_PRICE)<parseFloat(i.PRICE_WITHOUT_DISCOUNT_VALUE),this.options.showDiscountPrice=i.DISCOUNT_PRICE&&parseFloat(i.DISCOUNT_PRICE)>0,this.options.showTaxList=i.TAX_LIST&&i.TAX_LIST.length,this.options.showPayedFromInnerBudget=i.PAYED_FROM_ACCOUNT_FORMATED&&i.PAYED_FROM_ACCOUNT_FORMATED.length)},reachGoal:function(e,t){var i,s=this.params.YM_GOALS_COUNTER||"";"Y"==this.params.USE_YM_GOALS&&void 0!==window["yaCounter"+s]&&(i=this.getGoalId(e,t),window["yaCounter"+s].reachGoal(i))},getGoalId:function(e,t){if(!e)return"";if("initialization"==e)return this.params.YM_GOALS_INITIALIZE;if("order"==e)return this.params.YM_GOALS_SAVE_ORDER;var i="",s="edit"==e;if(!t||!t.id)return"";switch(t.id){case this.basketBlockNode.id:i=s?this.params.YM_GOALS_EDIT_BASKET:this.params.YM_GOALS_NEXT_BASKET;break;case this.regionBlockNode.id:i=s?this.params.YM_GOALS_EDIT_REGION:this.params.YM_GOALS_NEXT_REGION;break;case this.paySystemBlockNode.id:i=s?this.params.YM_GOALS_EDIT_PAY_SYSTEM:this.params.YM_GOALS_NEXT_PAY_SYSTEM;break;case this.deliveryBlockNode.id:i=s?this.params.YM_GOALS_EDIT_DELIVERY:this.params.YM_GOALS_NEXT_DELIVERY;break;case this.pickUpBlockNode.id:i=s?this.params.YM_GOALS_EDIT_PICKUP:this.params.YM_GOALS_NEXT_PICKUP;break;case this.propsBlockNode.id:i=s?this.params.YM_GOALS_EDIT_PROPERTIES:this.params.YM_GOALS_NEXT_PROPERTIES}return i},isPriceChanged:function(e){var t=null===this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY||""===this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?this.result.TOTAL.ORDER_TOTAL_PRICE:this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY,i=null===e.order.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?e.order.TOTAL.ORDER_TOTAL_PRICE:e.order.TOTAL.ORDER_TOTAL_LEFT_TO_PAY;this.options.totalPriceChanged=parseFloat(t)!=parseFloat(i)},initValidation:function(){if(this.result.ORDER_PROP&&this.result.ORDER_PROP.properties){var e,t=this.result.ORDER_PROP.properties,i={};for(e in t)t.hasOwnProperty(e)&&(i[t[e].ID]=t[e]);this.validation.properties=i}},initPagination:function(){var e,t,i,s;if(this.result.DELIVERY)if(this.result.DELIVERY=this.getDeliverySortedArray(this.result.DELIVERY),this.options.deliveriesPerPage>0&&this.result.DELIVERY.length>this.options.deliveriesPerPage){for(e=this.result.DELIVERY.slice(),t=Math.ceil(e.length/this.options.deliveriesPerPage),i=[],s=0;s<t;s++)i.push(e.splice(0,this.options.deliveriesPerPage));for(this.deliveryPagination.pages=i,s=0;s<this.result.DELIVERY.length;s++)if("Y"==this.result.DELIVERY[s].CHECKED){this.deliveryPagination.pageNumber=Math.ceil(++s/this.options.deliveriesPerPage);break}this.deliveryPagination.pageNumber=this.deliveryPagination.pageNumber||1,this.deliveryPagination.currentPage=i.slice(this.deliveryPagination.pageNumber-1,this.deliveryPagination.pageNumber)[0],this.deliveryPagination.show=!0}else this.deliveryPagination.pageNumber=1,this.deliveryPagination.currentPage=this.result.DELIVERY,this.deliveryPagination.show=!1;if(this.result.PAY_SYSTEM)if(this.options.paySystemsPerPage>0&&this.result.PAY_SYSTEM.length>this.options.paySystemsPerPage){for(e=this.result.PAY_SYSTEM.slice(),t=Math.ceil(e.length/this.options.paySystemsPerPage),i=[],s=0;s<t;s++)i.push(e.splice(0,this.options.paySystemsPerPage));for(this.paySystemPagination.pages=i,s=0;s<this.result.PAY_SYSTEM.length;s++)if("Y"==this.result.PAY_SYSTEM[s].CHECKED){this.paySystemPagination.pageNumber=Math.ceil(++s/this.options.paySystemsPerPage);break}this.paySystemPagination.pageNumber=this.paySystemPagination.pageNumber||1,this.paySystemPagination.currentPage=i.slice(this.paySystemPagination.pageNumber-1,this.paySystemPagination.pageNumber)[0],this.paySystemPagination.show=!0}else this.paySystemPagination.pageNumber=1,this.paySystemPagination.currentPage=this.result.PAY_SYSTEM,this.paySystemPagination.show=!1},initPickUpPagination:function(){var e,t,i,s,a=!1,r=!1,o=0;if(this.options.pickUpsPerPage>=0&&this.result.DELIVERY)for(o=0;o<this.result.DELIVERY.length;o++)if("Y"===this.result.DELIVERY[o].CHECKED&&this.result.DELIVERY[o].STORE_MAIN){r=this.result.DELIVERY[o].STORE_MAIN.length>0,a=this.result.DELIVERY[o].STORE_MAIN.length>this.options.pickUpsPerPage,r&&(e=this.getPickUpInfoArray(this.result.DELIVERY[o].STORE_MAIN));break}if(r)if(this.options.pickUpsPerPage>0&&a){for(t=e.slice(),i=Math.ceil(t.length/this.options.pickUpsPerPage),s=[],o=0;o<i;o++)s.push(t.splice(0,this.options.pickUpsPerPage));for(this.pickUpPagination.pages=s,o=0;o<e.length;o++)if(!this.result.BUYER_STORE||e[o].ID==this.result.BUYER_STORE){this.pickUpPagination.pageNumber=Math.ceil(++o/this.options.pickUpsPerPage);break}this.pickUpPagination.pageNumber||(this.pickUpPagination.pageNumber=1),this.pickUpPagination.currentPage=s.slice(this.pickUpPagination.pageNumber-1,this.pickUpPagination.pageNumber)[0],this.pickUpPagination.show=!0}else this.pickUpPagination.pageNumber=1,this.pickUpPagination.currentPage=e,this.pickUpPagination.show=!1},prepareLocations:function(e){var t,i,s,a;if(this.locations={},this.cleanLocations={},BX.util.object_keys(e).length)for(i in e)if(e.hasOwnProperty(i)){for(s in this.locationsTemplate=e[i].template||"",t=[],(a=e[i].output).clean&&(this.cleanLocations[i]=BX.processHTML(a.clean,!1),delete a.clean),a)a.hasOwnProperty(s)&&t.push({output:BX.processHTML(a[s],!1),showAlt:e[i].showAlt,lastValue:e[i].lastValue,coordinates:e[i].coordinates||!1});this.locations[i]=t}},locationsCompletion:function(){var e,t,i,s,a,r,o,l;for(e in this.locationsInitialized=!0,this.fixLocationsStyle(this.regionBlockNode,this.regionHiddenBlockNode),this.fixLocationsStyle(this.propsBlockNode,this.propsHiddenBlockNode),this.locations)this.locations.hasOwnProperty(e)&&(t=this.orderBlockNode.querySelector('div[data-property-id-row="'+e+'"]'))&&(i=t.querySelector("div.bx-ui-sls-clear"),s=t.querySelector("div.bx-ui-slst-pool"),a=t.querySelector("input.bx-ui-sls-fake[type=text]"),t.removeAttribute("style"),this.bindValidation(e,t),i&&BX.bind(i,"click",(function(e){var t,i=e.target||e.srcElement,s=BX.findParent(i,{tagName:"DIV",className:"form-group"});s&&(t=s.querySelector("input.bx-ui-sls-fake[type=text]")),t&&BX.fireEvent(t,"keyup")})),!this.firstLoad&&this.options.propertyValidation&&(s&&(r=this.validation.properties[e],o=this.getValidationData(r,t),(l=BX.findParent(t,{className:"bx-soa-section"}))&&"true"==l.getAttribute("data-visited")&&this.isValidProperty(o)),a&&BX.fireEvent(a,"keyup")));this.firstLoad&&this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL?this.showActualBlock():this.result.SHOW_AUTH||this.changeVisibleContent(),this.checkNotifications()},fixLocationsStyle:function(e,t){if(e&&t){var i,s,a,r=this.activeSectionId==e.id?e:t;if(i=r.querySelectorAll("div.bx-sls div.dropdown-block.bx-ui-sls-input-block"),s=r.querySelectorAll("div.bx-slst div.dropdown-block.bx-ui-slst-input-block"),i.length)for(a=0;a<i.length;a++)BX.addClass(i[a],"form-control");if(s.length)for(a=0;a<s.length;a++)BX.addClass(s[a],"form-control")}},clickOrderSaveAction:function(e){return this.isValidForm()&&(this.allowOrderSave(),"Y"===this.params.USER_CONSENT&&BX.UserConsent?BX.onCustomEvent("bx-soa-order-save",[]):this.doSaveAction()),BX.PreventDefault(e)},doSaveAction:function(){this.isOrderSaveAllowed()&&(this.reachGoal("order"),this.sendRequest("saveOrderAjax"))},clickNextAction:function(e){var t,i,s,a=e.target||e.srcElement,r=BX.findParent(a,{className:"bx-active"}),o=this.getNextSection(r);return this.reachGoal("next",r),this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"false"!=o.next.getAttribute("data-visited")||(i=o.next.querySelector(".bx-soa-section-title-container"),BX.bind(i,"click",BX.proxy(this.showByClick,this)),(s=o.next.querySelector(".bx-soa-editstep"))&&(s.style.display=""),t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),o.next.id==t[t.length-1].id&&this.switchOrderSaveButtons(!0)),this.fade(r,o.next),this.show(o.next),BX.PreventDefault(e)},clickPrevAction:function(e){var t=e.target||e.srcElement,i=BX.findParent(t,{className:"bx-active"}),s=this.getPrevSection(i);return this.fade(i),this.show(s.next),this.animateScrollTo(s.next,800),BX.PreventDefault(e)},showAuthBlock:function(){var e=this.authBlockNode,t=BX(this.activeSectionId);e&&!BX.hasClass(e,"bx-selected")&&(t&&this.fade(t),this.show(e))},closeAuthBlock:function(){var e=this.authBlockNode,t=this.getNextSection(e).next;this.fade(e),BX.cleanNode(BX(t.id+"-hidden")),this.show(t)},shouldSkipSection:function(e){var t=!1;if("Y"===this.params.SKIP_USELESS_BLOCK){if(e.id===this.pickUpBlockNode.id){var i=this.getSelectedDelivery();i&&(t=1===this.getPickUpInfoArray(i.STORE).length)}e.id===this.deliveryBlockNode.id&&(t=this.result.DELIVERY&&1===this.result.DELIVERY.length&&0===this.result.DELIVERY[0].EXTRA_SERVICES.length&&!this.result.DELIVERY[0].CALCULATE_ERRORS),e.id===this.paySystemBlockNode.id&&(t=this.result.PAY_SYSTEM&&1===this.result.PAY_SYSTEM.length&&"Y"!==this.result.PAY_FROM_ACCOUNT)}return t},getNextSection:function(e,t){if(!this.orderBlockNode||!e)return{};var i,s,a=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(s=0;s<a.length;s++)if(a[s].id===e.id&&a[s+1])return i=a[s+1],this.shouldSkipSection(i)?(this.markSectionAsCompleted(i),this.getNextSection(i,i)):{prev:e,next:i,skip:t};return{next:e}},markSectionAsCompleted:function(e){var t;this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"false"!==e.getAttribute("data-visited")||(this.changeVisibleSection(e,!0),t=e.querySelector(".bx-soa-section-title-container"),BX.bind(t,"click",BX.proxy(this.showByClick,this))),e.setAttribute("data-visited","true"),BX.addClass(e,"bx-step-completed"),BX.remove(e.querySelector(".alert.alert-warning.alert-hide")),this.checkBlockErrors(e)},getPrevSection:function(e){if(!this.orderBlockNode||!e)return{};var t,i,s=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(i=0;i<s.length;i++)if(s[i].id===e.id&&s[i-1])return t=s[i-1],this.shouldSkipSection(t)?(this.markSectionAsCompleted(t),this.getPrevSection(t)):{prev:e,next:t};return{next:e}},addAnimationEffect:function(e,t,i){e&&t&&(this.timeOut[e.id]&&(clearTimeout(this.timeOut[e.id].timer),BX.removeClass(e,this.timeOut[e.id].className)),setTimeout((function(){BX.addClass(e,t)}),10),this.timeOut[e.id]={className:t,timer:setTimeout(BX.delegate((function(){BX.removeClass(e,t),delete this.timeOut[e.id]}),this),i||5e3)})},fade:function(e,t){if(e&&e.id&&this.activeSectionId==e.id){this.hasErrorSection[e.id]=!1;var i,s=e.offsetHeight;switch(e.id){case this.authBlockNode.id:this.authBlockNode.style.display="none",BX.removeClass(this.authBlockNode,"bx-active");break;case this.basketBlockNode.id:this.editFadeBasketBlock();break;case this.regionBlockNode.id:this.editFadeRegionBlock();break;case this.paySystemBlockNode.id:BX.remove(this.paySystemBlockNode.querySelector(".alert.alert-warning.alert-hide")),this.editFadePaySystemBlock();break;case this.deliveryBlockNode.id:BX.remove(this.deliveryBlockNode.querySelector(".alert.alert-warning.alert-hide")),this.editFadeDeliveryBlock();break;case this.pickUpBlockNode.id:this.editFadePickUpBlock();break;case this.propsBlockNode.id:this.editFadePropsBlock()}if(BX.addClass(e,"bx-step-completed"),BX.removeClass(e,"bx-selected"),i=e.offsetHeight,e.style.height=s+"px",t){var a,r,o,l,n,c,p=BX.GetWindowScrollPos().scrollTop,h=BX.pos(this.orderBlockNode),d=BX.pos(e);(n=BX(t.id+"-hidden")).style.left="-10000",n.style.position="absolute",this.orderBlockNode.appendChild(n),o=t.offsetHeight,l=n.offsetHeight+57,BX(e.id+"-hidden").parentNode.appendChild(n),n.removeAttribute("style"),a=i+l-s-o,(c=window.innerHeight-h.height-a)>0?r=h.top-c/2:(r=d.top>p?d.top:d.bottom+6-s+i)+window.innerHeight>h.bottom+25+a&&(r=h.bottom+25+a-window.innerHeight),r-=this.isMobile?50:0}new BX.easing({duration:t?800:600,start:{height:s,scrollTop:p},finish:{height:i,scrollTop:r},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(i){e.style.height=i.height+"px",t&&window.scrollTo(0,i.scrollTop)},complete:function(){e.style.height=""}}).animate(),this.checkBlockErrors(e)}},show:function(e){if(e&&e.id&&this.activeSectionId!=e.id){switch(this.activeSectionId=e.id,BX.removeClass(e,"bx-step-error bx-step-warning"),e.id){case this.authBlockNode.id:this.authBlockNode.style.display="",BX.addClass(this.authBlockNode,"bx-active");break;case this.basketBlockNode.id:this.editActiveBasketBlock(!0),this.alignBasketColumns();break;case this.regionBlockNode.id:this.editActiveRegionBlock(!0);break;case this.deliveryBlockNode.id:this.editActiveDeliveryBlock(!0);break;case this.paySystemBlockNode.id:this.editActivePaySystemBlock(!0);break;case this.pickUpBlockNode.id:this.editActivePickUpBlock(!0);break;case this.propsBlockNode.id:this.editActivePropsBlock(!0)}"false"===e.getAttribute("data-visited")&&(this.showBlockErrors(e),this.notifyAboutWarnings(e)),e.setAttribute("data-visited","true"),BX.addClass(e,"bx-selected"),BX.removeClass(e,"bx-step-completed")}},showByClick:function(e){var t=e.target||e.srcElement,i=BX.findParent(t,{className:"bx-active"}),s=BX(this.activeSectionId),a=BX.GetWindowScrollPos().scrollTop;return!i||BX.hasClass(i,"bx-selected")||(this.reachGoal("edit",i),s&&this.fade(s),this.show(i),setTimeout(BX.delegate((function(){BX.pos(i).top<a&&this.animateScrollTo(i,300)}),this),320)),BX.PreventDefault(e)},showActualBlock:function(){for(var e=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),t=0;e[t];){if(e[t].id===this.regionBlockNode.id&&this.isValidRegionBlock(),e[t].id===this.propsBlockNode.id&&this.isValidPropertiesBlock(),!this.checkBlockErrors(e[t])||!this.checkPreload(e[t])){this.activeSectionId!==e[t].id&&(BX(this.activeSectionId)&&this.fade(BX(this.activeSectionId)),this.show(e[t]));break}BX.addClass(e[t],"bx-step-completed"),e[t].setAttribute("data-visited","true"),t++}},getBlockFooter:function(e){var t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),i=t[0],s=t[t.length-1],a=BX.findParent(e,{className:"bx-soa-section"}),r=!1,o=[];a&&"-1"==a.id.indexOf(i.id)&&o.push(BX.create("A",{props:{href:"javascript:void(0)",className:"pull-left btn btn-default btn-md"},html:this.params.MESS_BACK,events:{click:BX.proxy(this.clickPrevAction,this)}})),a&&"-1"!=a.id.indexOf(s.id)&&(r=!0),r||o.push(BX.create("A",{props:{href:"javascript:void(0)",className:"pull-right btn btn-default btn-md"},html:this.params.MESS_FURTHER,events:{click:BX.proxy(this.clickNextAction,this)}}))},getNewContainer:function(e){return BX.create("DIV",{props:{className:"bx-soa-section-content"+(e?"":" container-fluid")}})},switchOrderSaveButtons:function(e){var t=this.orderSaveBlockNode,i=this.totalBlockNode.querySelector(".bx-soa-cart-total-button-container"),s=this.mobileTotalBlockNode.querySelector(".bx-soa-cart-total-button-container");""==this.orderSaveBlockNode.style.display!=e&&(e?(t.style.opacity=0,t.style.display="",i&&(i.style.opacity=0,i.style.display=""),s&&(s.style.opacity=0,s.style.display=""),new BX.easing({duration:500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.linear,step:function(e){t.style.opacity=e.opacity/100,i&&(i.style.opacity=e.opacity/100),s&&(s.style.opacity=e.opacity/100)},complete:function(){t.removeAttribute("style"),i&&i.removeAttribute("style"),s&&s.removeAttribute("style")}}).animate()):(t.style.display="none",i&&i.setAttribute("style","display: none !important"),s&&s.setAttribute("style","display: none !important")))},shouldBeSectionVisible:function(e,t){var i,s=!1;if(!e||!e.length)return s;for(;t<e.length;t++){if("true"==e[t].getAttribute("data-visited")){s=!0;break}if(!this.firstLoad&&(i=e[t].querySelector(".bx-soa-editstep"))&&"none"!==i.style.display){s=!0;break}}return s},changeVisibleContent:function(){var e,t,i=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),s=!!this.result.IS_AUTHORIZED&&"Y"===this.params.USE_PRELOAD&&!0!==this.result.LAST_ORDER_DATA.FAIL,a=!0;for(e=0;e<i.length;e++)t=(t=this.firstLoad&&s)||this.shouldBeSectionVisible(i,e),this.changeVisibleSection(i[e],t),this.firstLoad&&a&&(t&&i[e+1]&&this.checkBlockErrors(i[e])&&(s&&this.checkPreload(i[e])||!s&&this.shouldSkipSection(i[e]))?(this.fade(i[e]),this.markSectionAsCompleted(i[e]),this.show(i[e+1])):a=!1);this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"final_step"!==this.params.SHOW_ORDER_BUTTON||this.switchOrderSaveButtons(this.shouldBeSectionVisible(i,i.length-1))},changeVisibleSection:function(e,t){var i,s,a;e.id!==this.basketBlockNode.id&&(s=e.querySelector(".bx-soa-section-content"))&&(s.style.display=t?"":"none"),(a=e.querySelector(".bx-soa-editstep"))&&(a.style.display=t?"":"none"),(i=e.querySelector(".bx-soa-section-title-container"))&&!t&&BX.unbindAll(i)},clearHiddenBlocks:function(){BX.remove(BX.lastChild(this.authHiddenBlockNode)),BX.remove(BX.lastChild(this.basketHiddenBlockNode)),BX.remove(BX.lastChild(this.regionHiddenBlockNode)),BX.remove(BX.lastChild(this.paySystemHiddenBlockNode)),BX.remove(BX.lastChild(this.deliveryHiddenBlockNode)),BX.remove(BX.lastChild(this.pickUpHiddenBlockNode)),BX.remove(BX.lastChild(this.propsHiddenBlockNode))},editOrder:function(){if(this.orderBlockNode&&this.result){this.result.DELIVERY.length>0?(BX.addClass(this.deliveryBlockNode,"bx-active"),this.deliveryBlockNode.removeAttribute("style")):(BX.removeClass(this.deliveryBlockNode,"bx-active"),this.deliveryBlockNode.style.display="none"),this.orderSaveBlockNode.style.display=this.result.SHOW_AUTH?"none":"",this.mobileTotalBlockNode.style.display=this.result.SHOW_AUTH?"none":"",this.checkPickUpShow();var e=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(t in e)e.hasOwnProperty(t)&&this.editSection(e[t]);var t,i=this.orderBlockNode.querySelectorAll(".bx-soa-editstep");for(t in i)i.hasOwnProperty(t)&&BX.remove(i[t]);this.editTotalBlock(),this.totalBlockFixFont(),this.showErrors(this.result.ERROR,!1),this.showWarnings()}},editSection:function(e){if(e&&e.id){this.result.SHOW_AUTH&&e.id!=this.authBlockNode.id&&e.id!=this.basketBlockNode.id?e.style.display="none":e.id!=this.pickUpBlockNode.id&&(e.style.display="");var t,i=!0,s=e.querySelector(".bx-soa-section-title-container");switch(BX.unbindAll(s),t=e.querySelector(".alert.alert-danger"),this.hasErrorSection[e.id]=t&&"none"!=t.style.display,e.id){case this.authBlockNode.id:this.editAuthBlock();break;case this.basketBlockNode.id:this.editBasketBlock(i);break;case this.regionBlockNode.id:this.editRegionBlock(i);break;case this.paySystemBlockNode.id:this.editPaySystemBlock(i);break;case this.deliveryBlockNode.id:this.editDeliveryBlock(i);break;case this.pickUpBlockNode.id:this.editPickUpBlock(i);break;case this.propsBlockNode.id:this.editPropsBlock(i)}e.setAttribute("data-visited","true")}},editAuthBlock:function(){if(this.authBlockNode){var e,t,i=this.authBlockNode.querySelector(".bx-soa-section-content");BX.hasClass(i,"reg")?(e=i,i=BX.firstChild(this.authHiddenBlockNode)):e=BX.firstChild(this.authHiddenBlockNode),BX.cleanNode(i),BX.cleanNode(e),this.result.SHOW_AUTH?(this.getErrorContainer(i),this.editAuthorizeForm(i),this.editSocialContent(i),this.getAuthReference(i),this.getErrorContainer(e),this.editRegistrationForm(e),this.getAuthReference(e)):(BX.onCustomEvent("OnBasketChange"),this.closeAuthBlock()),this.result.OK_MESSAGE&&this.result.OK_MESSAGE.length&&(this.toggleAuthForm({target:this.authBlockNode.querySelector("input[type=submit]")}),t=BX.create("DIV",{props:{className:"alert alert-success"},text:this.result.OK_MESSAGE.join()}),this.result.OK_MESSAGE="",BX.prepend(t,this.authBlockNode.querySelector(".bx-soa-section-content")))}},editAuthorizeForm:function(e){var t,i,s,a,r;t=this.createAuthFormInputContainer(BX.message("STOF_LOGIN"),BX.create("INPUT",{attrs:{"data-next":"USER_PASSWORD"},props:{name:"USER_LOGIN",type:"text",value:this.result.AUTH.USER_LOGIN,maxlength:"30"},events:{keypress:BX.proxy(this.checkKeyPress,this)}})),i=this.createAuthFormInputContainer(BX.message("STOF_PASSWORD"),BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"USER_PASSWORD",type:"password",value:"",maxlength:"30"},events:{keypress:BX.proxy(this.checkKeyPress,this)}})),s=BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"checkbox"},children:[BX.create("LABEL",{props:{className:"bx-filter-param-label"},children:[BX.create("INPUT",{props:{type:"checkbox",name:"USER_REMEMBER",value:"Y"}}),BX.create("SPAN",{props:{className:"bx-filter-param-text"},text:BX.message("STOF_REMEMBER")})]})]})]}),a=BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{id:"do_authorize",type:"hidden",name:"do_authorize",value:"N"}}),BX.create("INPUT",{props:{type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_ENTER")},events:{click:BX.delegate((function(e){return BX("do_authorize").value="Y",this.sendRequest("showAuthForm"),BX.PreventDefault(e)}),this)}})]}),r=BX.create("DIV",{props:{className:"bx-authform"},children:[BX.create("H3",{props:{className:"bx-title"},text:BX.message("STOF_AUTH_REQUEST")}),t,i,s,a,BX.create("A",{props:{href:this.params.PATH_TO_AUTH+"?forgot_password=yes&back_url="+encodeURIComponent(document.location.href)},text:BX.message("STOF_FORGET_PASSWORD")})]}),e.appendChild(BX.create("DIV",{props:{className:"col-md-6"},children:[r]}))},createAuthFormInputContainer:function(e,t,i){var s="";return i&&(s+='<span class="bx-authform-starrequired">*</span>'),s+=e,BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"bx-authform-label-container"},html:s}),BX.create("DIV",{props:{className:"bx-authform-input-container"},children:[t]})]})},activatePhoneAuth:function(){this.result.SMS_AUTH&&new BX.PhoneAuth({containerId:"bx_register_resend",errorContainerId:"bx_register_error",interval:60,data:{signedData:this.result.SMS_AUTH.SIGNED_DATA},onError:function(e){var t=BX("bx_register_error"),i=BX.findChildByClassName(t,"errortext");i.innerHTML="";for(var s=0;s<e.errors.length;s++)i.innerHTML=i.innerHTML+BX.util.htmlspecialchars(e.errors[s].message)+"<br>";t.style.display=""}})},editRegistrationForm:function(e){if(this.result.AUTH){var t=[],i=this.result.SMS_AUTH&&"OK"===this.result.SMS_AUTH.TYPE;i?(t.push(BX.create("DIV",{props:{className:"alert alert-success"},text:BX.message("STOF_REG_SMS_REQUEST")})),t.push(BX.create("INPUT",{props:{type:"hidden",name:"SIGNED_DATA",value:this.result.SMS_AUTH.SIGNED_DATA||""}})),t.push(this.createAuthFormInputContainer(BX.message("STOF_SMS_CODE"),BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"SMS_CODE",type:"text",size:40,value:""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{name:"code_submit_button",type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_SEND")},events:{click:BX.delegate((function(e){return this.sendRequest("confirmSmsCode"),BX.PreventDefault(e)}),this)}})]})),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{id:"bx_register_error"},style:{display:"none"}}),BX.create("DIV",{props:{id:"bx_register_resend"}})]}))):(t.push(BX.create("H3",{props:{className:"bx-title"},text:BX.message("STOF_REG_REQUEST")})),t.push(this.createAuthFormInputContainer(BX.message("STOF_NAME"),BX.create("INPUT",{attrs:{"data-next":"NEW_LAST_NAME"},props:{name:"NEW_NAME",type:"text",size:40,value:this.result.AUTH.NEW_NAME||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(this.createAuthFormInputContainer(BX.message("STOF_LASTNAME"),BX.create("INPUT",{attrs:{"data-next":"NEW_EMAIL"},props:{name:"NEW_LAST_NAME",type:"text",size:40,value:this.result.AUTH.NEW_LAST_NAME||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(this.createAuthFormInputContainer(BX.message("STOF_EMAIL"),BX.create("INPUT",{attrs:{"data-next":"PHONE_NUMBER"},props:{name:"NEW_EMAIL",type:"text",size:40,value:this.result.AUTH.NEW_EMAIL||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),"Y"==this.result.AUTH.new_user_email_required)),"Y"===this.result.AUTH.new_user_phone_auth&&t.push(this.createAuthFormInputContainer(BX.message("STOF_PHONE"),BX.create("INPUT",{attrs:{"data-next":"captcha_word"},props:{name:"PHONE_NUMBER",type:"text",size:40,value:this.result.AUTH.PHONE_NUMBER||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),"Y"===this.result.AUTH.new_user_phone_required)),this.authGenerateUser&&(t.push(BX.create("LABEL",{props:{for:"NEW_GENERATE_N"},children:[BX.create("INPUT",{attrs:{checked:!this.authGenerateUser},props:{id:"NEW_GENERATE_N",type:"radio",name:"NEW_GENERATE",value:"N"}}),BX.message("STOF_MY_PASSWORD")],events:{change:BX.delegate((function(){this.authBlockNode.querySelector(".generated").style.display="",this.authGenerateUser=!1}),this)}})),t.push(BX.create("BR")),t.push(BX.create("LABEL",{props:{for:"NEW_GENERATE_Y"},children:[BX.create("INPUT",{attrs:{checked:this.authGenerateUser},props:{id:"NEW_GENERATE_Y",type:"radio",name:"NEW_GENERATE",value:"Y"}}),BX.message("STOF_SYS_PASSWORD")],events:{change:BX.delegate((function(){this.authBlockNode.querySelector(".generated").style.display="none",this.authGenerateUser=!0}),this)}}))),t.push(BX.create("DIV",{props:{className:"generated"},style:{display:this.authGenerateUser?"none":""},children:[this.createAuthFormInputContainer(BX.message("STOF_LOGIN"),BX.create("INPUT",{props:{name:"NEW_LOGIN",type:"text",size:30,value:this.result.AUTH.NEW_LOGIN||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0),this.createAuthFormInputContainer(BX.message("STOF_PASSWORD"),BX.create("INPUT",{props:{name:"NEW_PASSWORD",type:"password",size:30},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0),this.createAuthFormInputContainer(BX.message("STOF_RE_PASSWORD"),BX.create("INPUT",{props:{name:"NEW_PASSWORD_CONFIRM",type:"password",size:30},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)]})),"Y"==this.result.AUTH.captcha_registration&&t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"bx-authform-label-container"},children:[BX.create("SPAN",{props:{className:"bx-authform-starrequired"},text:"*"}),BX.message("CAPTCHA_REGF_PROMT"),BX.create("DIV",{props:{className:"bx-captcha"},children:[BX.create("INPUT",{props:{name:"captcha_sid",type:"hidden",value:this.result.AUTH.capCode||""}}),BX.create("IMG",{props:{src:"/bitrix/tools/captcha.php?captcha_sid="+this.result.AUTH.capCode,alt:""}})]})]}),BX.create("DIV",{props:{className:"bx-authform-input-container"},children:[BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"captcha_word",type:"text",size:"30",maxlength:"50",value:""},events:{keypress:BX.proxy(this.checkKeyPress,this)}})]})]})),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{id:"do_register",name:"do_register",type:"hidden",value:"N"}}),BX.create("INPUT",{props:{type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_REGISTER")},events:{click:BX.delegate((function(e){return BX("do_register").value="Y",this.sendRequest("showAuthForm"),BX.PreventDefault(e)}),this)}}),BX.create("A",{props:{className:"btn btn-link",href:""},text:BX.message("STOF_DO_AUTHORIZE"),events:{click:BX.delegate((function(e){return this.toggleAuthForm(e),BX.PreventDefault(e)}),this)}})]}))),e.appendChild(BX.create("DIV",{props:{className:"col-md-12"},children:[BX.create("DIV",{props:{className:"bx-authform"},children:t})]})),i&&this.activatePhoneAuth()}},editSocialContent:function(e){if(BX("bx-soa-soc-auth-services")){var t=[];if(!1===this.socServiceHiddenNode){var i=BX("bx-soa-soc-auth-services").querySelector(".bx-authform-social");BX.type.isDomNode(i)&&(this.socServiceHiddenNode=i.innerHTML,BX.remove(i))}this.socServiceHiddenNode&&(t.push(BX.create("DIV",{props:{className:"bx-authform-social"},html:'<h3 class="bx-title">'+BX.message("SOA_DO_SOC_SERV")+"</h3>"+this.socServiceHiddenNode})),t.push(BX.create("hr",{props:{className:"bxe-light"}}))),"Y"===this.result.AUTH.new_user_registration&&t.push(BX.create("DIV",{props:{className:"bx-soa-reg-block"},children:[BX.create("P",{html:this.params.MESS_REGISTRATION_REFERENCE}),BX.create("A",{props:{className:"btn btn-default btn-lg"},text:BX.message("STOF_DO_REGISTER"),events:{click:BX.delegate((function(e){return this.toggleAuthForm(e),BX.PreventDefault(e)}),this)}})]})),e.appendChild(BX.create("DIV",{props:{className:"col-md-6"},children:t}))}},getAuthReference:function(e){e.appendChild(BX.create("DIV",{props:{className:"row"},children:[BX.create("DIV",{props:{className:"bx-soa-reference col-xs-12"},children:[this.params.MESS_AUTH_REFERENCE_1,BX.create("BR"),this.params.MESS_AUTH_REFERENCE_2,BX.create("BR"),this.params.MESS_AUTH_REFERENCE_3]})]}))},toggleAuthForm:function(e){if(e){var t=e.target||e.srcElement,i=BX.findParent(t,{className:"bx-soa-section"}),s=BX.findParent(t,{className:"bx-soa-section-content"}),a=BX.firstChild(this.authHiddenBlockNode);new BX.easing({duration:100,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.opacity=e.opacity/100}}).animate(),this.authHiddenBlockNode.appendChild(s),BX.cleanNode(i),i.appendChild(BX.create("DIV",{props:{className:"bx-soa-section-title-container"},children:[BX.create("h2",{props:{className:"bx-soa-section-title col-xs-7 col-sm-9"},html:BX.hasClass(a,"reg")?this.params.MESS_REG_BLOCK_NAME:this.params.MESS_AUTH_BLOCK_NAME})]})),a.style.opacity=0,i.appendChild(a),setTimeout((function(){new BX.easing({duration:100,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){a.style.opacity=e.opacity/100},complete:function(){a.style.height="",a.style.opacity=""}}).animate()}),110),this.animateScrollTo(i)}},alignBasketColumns:function(){if(this.basketBlockNode){var e,t,i,s,a=0,r=0,o=BX.GetWindowInnerSize();if(o.innerWidth>580&&o.innerWidth<992){if(s=100,(i=this.basketBlockNode.querySelectorAll(".bx-soa-basket-info")).length){if((t=i[0].querySelectorAll(".bx-soa-item-properties")).length&&""!=t[0].style.width)return;if((r=t.length)>0)for(r=r>4?4:r,s=parseInt(s/r);a<i.length;a++)for(t=i[a].querySelectorAll(".bx-soa-item-properties"),e=0;e<t.length;e++)t[e].style.width=s+"%"}}else{if((t=this.basketBlockNode.querySelectorAll(".bx-soa-item-properties")).length&&""==t[0].style.width)return;for(;a<t.length;a++)t[a].style.width=""}}},editBasketBlock:function(e){this.basketBlockNode&&this.basketHiddenBlockNode&&this.result.GRID&&(BX.remove(BX.lastChild(this.basketBlockNode)),BX.remove(BX.lastChild(this.basketHiddenBlockNode)),this.editActiveBasketBlock(e),this.editFadeBasketBlock(e),this.initialized.basket=!0)},editActiveBasketBlock:function(e){var t,i,s=e?this.basketBlockNode:this.basketHiddenBlockNode;this.initialized.basket?(this.basketHiddenBlockNode.appendChild(BX.lastChild(s)),s.appendChild(BX.firstChild(this.basketHiddenBlockNode))):(t=s.querySelector(".bx-soa-section-content"),i=BX.create("DIV",{props:{className:"bx-soa-item-table"}}),t?BX.cleanNode(t):(t=this.getNewContainer(),s.appendChild(t)),this.editBasketItems(i,!0),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-table-fade"},children:[BX.create("DIV",{style:{overflowX:"auto",overflowY:"hidden"},children:[i]})]})),"Y"===this.params.SHOW_COUPONS_BASKET&&this.editCoupons(t),this.getBlockFooter(t),BX.bind(t.querySelector("div.bx-soa-table-fade").firstChild,"scroll",BX.proxy(this.basketBlockScrollCheckEvent,this))),this.alignBasketColumns()},editFadeBasketBlock:function(e){var t,i,s=e?this.basketHiddenBlockNode:this.basketBlockNode;this.initialized.basket?(this.basketHiddenBlockNode.appendChild(s.querySelector(".bx-soa-section-content")),this.basketBlockNode.appendChild(BX.firstChild(this.basketHiddenBlockNode))):(t=this.getNewContainer(),i=BX.create("DIV",{props:{className:"bx-soa-item-table"}}),this.editBasketItems(i,!1),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-table-fade"},children:[BX.create("DIV",{style:{overflowX:"auto",overflowY:"hidden"},children:[i]})]})),"Y"===this.params.SHOW_COUPONS_BASKET&&this.editCouponsFade(t),s.appendChild(t),this.alignBasketColumns(),this.basketBlockScrollCheck(),BX.bind(this.basketBlockNode.querySelector("div.bx-soa-table-fade").firstChild,"scroll",BX.proxy(this.basketBlockScrollCheckEvent,this))),this.alignBasketColumns()},editBasketItems:function(e,t){if(this.result.GRID.ROWS){var i,s=0;for(i in"Y"===this.params.SHOW_BASKET_HEADERS&&this.editBasketItemsHeader(e),this.result.GRID.ROWS)this.result.GRID.ROWS.hasOwnProperty(i)&&this.createBasketItem(e,this.result.GRID.ROWS[i],s++,!!t)}},editBasketItemsHeader:function(e){if(e){var t,i,s=[BX.create("DIV",{props:{className:"bx-soa-item-td"},style:{paddingBottom:"5px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title"},text:BX.message("SOA_SUM_NAME")})]})],a=!1,r=0;for(i=0;i<this.result.GRID.HEADERS.length;i++)"NAME"!==(t=this.result.GRID.HEADERS[i]).id&&"PREVIEW_PICTURE"!==t.id&&"PROPS"!==t.id&&"NOTES"!==t.id&&("DETAIL_PICTURE"!==t.id||this.options.showPreviewPicInBasket)&&(a=BX.util.in_array(t.id,["QUANTITY","PRICE_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED","SUM"]),s.push(BX.create("DIV",{props:{className:"bx-soa-item-td bx-soa-item-properties"+(a?" bx-text-right":"")},style:{paddingBottom:"5px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title"},text:t.name})]})),4==++r&&this.result.GRID.HEADERS[i+1]&&(s.push(BX.create("DIV",{props:{className:"bx-soa-item-nth-4p1"}})),r=0));e.appendChild(BX.create("DIV",{props:{className:"bx-soa-item-tr hidden-sm hidden-xs"},children:s}))}},createBasketItem:function(e,t,i,s){var a,r,o,l,n=[],c=[],p=[],h=0;for((this.options.showPreviewPicInBasket||this.options.showDetailPicInBasket)&&n.push(this.createBasketItemImg(t.data)),n.push(this.createBasketItemContent(t.data)),r=0;r<this.result.GRID.HEADERS.length;r++)"NAME"!==(a=this.result.GRID.HEADERS[r]).id&&"PREVIEW_PICTURE"!==a.id&&"PROPS"!==a.id&&"NOTES"!==a.id&&("DETAIL_PICTURE"!==a.id||this.options.showPreviewPicInBasket)&&(c.push(this.createBasketItemColumn(a,t,s)),4==++h&&this.result.GRID.HEADERS[r+1]&&(c.push(BX.create("DIV",{props:{className:"bx-soa-item-nth-4p1"}})),h=0));if(s)for(r=0;r<this.result.GRID.HEADERS_HIDDEN.length;r++)o=this.createBasketItemHiddenColumn(this.result.GRID.HEADERS_HIDDEN[r],t),BX.type.isArray(o)?p=p.concat(o):o&&p.push(o);l=[BX.create("DIV",{props:{className:"bx-soa-item-td"},style:{minWidth:"300px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-block"},children:n})]})].concat(c),e.appendChild(BX.create("DIV",{props:{className:"bx-soa-item-tr bx-soa-basket-info"+(0==i?" bx-soa-item-tr-first":"")},children:l})),p.length&&e.appendChild(BX.create("DIV",{props:{className:"bx-soa-item-tr bx-soa-item-info-container"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td"},children:[BX.create("A",{props:{href:"",className:"bx-soa-info-shower"},html:this.params.MESS_ADDITIONAL_PROPS,events:{click:BX.proxy(this.showAdditionalProperties,this)}}),BX.create("DIV",{props:{className:"bx-soa-item-info-block"},children:[BX.create("TABLE",{props:{className:"bx-soa-info-block"},children:p})]})]})]}))},showAdditionalProperties:function(e){var t=e.target||e.srcElement,i=t.nextSibling,s=BX.findParent(t,{className:"bx-soa-item-tr bx-soa-item-info-container"}),a=s.offsetHeight;if(BX.hasClass(i,"bx-active"))new BX.easing({duration:300,start:{opacity:100,height:a},finish:{opacity:0,height:35},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100,i.style.height=e.height+"px",s.style.height=e.height+"px"},complete:function(){BX.removeClass(i,"bx-active"),i.removeAttribute("style"),s.removeAttribute("style")}}).animate();else{i.style.opacity=0,BX.addClass(i,"bx-active");var r=i.offsetHeight+a;BX.removeClass(i,"bx-active"),i.style.paddingTop="10px",new BX.easing({duration:300,start:{opacity:0,height:a},finish:{opacity:100,height:r},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100,i.style.height=e.height+"px",s.style.height=e.height+"px"},complete:function(){BX.addClass(i,"bx-active"),i.removeAttribute("style")}}).animate()}return BX.PreventDefault(e)},createBasketItemImg:function(e){var t,i;if(e)return t=BX.create("DIV",{props:{className:"bx-soa-item-imgcontainer"}}),e.PREVIEW_PICTURE_SRC&&e.PREVIEW_PICTURE_SRC.length?i=this.getImageSources(e,"PREVIEW_PICTURE"):e.DETAIL_PICTURE_SRC&&e.DETAIL_PICTURE_SRC.length&&(i=this.getImageSources(e,"DETAIL_PICTURE")),i&&i.src_2x?t.setAttribute("style",'background-image: url("'+i.src_1x+'");background-image: -webkit-image-set(url("'+i.src_1x+'") 1x, url("'+i.src_2x+'") 2x)'):(i=i&&i.src_1x||this.defaultBasketItemLogo,t.setAttribute("style",'background-image: url("'+i+'");')),"Y"!==this.params.HIDE_DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL.length&&(t=BX.create("A",{props:{href:e.DETAIL_PAGE_URL},children:[t]})),BX.create("DIV",{props:{className:"bx-soa-item-img-block"},children:[t]})},createBasketItemContent:function(e){var t=e.NAME||"",i=this.htmlspecialcharsEx(t),s=e.PROPS||[],a=[];if("Y"!==this.params.HIDE_DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL.length&&(i='<a href="'+e.DETAIL_PAGE_URL+'">'+i+"</a>"),this.options.showPropsInBasket&&s.length)for(var r in s)if(s.hasOwnProperty(r)){var o=s[r].NAME||"",l=s[r].VALUE||"";a.push(BX.create("DIV",{props:{className:"bx-soa-item-td-title"},style:{textAlign:"left"},text:o})),a.push(BX.create("DIV",{props:{className:"bx-soa-item-td-text"},style:{textAlign:"left"},text:l}))}return BX.create("DIV",{props:{className:"bx-soa-item-content"},children:a.length?[BX.create("DIV",{props:{className:"bx-soa-item-title"},html:i}),BX.create("DIV",{props:{className:"bx-scu-container"},children:a})]:[BX.create("DIV",{props:{className:"bx-soa-item-title"},html:i})]})},createBasketItemColumn:function(e,t,i){if(e&&t){var s,a,r=t.columns[e.id]?t.columns:t.data,o=BX.util.in_array(e.id,["QUANTITY","PRICE_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED","SUM"]),l=BX.create("DIV",{props:{className:"bx-soa-item-td-text"}});if("PRICE_FORMATED"===e.id)l.appendChild(BX.create("STRONG",{props:{className:"bx-price"},html:r.PRICE_FORMATED})),parseFloat(r.DISCOUNT_PRICE)>0&&(l.appendChild(BX.create("BR")),l.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:r.BASE_PRICE_FORMATED}))),this.options.showPriceNotesInBasket&&i&&(l.appendChild(BX.create("BR")),l.appendChild(BX.create("SMALL",{text:r.NOTES})));else if("SUM"===e.id)l.appendChild(BX.create("STRONG",{props:{className:"bx-price all"},html:r.SUM})),parseFloat(r.DISCOUNT_PRICE)>0&&(l.appendChild(BX.create("BR")),l.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:r.SUM_BASE_FORMATED})));else if("DISCOUNT"===e.id)l.appendChild(BX.create("STRONG",{props:{className:"bx-price"},text:r.DISCOUNT_PRICE_PERCENT_FORMATED}));else if("DETAIL_PICTURE"===e.id)s=this.getImageSources(t.data,e.id),a=BX.create("IMG",{props:{src:s&&s.src_1x||this.defaultBasketItemLogo}}),s&&s.src_1x&&s.src_orig&&BX.bind(a,"click",BX.delegate((function(e){this.popupShow(e,s.src_orig)}),this)),l.appendChild(a);else if(BX.util.in_array(e.id,["QUANTITY","WEIGHT_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED"]))l.appendChild(BX.create("SPAN",{html:r[e.id]}));else if("PREVIEW_TEXT"===e.id)"html"===r.PREVIEW_TEXT_TYPE?l.appendChild(BX.create("SPAN",{html:r.PREVIEW_TEXT||""})):l.appendChild(BX.create("SPAN",{text:r.PREVIEW_TEXT||""}));else{var n=r[e.id],c=[];if(BX.type.isArray(n)){for(var p in n)n.hasOwnProperty(p)&&("image"==n[p].type?c.push(this.getImageContainer(n[p].value,n[p].source)):"linked"==n[p].type?(l.appendChild(BX.create("SPAN",{html:n[p].value_format})),l.appendChild(BX.create("BR"))):n[p].value&&(l.appendChild(BX.create("SPAN",{html:n[p].value})),l.appendChild(BX.create("BR"))));c.length&&l.appendChild(BX.create("DIV",{props:{className:"bx-scu-list"},children:[BX.create("UL",{props:{className:"bx-scu-itemlist"},children:c})]}))}else n&&l.appendChild(BX.create("SPAN",{html:BX.util.htmlspecialchars(n)}))}return BX.create("DIV",{props:{className:"bx-soa-item-td bx-soa-item-properties"+(o?" bx-text-right":"")},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title visible-xs visible-sm"},text:e.name}),l]})}},createBasketItemHiddenColumn:function(e,t){if(e&&t){var i,s,a,r=t.columns[e.id]?t.columns:t.data,o=BX.create("TD",{props:{className:"bx-soa-info-text"}});if("PROPS"!==e.id){if("PRICE_FORMATED"===e.id)o.appendChild(BX.create("STRONG",{props:{className:"bx-price"},html:r.PRICE_FORMATED})),parseFloat(r.DISCOUNT_PRICE)>0&&(o.appendChild(BX.create("BR")),o.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:r.BASE_PRICE_FORMATED})));else if("SUM"===e.id)o.appendChild(BX.create("STRONG",{props:{className:"bx-price all"},text:r.SUM}));else if("DISCOUNT"===e.id)o.appendChild(BX.create("STRONG",{props:{className:"bx-price"},text:r.DISCOUNT_PRICE_PERCENT_FORMATED}));else if("DETAIL_PICTURE"===e.id||"PREVIEW_PICTURE"===e.id)i=this.getImageSources(t.data,e.id),s=BX.create("IMG",{props:{src:i&&i.src_1x||this.defaultBasketItemLogo},style:{maxWidth:"50%"}}),i&&i.src_1x&&i.src_orig&&BX.bind(s,"click",BX.delegate((function(e){this.popupShow(e,i.src_orig)}),this)),o.appendChild(s);else if(BX.util.in_array(e.id,["QUANTITY","WEIGHT_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED"]))o.appendChild(BX.create("SPAN",{html:r[e.id]}));else if("PREVIEW_TEXT"===e.id)"html"===r.PREVIEW_TEXT_TYPE?o.appendChild(BX.create("SPAN",{html:r.PREVIEW_TEXT||""})):o.appendChild(BX.create("SPAN",{text:r.PREVIEW_TEXT||""}));else{var l=r[e.id],n=[];if(BX.type.isArray(l)){for(a in l)if(l.hasOwnProperty(a))if("image"==l[a].type)n.push(this.getImageContainer(l[a].value,l[a].source));else if("linked"==l[a].type)o.appendChild(BX.create("SPAN",{html:l[a].value_format})),o.appendChild(BX.create("BR"));else{if(!l[a].value)return;o.appendChild(BX.create("SPAN",{html:l[a].value})),o.appendChild(BX.create("BR"))}n.length&&o.appendChild(BX.create("DIV",{props:{className:"bx-scu-list"},children:[BX.create("UL",{props:{className:"bx-scu-itemlist"},children:n})]}))}else{if(!l)return;o.appendChild(BX.create("SPAN",{html:BX.util.htmlspecialchars(l)}))}}return BX.create("TR",{props:{className:"bx-soa-info-line"},children:[BX.create("TD",{props:{className:"bx-soa-info-title"},text:e.name+":"}),o]})}var c=[],p=t.data.PROPS;if(p&&p.length){for(a in p)if(p.hasOwnProperty(a)){var h=p[a].NAME||"",d=p[a].VALUE||"";if(0==d.length)continue;c.push(BX.create("TR",{props:{className:"bx-soa-info-line"},children:[BX.create("TD",{props:{className:"bx-soa-info-title"},text:h+":"}),BX.create("TD",{props:{className:"bx-soa-info-text"},html:BX.util.htmlspecialchars(d)})]}))}return c}}},popupShow:function(e,t,i){this.popup&&this.popup.destroy();var s=this;this.popup=new BX.PopupWindow("bx-soa-image-popup",null,{lightShadow:!0,offsetTop:0,offsetLeft:0,closeIcon:{top:"3px",right:"10px"},autoHide:!0,bindOptions:{position:"bottom"},closeByEsc:!0,zIndex:100,events:{onPopupShow:function(){BX.create("IMG",{props:{src:i||t},events:{load:function(){var e=BX("bx-soa-image-popup-content");if(e){var t,i,a=BX.GetWindowInnerSize(),r=this.isMobile?.5:.9;BX.cleanNode(e),e.appendChild(this),t=e.offsetHeight,i=e.offsetWidth,t>a.innerHeight*r&&(e.style.height=a.innerHeight*r+"px",e.style.width=i*(a.innerHeight*r/t)+"px",t=e.offsetHeight,i=e.offsetWidth),i>a.innerWidth*r&&(e.style.width=a.innerWidth*r+"px",e.style.height=t*(a.innerWidth*r/i)+"px"),e.style.height=e.offsetHeight+"px",e.style.width=e.offsetWidth+"px",s.popup.adjustPosition()}}}})},onPopupClose:function(){this.destroy()}},content:BX.create("DIV",{props:{id:"bx-soa-image-popup-content"},children:[BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})]})}),this.popup.show()},getImageContainer:function(e,t){return BX.create("LI",{props:{className:"bx-img-item"},children:[BX.create("DIV",{props:{className:"bx-scu-itemColorBlock"},children:[BX.create("DIV",{props:{className:"bx-img-itemColor"},style:{backgroundImage:'url("'+e+'")'}})],events:{click:BX.delegate((function(i){this.popupShow(i,e,t)}),this)}})]})},editCoupons:function(e){var t=this.getCouponsList(!0),i=this.getCouponsLabel(!0),s=BX.create("DIV",{props:{className:"bx-soa-coupon-block"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-input"},children:[BX.create("INPUT",{props:{className:"form-control bx-ios-fix",type:"text"},events:{change:BX.delegate((function(e){var t=BX.getEventTarget(e);t&&t.value&&(this.sendRequest("enterCoupon",t.value),t.value="")}),this)}})]}),BX.create("SPAN",{props:{className:"bx-soa-coupon-item"},children:t})]});e.appendChild(BX.create("DIV",{props:{className:"bx-soa-coupon"},children:[i,s]}))},editCouponsFade:function(e){if(!(this.result.COUPON_LIST.length<1)){var t,i,s=this.getCouponsList(!1);s.length&&(t=this.getCouponsLabel(!1),i=BX.create("DIV",{props:{className:"bx-soa-coupon-block"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-list"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-item"},children:[t].concat(s)})]})]}),e.appendChild(BX.create("DIV",{props:{className:"bx-soa-coupon bx-soa-coupon-item-fixed"},children:[i]})))}},getCouponsList:function(e){var t,i=[];for(t=0;t<this.result.COUPON_LIST.length;t++)(e||!e&&"APPLIED"==this.result.COUPON_LIST[t].JS_STATUS)&&i.push(this.getCouponNode({text:this.result.COUPON_LIST[t].COUPON,desc:this.result.COUPON_LIST[t].JS_CHECK_CODE,status:this.result.COUPON_LIST[t].JS_STATUS},e));return i},getCouponNode:function(e,t){var i,s,a=BX.util.htmlspecialchars(e.text)||"",r=e.desc&&e.desc.length?e.desc.charAt(0).toUpperCase()+e.desc.slice(1):BX.message("SOA_NOT_FOUND");switch((e.status||"BAD").toUpperCase()){case"ENTERED":i="used",s="warning";break;case"BAD":i=s="danger";break;default:i=s="success"}return BX.create("STRONG",{attrs:{"data-coupon":a,className:"bx-soa-coupon-item-"+i},children:t?[a||"",BX.create("SPAN",{props:{className:"bx-soa-coupon-remove"},events:{click:BX.delegate((function(e){var t=e.target||e.srcElement,i=BX.findParent(t,{tagName:"STRONG"});i&&i.getAttribute("data-coupon")&&this.sendRequest("removeCoupon",i.getAttribute("data-coupon"))}),this)}}),BX.create("SPAN",{props:{className:"bx-soa-tooltip bx-soa-tooltip-coupon bx-soa-tooltip-"+s+" tooltip top"},children:[BX.create("SPAN",{props:{className:"tooltip-arrow"}}),BX.create("SPAN",{props:{className:"tooltip-inner"},text:r})]})]:[a]})},getCouponsLabel:function(e){return BX.create("DIV",{props:{className:"bx-soa-coupon-label"},children:e?[BX.create("LABEL",{html:this.params.MESS_USE_COUPON+":"})]:[this.params.MESS_COUPON+":"]})},addCoupon:function(e){for(var t=this.orderBlockNode.querySelectorAll(".bx-soa-coupon:not(.bx-soa-coupon-item-fixed) .bx-soa-coupon-item"),i=0;i<t.length&&!t[i].querySelector('[data-coupon="'+BX.util.htmlspecialchars(e)+'"]');i++)t[i].appendChild(this.getCouponNode({text:e},!0,"bx-soa-coupon-item-danger"))},removeCoupon:function(e){var t,i=this.orderBlockNode.querySelectorAll('[data-coupon="'+BX.util.htmlspecialchars(e)+'"]');for(t in i)i.hasOwnProperty(t)&&BX.remove(i[t])},editRegionBlock:function(e){this.regionBlockNode&&this.regionHiddenBlockNode&&this.result.PERSON_TYPE&&(e?(this.editActiveRegionBlock(!0),!this.regionBlockNotEmpty&&this.editFadeRegionBlock()):this.editFadeRegionBlock(),this.initialized.region=!0)},editActiveRegionBlock:function(e){var t,i,s,a=e?this.regionBlockNode:this.regionHiddenBlockNode;this.initialized.region?(BX.remove(BX.lastChild(a)),a.appendChild(BX.firstChild(this.regionHiddenBlockNode))):((t=a.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),a.appendChild(t)),this.getErrorContainer(t),i=BX.create("DIV",{props:{className:"bx_soa_location row"}}),s=BX.create("DIV",{props:{className:"col-xs-12"}}),this.getPersonTypeControl(s),this.getProfilesControl(s),this.getDeliveryLocationInput(s),this.result.SHOW_AUTH||(this.regionBlockNotEmpty?(BX.addClass(this.regionBlockNode,"bx-active"),this.regionBlockNode.style.display=""):(BX.removeClass(this.regionBlockNode,"bx-active"),this.regionBlockNode.style.display="none",this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||this.initFirstSection())),i.appendChild(s),t.appendChild(i),this.getBlockFooter(t))},editFadeRegionBlock:function(){var e,t=this.regionBlockNode.querySelector(".bx-soa-section-content");this.initialized.region?this.regionHiddenBlockNode.appendChild(t):(this.editActiveRegionBlock(!1),BX.remove(BX.lastChild(this.regionBlockNode))),e=this.getNewContainer(!0),this.regionBlockNode.appendChild(e),this.editFadeRegionContent(e)},editFadeRegionContent:function(e){if(e&&this.locationsInitialized){var t,i,s,a,r,o,l,n,c=this.getSelectedPersonType(),p=this.regionHiddenBlockNode.querySelector(".alert.alert-danger"),h="",d=[],u="";for(r in BX.cleanNode(e),p&&e.appendChild(p.cloneNode(!0)),c&&c.NAME&&this.result.PERSON_TYPE.length>1&&(h+="<strong>"+this.params.MESS_PERSON_TYPE+":</strong> "+BX.util.htmlspecialchars(c.NAME)+"<br>"),c&&(a="PROPS_FADE_LIST_"+c.ID,d=this.params[a]||[]),this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(r))if("Y"==this.result.ORDER_PROP.properties[r].IS_LOCATION&&this.result.ORDER_PROP.properties[r].ID==this.deliveryLocationInfo.loc)t=this.result.ORDER_PROP.properties[r];else if("Y"==this.result.ORDER_PROP.properties[r].IS_ZIP&&this.result.ORDER_PROP.properties[r].ID==this.deliveryLocationInfo.zip)for(s=this.result.ORDER_PROP.properties[r],o=0;o<d.length;o++)if(d[o]==s.ID){u=(i=BX("zipProperty"))&&i.value&&i.value.length?i.value:BX.message("SOA_NOT_SPECIFIED");break}l=this.getLocationString(this.regionHiddenBlockNode),t&&l.length&&(h+="<strong>"+BX.util.htmlspecialchars(t.NAME)+":</strong> "+BX.util.htmlspecialchars(l)+"<br>"),s&&u.length&&(h+="<strong>"+BX.util.htmlspecialchars(s.NAME)+":</strong> "+BX.util.htmlspecialchars(u)),e.innerHTML+=h,"true"==this.regionBlockNode.getAttribute("data-visited")&&((n=this.isValidRegionBlock()).length?(BX.addClass(this.regionBlockNode,"bx-step-error"),this.showError(this.regionBlockNode,n)):BX.removeClass(this.regionBlockNode,"bx-step-error")),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))}},getSelectedPersonType:function(){var e,t,i,s,a=this.result.PERSON_TYPE.length;if(1==a?(e=this.regionBlockNode.querySelector("input[type=hidden][name=PERSON_TYPE]"))||(e=this.regionHiddenBlockNode.querySelector("input[type=hidden][name=PERSON_TYPE]")):2==a?(e=this.regionBlockNode.querySelector("input[type=radio][name=PERSON_TYPE]:checked"))||(e=this.regionHiddenBlockNode.querySelector("input[type=radio][name=PERSON_TYPE]:checked")):(e=this.regionBlockNode.querySelector("select[name=PERSON_TYPE] > option:checked"))||(e=this.regionHiddenBlockNode.querySelector("select[name=PERSON_TYPE] > option:checked")),e)for(s in i=e.value,this.result.PERSON_TYPE)if(this.result.PERSON_TYPE[s].ID==i){t=this.result.PERSON_TYPE[s];break}return t},getDeliveryLocationInput:function(e){var t,i,s,a,r,o,l,n,c,p,h,d,u;for(r in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(r)&&"Y"==(t=this.result.ORDER_PROP.properties[r]).IS_LOCATION){i=t.ID,s=parseInt(t.INPUT_FIELD_LOCATION);break}if((a=this.locations[i])&&a[0]&&a[0].output)for(r in this.regionBlockNotEmpty=!0,l='<label class="bx-soa-custom-label" for="soa-property-'+parseInt(i)+'">'+("Y"==t.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"")+BX.util.htmlspecialchars(t.NAME)+(t.DESCRIPTION.length?" <small>("+BX.util.htmlspecialchars(t.DESCRIPTION)+")</small>":"")+"</label>",n=a[0].output,c=BX.create("DIV",{attrs:{"data-property-id-row":i},props:{className:"form-group bx-soa-location-input-container"},style:{visibility:"hidden"},html:l+n.HTML}),e.appendChild(c),e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"RECENT_DELIVERY_VALUE",value:a[0].lastValue}})),n.SCRIPT)n.SCRIPT.hasOwnProperty(r)&&BX.evalGlobal(n.SCRIPT[r].JS);if(a&&a[0]&&a[0].showAlt&&s>0)for(r in this.result.ORDER_PROP.properties)if(parseInt(this.result.ORDER_PROP.properties[r].ID)==s){o=this.result.ORDER_PROP.properties[r];break}o&&(u=BX.create("DIV",{attrs:{"data-property-id-row":o.ID},props:{className:"form-group bx-soa-location-input-container"}}),p="Y"==o.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"",p+=BX.util.htmlspecialchars(o.NAME),h=BX.create("LABEL",{attrs:{for:"altProperty"},props:{className:"bx-soa-custom-label"},html:p}),d=BX.create("INPUT",{props:{id:"altProperty",type:"text",placeholder:o.DESCRIPTION,autocomplete:"city",className:"form-control bx-soa-customer-input bx-ios-fix",name:"ORDER_PROP_"+o.ID,value:o.VALUE},attr:{disabled:!0}}),u.appendChild(h),u.appendChild(d),e.appendChild(u),this.bindValidation(o.ID,u)),this.getZipLocationInput(e),a&&a[0]&&e.appendChild(BX.create("DIV",{props:{className:"bx-soa-reference"},html:this.params.MESS_REGION_REFERENCE}))},getLocationString:function(e){if(!e)return"";var t,i,s,a=e.querySelector(".bx-ui-sls-route"),r="";if(a&&a.value&&a.value.length)r=a.value;else{for(i=(t=e.querySelectorAll(".bx-ui-combobox-fake.bx-combobox-fake-as-input")).length;i--;)t[i].innerHTML.indexOf("...")>=0||(t[i].innerHTML.indexOf("---")>=0?(s=BX("altProperty"))&&s.value.length&&(r+=s.value):(r.length&&(r+=", "),r+=t[i].innerHTML));0==r.length&&(r=BX.message("SOA_NOT_SPECIFIED"))}return r},getZipLocationInput:function(e){var t,i,s,a,r,o;for(i in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(i)&&"Y"==this.result.ORDER_PROP.properties[i].IS_ZIP){t=this.result.ORDER_PROP.properties[i];break}t&&(this.regionBlockNotEmpty=!0,(s=BX.create("DIV",{props:{className:"form-group bx-soa-location-input-container"}})).setAttribute("data-property-id-row",t.ID),a="Y"==t.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"",a+=BX.util.htmlspecialchars(t.NAME),r=BX.create("LABEL",{attrs:{for:"zipProperty"},props:{className:"bx-soa-custom-label"},html:a}),o=BX.create("INPUT",{props:{id:"zipProperty",type:"text",placeholder:t.DESCRIPTION,autocomplete:"zip",className:"form-control bx-soa-customer-input bx-ios-fix",name:"ORDER_PROP_"+t.ID,value:t.VALUE}}),s.appendChild(r),s.appendChild(o),e.appendChild(s),e.appendChild(BX.create("input",{props:{id:"ZIP_PROPERTY_CHANGED",name:"ZIP_PROPERTY_CHANGED",type:"hidden",value:this.result.ZIP_PROPERTY_CHANGED||"N"}})),this.bindValidation(t.ID,s))},getPersonTypeSortedArray:function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(e[t]);return i.sort((function(e,t){return parseInt(e.SORT)-parseInt(t.SORT)}))},getPersonTypeControl:function(e){if(this.result.PERSON_TYPE){this.result.PERSON_TYPE=this.getPersonTypeSortedArray(this.result.PERSON_TYPE);var t,i,s,a,r,o=this.result.PERSON_TYPE.length,l=[],n=!1;if(o>1&&(a=BX.create("DIV",{props:{className:"form-group"},children:[BX.create("LABEL",{props:{className:"bx-soa-custom-label"},html:this.params.MESS_PERSON_TYPE}),BX.create("BR")]}),e.appendChild(a),e=a),o>2){for(s in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(s)&&(t=this.result.PERSON_TYPE[s],l.push(BX.create("OPTION",{props:{value:t.ID,selected:"Y"==t.CHECKED},text:t.NAME})),"Y"==t.CHECKED&&(i=t.ID));e.appendChild(BX.create("SELECT",{props:{name:"PERSON_TYPE",className:"form-control"},children:l,events:{change:BX.proxy(this.sendRequest,this)}})),this.regionBlockNotEmpty=!0}else if(2==o){for(s in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(s)&&(t=this.result.PERSON_TYPE[s],r=BX.create("LABEL",{children:[BX.create("INPUT",{attrs:{checked:"Y"==t.CHECKED},props:{type:"radio",name:"PERSON_TYPE",value:t.ID}}),BX.util.htmlspecialchars(t.NAME)],events:{change:BX.proxy(this.sendRequest,this)}}),n&&e.appendChild(BX.create("BR")),e.appendChild(BX.create("DIV",{props:{className:"radio-inline"},children:[r]})),n=!0,"Y"==t.CHECKED&&(i=t.ID));this.regionBlockNotEmpty=!0}else for(s in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(s)&&e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"PERSON_TYPE",value:this.result.PERSON_TYPE[s].ID}}));i&&e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"PERSON_TYPE_OLD",value:i}}))}},getProfilesControl:function(e){var t,i,s,a,r=BX.util.object_keys(this.result.USER_PROFILES).length,o=[];if(r)if("Y"===this.params.ALLOW_USER_PROFILES&&(r>1||"Y"===this.params.ALLOW_NEW_PROFILE)){for(t in this.regionBlockNotEmpty=!0,i=BX.create("LABEL",{props:{className:"bx-soa-custom-label"},html:this.params.MESS_SELECT_PROFILE}),this.result.USER_PROFILES)this.result.USER_PROFILES.hasOwnProperty(t)&&o.unshift(BX.create("OPTION",{props:{value:this.result.USER_PROFILES[t].ID,selected:"Y"===this.result.USER_PROFILES[t].CHECKED},html:this.result.USER_PROFILES[t].NAME}));"Y"===this.params.ALLOW_NEW_PROFILE&&o.unshift(BX.create("OPTION",{props:{value:0},text:BX.message("SOA_PROP_NEW_PROFILE")})),s=BX.create("INPUT",{props:{type:"hidden",value:"N",id:"profile_change",name:"profile_change"}}),a=BX.create("SELECT",{props:{className:"form-control",name:"PROFILE_ID"},children:o,events:{change:BX.delegate((function(){BX("profile_change").value="Y",this.sendRequest()}),this)}}),e.appendChild(BX.create("DIV",{props:{className:"form-group bx-soa-location-input-container"},children:[i,s,a]}))}else for(t in this.result.USER_PROFILES)this.result.USER_PROFILES.hasOwnProperty(t)&&"Y"===this.result.USER_PROFILES[t].CHECKED&&e.appendChild(BX.create("INPUT",{props:{name:"PROFILE_ID",type:"hidden",value:this.result.USER_PROFILES[t].ID}}))},editPaySystemBlock:function(e){this.paySystemBlockNode&&this.paySystemHiddenBlockNode&&this.result.PAY_SYSTEM&&(e?this.editActivePaySystemBlock(!0):this.editFadePaySystemBlock(),this.initialized.paySystem=!0)},editActivePaySystemBlock:function(e){const t=BX.create("DIV",{props:{className:"order__pay-slider-wrapper"}}),i=BX.create("DIV",{props:{className:"order__cart-slider-button swiper-button-next"},html:'<svg width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0.41399 6.65671C0.41399 6.42348 0.506637 6.19981 0.671551 6.0349C0.836465 5.86998 1.06014 5.77734 1.29336 5.77734L14.4728 5.77734L10.6968 2.00308C10.5317 1.83795 10.4389 1.614 10.4389 1.38048C10.4389 1.14696 10.5317 0.92301 10.6968 0.757887C10.8619 0.592765 11.0859 0.5 11.3194 0.5C11.5529 0.5 11.7769 0.592765 11.942 0.757887L17.2182 6.03411C17.3001 6.1158 17.3651 6.21284 17.4094 6.31967C17.4537 6.42651 17.4766 6.54104 17.4766 6.65671C17.4766 6.77237 17.4537 6.88691 17.4094 6.99374C17.3651 7.10058 17.3001 7.19762 17.2182 7.2793L11.942 12.5555C11.7769 12.7206 11.5529 12.8134 11.3194 12.8134C11.0859 12.8134 10.8619 12.7206 10.6968 12.5555C10.5317 12.3904 10.4389 12.1665 10.4389 11.9329C10.4389 11.6994 10.5317 11.4755 10.6968 11.3103L14.4728 7.53608L1.29336 7.53608C1.06014 7.53608 0.836465 7.44343 0.671551 7.27852C0.506637 7.1136 0.41399 6.88993 0.41399 6.65671Z" fill="#090B18"></path></svg>'});var s,a=this.paySystemBlockNode,r=a.querySelector(".bx-soa-section-content");r?BX.cleanNode(r):(r=this.getNewContainer(),a.appendChild(r)),this.getErrorContainer(r),s=BX.create("DIV",{props:{className:"bx-soa-pp swiper order__pay-slider"}}),this.editPaySystemItems(s),this.editPaySystemInfo(s),"Y"==this.params.SHOW_COUPONS_PAY_SYSTEM&&this.editCoupons(r),this.getBlockFooter(r),t.appendChild(s),t.appendChild(i),r.appendChild(t),this.initSlider(".order__pay-slider",{direction:"horizontal",loop:!0,spaceBetween:20})},editFadePaySystemBlock:function(){var e,t=this.paySystemBlockNode.querySelector(".bx-soa-section-content");this.initialized.paySystem?this.paySystemHiddenBlockNode.appendChild(t):(this.editActivePaySystemBlock(!1),BX.remove(BX.lastChild(this.paySystemBlockNode))),e=this.getNewContainer(!0),this.paySystemBlockNode.appendChild(e),this.editFadePaySystemContent(e),"Y"==this.params.SHOW_COUPONS_PAY_SYSTEM&&this.editCouponsFade(e)},editPaySystemItems:function(e){if(this.result.PAY_SYSTEM&&!(this.result.PAY_SYSTEM.length<=0)){var t,i,s=BX.create("DIV",{props:{className:"bx-soa-pp-item-container swiper-wrapper"}});for(i=0;i<this.paySystemPagination.currentPage.length;i++)t=this.createPaySystemItem(this.paySystemPagination.currentPage[i]),s.appendChild(t);this.paySystemPagination.show&&this.showPagination("paySystem",s),e.appendChild(s)}},createPaySystemItem:function(e){var t,i,s,a,r,o="Y"==e.CHECKED,l=parseInt(e.ID);return i=BX.create("DIV",{props:{className:"bx-soa-pp-company-image"}}),(t=this.getImageSources(e,"PSA_LOGOTIP"))&&t.src_2x?i.setAttribute("style",'background-image: url("'+t.src_1x+'");background-image: -webkit-image-set(url("'+t.src_1x+'") 1x, url("'+t.src_2x+'") 2x)'):(t=t&&t.src_1x||this.defaultPaySystemLogo,i.setAttribute("style",'background-image: url("'+t+'");')),"Y"==this.params.SHOW_PAY_SYSTEM_LIST_NAMES&&(s=BX.create("DIV",{props:{className:"bx-soa-pp-company-smalltitle"},text:e.NAME})),a=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container pay-slide"},children:[BX.create("INPUT",{props:{id:"ID_PAY_SYSTEM_ID_"+l,name:"PAY_SYSTEM_ID",type:"checkbox",className:"bx-soa-pp-company-checkbox",value:l,checked:o}}),i,s]}),r=BX.create("DIV",{props:{className:"bx-soa-pp-company bx-soa-pp-pay swiper-slide"},children:[a],events:{click:BX.proxy(this.selectPaySystem,this)}}),o&&BX.addClass(r,"bx-selected"),r},editPaySystemInfo:function(e){var t,i,s,a,r,o,l;!this.result.PAY_SYSTEM||0==this.result.PAY_SYSTEM.length&&"Y"!=this.result.PAY_FROM_ACCOUNT||(t=this.getSelectedPaySystem())&&(s=BX.create("DIV",{props:{className:"bx-soa-pp-company-image"}}),(i=this.getImageSources(t,"PSA_LOGOTIP"))&&i.src_2x?s.setAttribute("style",'background-image: url("'+i.src_1x+'");background-image: -webkit-image-set(url("'+i.src_1x+'") 1x, url("'+i.src_2x+'") 2x)'):(i=i&&i.src_1x||this.defaultPaySystemLogo,s.setAttribute("style",'background-image: url("'+i+'");')),"Y"==this.params.SHOW_PAY_SYSTEM_INFO_NAME&&(a=BX.create("DIV",{props:{className:"bx-soa-pp-company-subTitle"},text:t.NAME})),r=BX.create("DIV",{props:{className:"bx-soa-pp-company-logo"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[s]})]}),o=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:t.DESCRIPTION})]}),t.PRICE&&parseFloat(t.PRICE)>0&&(l=BX.create("UL",{props:{className:"bx-soa-pp-list"},children:[BX.create("LI",{children:[BX.create("DIV",{props:{className:"bx-soa-pp-list-termin"},html:this.params.MESS_PRICE+":"}),BX.create("DIV",{props:{className:"bx-soa-pp-list-description"},text:"~"+t.PRICE_FORMATTED})]})]})),BX.create("DIV",{children:[a,r,o,l]}))},getInnerPaySystem:function(){if(this.result.CURRENT_BUDGET_FORMATED&&this.result.PAY_CURRENT_ACCOUNT&&this.result.INNER_PAY_SYSTEM){var e,t,i,s,a,r,o,l,n=this.params.ONLY_FULL_PAY_FROM_ACCOUNT&&"Y"==this.params.ONLY_FULL_PAY_FROM_ACCOUNT,c=this.result.PAY_CURRENT_ACCOUNT&&"Y"==this.result.PAY_CURRENT_ACCOUNT,p=this.result.INNER_PAY_SYSTEM;return"Y"==this.params.SHOW_PAY_SYSTEM_INFO_NAME&&(i=BX.create("DIV",{props:{className:"bx-soa-pp-company-subTitle"},text:p.NAME})),t=BX.create("DIV",{props:{className:"bx-soa-pp-company-image"}}),(e=this.getImageSources(p,"LOGOTIP"))&&e.src_2x?t.setAttribute("style",'background-image: url("'+e.src_1x+'");background-image: -webkit-image-set(url("'+e.src_1x+'") 1x, url("'+e.src_2x+'") 2x)'):(e=e&&e.src_1x||this.defaultPaySystemLogo,t.setAttribute("style",'background-image: url("'+e+'");')),s=BX.create("DIV",{props:{className:"bx-soa-pp-company-logo"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[BX.create("INPUT",{props:{type:"checkbox",className:"bx-soa-pp-company-checkbox",name:"PAY_CURRENT_ACCOUNT",value:"Y",checked:c}}),t],events:{click:BX.proxy(this.selectPaySystem,this)}})]}),p.DESCRIPTION&&p.DESCRIPTION.length&&(a=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:p.DESCRIPTION})]})),r=BX.create("INPUT",{props:{type:"hidden",name:"PAY_CURRENT_ACCOUNT",value:"N"}}),o=this.params.MESS_INNER_PS_BALANCE+' <b class="wsnw">'+this.result.CURRENT_BUDGET_FORMATED+"</b><br>"+(n?BX.message("SOA_PAY_ACCOUNT3"):""),l=BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:o}),BX.create("DIV",{props:{className:"bx-soa-pp-inner-ps"+(c?" bx-selected":"")},children:[r,i,s,a,l]})}},editFadePaySystemContent:function(e){var t,i=this.getSelectedPaySystem(),s=this.paySystemHiddenBlockNode.querySelector("div.alert.alert-danger"),a=this.paySystemHiddenBlockNode.querySelector("div.alert.alert-warning.alert-show"),r="";s?e.appendChild(s.cloneNode(!0)):this.getErrorContainer(e),a&&a.innerHTML&&e.appendChild(a.cloneNode(!0)),this.isSelectedInnerPayment()&&(r+='<div class="bx-soa-pp-company-selected">',r+='<img src="'+((t=this.getImageSources(this.result.INNER_PAY_SYSTEM,"LOGOTIP"))&&t.src_1x||this.defaultPaySystemLogo)+'" style="height:18px;" alt="">',r+="<strong>"+this.result.INNER_PAY_SYSTEM.NAME+"</strong><br>",r+="</div>"),i&&i.NAME&&(r+='<div class="bx-soa-pp-company-selected">',r+='<img src="'+((t=this.getImageSources(i,"PSA_LOGOTIP"))&&t.src_1x||this.defaultPaySystemLogo)+'" style="height:18px;" alt="">',r+="<strong>"+BX.util.htmlspecialchars(i.NAME)+"</strong>",r+="</div>"),r.length||(r="<strong>"+BX.message("SOA_PS_SELECT_ERROR")+"</strong>"),e.innerHTML+=r,e.appendChild(BX.create("DIV",{style:{clear:"both"}})),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))},getSelectedPaySystem:function(){var e,t,i=this.paySystemBlockNode.querySelector("input[type=checkbox][name=PAY_SYSTEM_ID]:checked"),s=null;if(i||(i=this.paySystemHiddenBlockNode.querySelector("input[type=checkbox][name=PAY_SYSTEM_ID]:checked")),i||(i=this.paySystemHiddenBlockNode.querySelector("input[type=hidden][name=PAY_SYSTEM_ID]")),i)for(e=i.value,t=0;t<this.result.PAY_SYSTEM.length;t++)if(this.result.PAY_SYSTEM[t].ID==e){s=this.result.PAY_SYSTEM[t];break}return s},isSelectedInnerPayment:function(){var e=this.paySystemBlockNode.querySelector("input[type=checkbox][name=PAY_CURRENT_ACCOUNT]");return e||(e=this.paySystemHiddenBlockNode.querySelector("input[type=checkbox][name=PAY_CURRENT_ACCOUNT]")),e&&e.checked},selectPaySystem:function(e){if(this.orderBlockNode&&e){var t,i=e.target||e.srcElement,s=this.paySystemBlockNode.querySelector("div.bx-soa-pp-inner-ps"),a=this.paySystemBlockNode.querySelector("input[type=checkbox][name=PAY_CURRENT_ACCOUNT]"),r=this.result.TOTAL&&0===parseFloat(this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY),o=BX.hasClass(i,"bx-soa-pp-inner-ps")?i:BX.findParent(i,{className:"bx-soa-pp-inner-ps"}),l=BX.hasClass(i,"bx-soa-pp-company")?i:BX.findParent(i,{className:"bx-soa-pp-company"});if(o)"INPUT"==i.nodeName&&(a.checked=!a.checked),a.checked?(BX.removeClass(s,"bx-selected"),a.checked=!1):(BX.addClass(s,"bx-selected"),a.checked=!0);else if(l){if(BX.hasClass(l,"bx-selected"))return BX.PreventDefault(e);a&&a.checked&&r?(BX.addClass(l,"bx-selected"),l.querySelector("input[type=checkbox]").checked=!0,BX.removeClass(s,"bx-selected"),a.checked=!1):(t=this.paySystemBlockNode.querySelector(".bx-soa-pp-company.bx-selected"),BX.addClass(l,"bx-selected"),l.querySelector("input[type=checkbox]").checked=!0,t&&(BX.removeClass(t,"bx-selected"),t.querySelector("input[type=checkbox]").checked=!1))}this.sendRequest()}},editDeliveryBlock:function(e){this.deliveryBlockNode&&this.deliveryHiddenBlockNode&&this.result.DELIVERY&&(e?this.editActiveDeliveryBlock(!0):this.editFadeDeliveryBlock(),this.checkPickUpShow(),this.initialized.delivery=!0)},editActiveDeliveryBlock:function(e){var t,i,s=e?this.deliveryBlockNode:this.deliveryHiddenBlockNode;this.initialized.delivery?(BX.remove(BX.lastChild(s)),s.appendChild(BX.firstChild(this.deliveryHiddenBlockNode))):((t=s.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),s.appendChild(t)),this.getErrorContainer(t),i=BX.create("DIV",{props:{className:"bx-soa-pp row"}}),this.editDeliveryItems(i),t.appendChild(i),this.editDeliveryInfo(i),"Y"==this.params.SHOW_COUPONS_DELIVERY&&this.editCoupons(t),this.getBlockFooter(t))},editDeliveryItems:function(e){if(this.result.DELIVERY&&!(this.result.DELIVERY.length<=0)){var t,i,s=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-pp-item-container"}});for(i=0;i<this.deliveryPagination.currentPage.length;i++)t=this.createDeliveryItem(this.deliveryPagination.currentPage[i]),s.appendChild(t);this.deliveryPagination.show&&this.showPagination("delivery",s),e.appendChild(s)}},editDeliveryInfo:function(e){if(this.result.DELIVERY){var t,i,s,a,r,o,l,n,c,p,h,d,u=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-pp-desc-container"}});BX.cleanNode(u),t=this.getSelectedDelivery(),a=BX.create("DIV",{props:{className:"bx-soa-pp-company-image"}}),(i=this.getImageSources(t,"LOGOTIP"))&&i.src_2x||(i=i&&i.src_1x||this.defaultDeliveryLogo),s="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?t.NAME:t.OWN_NAME,"Y"==this.params.SHOW_DELIVERY_INFO_NAME&&(r=BX.create("DIV",{props:{className:"bx-soa-pp-company-subTitle"},text:s})),BX.create("DIV",{props:{className:"bx-soa-pp-company-logo"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[a]})]}),o=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:t.DESCRIPTION}),t.CALCULATE_DESCRIPTION?BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:t.CALCULATE_DESCRIPTION}):null]}),t.PRICE>=0&&(l=BX.create("LI",{children:[BX.create("DIV",{props:{className:"bx-soa-pp-list-termin"},html:this.params.MESS_PRICE+":"}),BX.create("DIV",{props:{className:"bx-soa-pp-list-description"},children:this.getDeliveryPriceNodes(t)})]})),t.PERIOD_TEXT&&t.PERIOD_TEXT.length&&(n=BX.create("LI",{children:[BX.create("DIV",{props:{className:"bx-soa-pp-list-termin"},html:this.params.MESS_PERIOD+":"}),BX.create("DIV",{props:{className:"bx-soa-pp-list-description"},html:t.PERIOD_TEXT})]})),c=BX.create("DIV",{style:{clear:"both"}}),p=BX.create("UL",{props:{className:"bx-soa-pp-list"},children:[l,n]}),(h=this.getDeliveryExtraServices(t)).length&&(d=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:h})),u.appendChild(BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[r,o,c,d,p]})),e.appendChild(u);var B={input:BX.create("INPUT",{props:{className:"md-input"},attrs:{type:"text",placeholder:"Адрес не выбран",disabled:"true",value:this.orderData.ADDRESS.VALUE}}),button:BX.create("BUTTON",{props:{className:"address-button change__recipient__btn"},attrs:{type:"button"},text:"Добавить адрес"})};switch(this.deliveryData.type){case"courier:simple":this.handleCourierItem(B);break;case"courier:pickup":this.handlePVZItem(this.deliveryData.item)}"Y"!=this.params.DELIVERY_NO_AJAX&&(this.deliveryCachedInfo[t.ID]=t)}},getDeliveryPriceNodes:function(e){return void 0!==e.DELIVERY_DISCOUNT_PRICE&&parseFloat(e.DELIVERY_DISCOUNT_PRICE)!=parseFloat(e.PRICE)?parseFloat(e.DELIVERY_DISCOUNT_PRICE)>parseFloat(e.PRICE)?[e.DELIVERY_DISCOUNT_PRICE_FORMATED]:[e.DELIVERY_DISCOUNT_PRICE_FORMATED,BX.create("BR"),BX.create("SPAN",{props:{className:"bx-price-old"},html:e.PRICE_FORMATED})]:[e.PRICE_FORMATED]},getDeliveryExtraServices:function(e){var t,i,s,a,r,o=[],l=!1;for(t in e.EXTRA_SERVICES)e.EXTRA_SERVICES.hasOwnProperty(t)&&(i=e.EXTRA_SERVICES[t]).canUserEditValue&&(-1==i.editControl.indexOf("this.checked")?(a=BX.create("LABEL",{html:BX.util.htmlspecialchars(i.name)+(i.price?" ("+i.priceFormatted+")":"")}),0==t&&(l=!0),s=BX.create("DIV",{props:{className:"form-group bx-soa-pp-field"},html:i.editControl+(i.description&&i.description.length?'<div class="bx-soa-service-small">'+BX.util.htmlspecialchars(i.description)+"</div>":"")}),BX.prepend(a,s),(r=s.querySelector("input[type=text]"))||(r=s.querySelector("select")),r&&BX.addClass(r,"form-control")):s=BX.create("DIV",{props:{className:"checkbox"},children:[BX.create("LABEL",{html:i.editControl+BX.util.htmlspecialchars(i.name)+(i.price?" ("+i.priceFormatted+")":"")+(i.description&&i.description.length?'<div class="bx-soa-service-small">'+BX.util.htmlspecialchars(i.description)+"</div>":"")})]}),o.push(s));return l&&o.unshift(BX.create("BR")),o},editFadeDeliveryBlock:function(){var e,t=this.deliveryBlockNode.querySelector(".bx-soa-section-content");this.initialized.delivery?this.deliveryHiddenBlockNode.appendChild(t):(this.editActiveDeliveryBlock(!1),BX.remove(BX.lastChild(this.deliveryBlockNode))),e=this.getNewContainer(!0),this.deliveryBlockNode.appendChild(e),this.editFadeDeliveryContent(e),"Y"==this.params.SHOW_COUPONS_DELIVERY&&this.editCouponsFade(e)},createDeliveryItem:function(e){var t,i,s,a,r,o="Y"==e.CHECKED,l=parseInt(e.ID),n=[BX.create("INPUT",{props:{id:"ID_DELIVERY_ID_"+l,name:"DELIVERY_ID",type:"checkbox",className:"bx-soa-pp-company-checkbox",value:l,checked:o}})],c=this.deliveryCachedInfo[l];return r=BX.create("DIV",{props:{className:"bx-soa-pp-company-image"}}),(t=this.getImageSources(e,"LOGOTIP"))&&t.src_2x||(t=t&&t.src_1x||this.defaultDeliveryLogo,r.setAttribute("style",'background-image: url("'+t+'");')),e.PRICE>=0||void 0!==e.DELIVERY_DISCOUNT_PRICE||c&&(c.PRICE>=0||c.DELIVERY_DISCOUNT_PRICE),i=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"+(e.CALCULATE_ERRORS||c&&c.CALCULATE_ERRORS?" bx-bd-waring":"")},children:n}),"Y"==this.params.SHOW_DELIVERY_LIST_NAMES&&(s=BX.create("DIV",{props:{className:"bx-soa-pp-company-smalltitle"},text:"N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?e.NAME:e.OWN_NAME})),a=BX.create("DIV",{props:{className:"bx-soa-pp-company col-lg-12 col-sm-12 col-xs-12"},children:[i,s],events:{click:BX.proxy(this.selectDelivery,this)}}),o&&BX.addClass(a,"bx-selected"),o&&this.result.LAST_ORDER_DATA.PICK_UP&&(this.lastSelectedDelivery=l),"Y"==e.CHECKED&&this.handleSelectDelivery(e.ID,e),a},handleSelectDelivery:function(e,t){var i=this.deliveryTypeById[e]||"SERVICE_"+e;this.deliveryData={item:t,type:i}},fillProductSlider:function(e){if(e){var t=BX.findChild(e,{className:"order__cart-slider"},!0);if(t){BX.addClass(t,"swiper");var i=BX.findChild(t,{className:"swiper-wrapper"},!0);i||(i=BX.create("DIV",{props:{className:"swiper-wrapper"}}),t.appendChild(i)),BX.cleanNode(i);for(var s=this.result.GRID&&this.result.GRID.ROWS?this.result.GRID.ROWS:null,a=s?Object.values(s):[],r=0;r<a.length;r++){var o=a[r].data||a[r],l=o.DETAIL_PAGE_URL||"#",n=o.PREVIEW_PICTURE_SRC||o.DETAIL_PICTURE_SRC||"/local/templates/mains/assets/images/order/t1.png",c=o.NAME||"",p=BX.create("LI",{props:{className:"order__accordion-products-item swiper-slide"},children:[BX.create("A",{attrs:{href:l},children:[BX.create("IMG",{attrs:{src:n,alt:c}})]})]});i.appendChild(p)}a.length?BX.show(t):BX.hide(t)}}},initSlider:function(e,t){document.querySelectorAll(e).forEach((e=>{e.classList.contains("swiper")||e.classList.add("swiper");const i=e.querySelector(".swiper-wrapper"),s=(i?i.querySelectorAll(".swiper-slide"):[]).length;if(0===s)return;const a=e=>"auto"===e?"auto":Math.min(e,Math.max(1,s)),r=4,o=3,l=3,n=2,c="auto",p=s>4,h=Object.assign({},t,{slidesPerView:a(r),spaceBetween:t.spaceBetween||20,loop:p,watchOverflow:!0,navigation:{nextEl:e.parentElement.querySelector(".swiper-button-next")},breakpoints:{769:{slidesPerView:a(r),spaceBetween:20},768:{slidesPerView:a(o),spaceBetween:20},569:{slidesPerView:a(l),spaceBetween:20},481:{slidesPerView:a(n),spaceBetween:15},280:{slidesPerView:a(c),spaceBetween:10}}});return new Swiper(e,h)}))},handleCourierItem:function(e){let t=document.querySelector(".bx-soa-pp-desc-container .bx-soa-pp-company");if(t){let i=BX.create("DIV",{props:{className:"order__cart-slider-parent"},children:[BX.create("DIV",{props:{className:"order__cart-slider"},children:[BX.create("DIV",{props:{className:"swiper-wrapper"}})]}),BX.create("div",{props:{className:"order__cart-slider-button swiper-button-next"},html:'<svg width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0.41399 6.65671C0.41399 6.42348 0.506637 6.19981 0.671551 6.0349C0.836465 5.86998 1.06014 5.77734 1.29336 5.77734L14.4728 5.77734L10.6968 2.00308C10.5317 1.83795 10.4389 1.614 10.4389 1.38048C10.4389 1.14696 10.5317 0.92301 10.6968 0.757887C10.8619 0.592765 11.0859 0.5 11.3194 0.5C11.5529 0.5 11.7769 0.592765 11.942 0.757887L17.2182 6.03411C17.3001 6.1158 17.3651 6.21284 17.4094 6.31967C17.4537 6.42651 17.4766 6.54104 17.4766 6.65671C17.4766 6.77237 17.4537 6.88691 17.4094 6.99374C17.3651 7.10058 17.3001 7.19762 17.2182 7.2793L11.942 12.5555C11.7769 12.7206 11.5529 12.8134 11.3194 12.8134C11.0859 12.8134 10.8619 12.7206 10.6968 12.5555C10.5317 12.3904 10.4389 12.1665 10.4389 11.9329C10.4389 11.6994 10.5317 11.4755 10.6968 11.3103L14.4728 7.53608L1.29336 7.53608C1.06014 7.53608 0.836465 7.44343 0.671551 7.27852C0.506637 7.1136 0.41399 6.88993 0.41399 6.65671Z" fill="#090B18"></path></svg>'})]}),s=BX.create("DIV",{props:{id:"calendar",className:"color-calendar"}}),a=this.initCalendar(),r=this.initWeakTime(),o=this.initWeakendTime(),l=t.querySelector(".bx-soa-pp-company-subTitle");l?(BX.insertAfter(e.input,l),BX.insertAfter(e.button,e.input),BX.insertAfter(i,e.button),this.fillProductSlider(t),this.initSlider(".order__cart-slider",{direction:"horizontal",loop:!0,spaceBetween:20}),BX.insertAfter(a,document.querySelector(".order__cart-slider-parent")),BX.insertAfter(s,a),BX.insertAfter(r,s),BX.insertAfter(o,r)):(t.insertBefore(e.input,t.firstChild),BX.insertAfter(e.button,e.input),BX.insertAfter(i,e.button),this.fillProductSlider(t),this.initSlider(".order__cart-slider",{direction:"horizontal",loop:!0,spaceBetween:20}),BX.insertAfter(a,document.querySelector(".order__cart-slider-parent")),BX.insertAfter(s,a),BX.insertAfter(r,s),BX.insertAfter(o,r)),this.handleCourierAddres()}else console.error("Failed to initialize shipping container")},handleCourierAddres:function(){this.initAddresPopup(),BX.bind(document.querySelector(".address-button"),"click",(e=>this.handleOpenPopup(e,"change-recipient-modal"))),BX.bind(document.querySelector(".modal__close"),"click",(e=>this.handleClosePopup(e,"change-recipient-modal")))},handleOpenPopup:function(e,t){e.preventDefault(),e.stopPropagation();const i=BX(t);if(!i)return;BX.addClass(i,"is-open"),i.setAttribute("aria-hidden","false");const s=i.querySelector(".modal__close");s&&BX.bind(s,"click",(e=>this.handleClosePopup(e,t)));const a=i.querySelector(".modal__overlay");a&&BX.bind(a,"click",(e=>this.handleClosePopup(e,t)))},handleClosePopup:function(e,t){e.preventDefault(),e.stopPropagation();const i=BX(t);i&&(BX.removeClass(i,"is-open"),i.setAttribute("aria-hidden","true"))},initDayWeaks:function(){let e=["вс","пн","вт","ср","чт","пт","сб"],t=new Date,i=[];for(let s=0;s<e.length;s++){let a=new Date(t);a.setDate(t.getDate()+s);let r=e[a.getDay()],o=a.getDate();i.push(BX.create("DIV",{attrs:{className:"order__accordion-form-day-label "+(0==s?"is-active":"")},children:[BX.create("p",{text:r}),BX.create("strong",{text:o.toString()})]}))}return i},initCalendar:function(){let e=this.initDayWeaks();return BX.create("DIV",{attrs:{className:"order__accordion-form-day"},children:[...e,BX.create("button",{attrs:{className:"order__accordion-form-day-button",id:"openCalendarBtn",type:"button"},html:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t\t\t\t\t\t\t<path d="M18 4H6C3.79086 4 2 5.79086 2 8V18C2 20.2091 3.79086 22 6 22H18C20.2091 22 22 20.2091 22 18V8C22 5.79086 20.2091 4 18 4Z" stroke="#4789EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t\t\t\t\t\t\t\t\t<path d="M8 2V6" stroke="#4789EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t\t\t\t\t\t\t\t\t<path d="M16 2V6" stroke="#4789EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t\t\t\t\t\t\t\t\t<path d="M2 10H22" stroke="#4789EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t\t'})]})},initActualTime:function(e,t,i){let s=new Date,a=60*s.getHours()+s.getMinutes(),r=0===s.getDay()||6===s.getDay();return e.map((e=>{let[i,s]=e.split(" - "),[o,l]=s.split(":").map(Number),n=a>60*o+l||(t&&!r||!t&&r);return BX.create("DIV",{attrs:{className:"order__accordion-form-time-label"+(n?" disabled":""),...n?{disabled:"disabled"}:{}},children:[BX.create("p",{text:e})]})}))},initWeakTime:function(){let e=this.initActualTime(["09:00 - 13:00","13:00 - 16:00","16:00 - 19:00","19:00 - 21:00"],!1);return BX.create("div",{attrs:{className:"order__accordion-form-time order__accordion-form-time--weak"},children:[BX.create("h5",{text:"Будни:"}),...e]})},initWeakendTime:function(){let e=this.initActualTime(["09:00 - 14:00","14:00 - 18:00"],!0);return BX.create("DIV",{attrs:{action:"",className:"order__accordion-form-time order__accordion-form-time--weakend"},children:[BX.create("h5",{text:"Выходные:"}),...e]})},fillPropsPopup:function(e){const t=[116,117,118,119],i=this.handleMapSelect();let s=null;this.customPropertiesHtml.forEach(((a,r)=>{if(!BX.type.isDomNode(a))return;const o=parseInt(a.getAttribute("data-property-id-row"));if(t.includes(o)){s||(s=document.createElement("div"),s.className="modal-row");const t=document.createElement("div");t.className="modal-field",t.appendChild(a),s.appendChild(t),2===s.children.length&&(BX.append(s,e),s=null)}else{const t=document.createElement("div");t.className="modal-row",t.appendChild(a),BX.append(t,e)}if(0===r){const t=document.createElement("div");t.className="modal-row",t.appendChild(i),BX.append(t,e)}})),s&&s.children.length>0&&BX.append(s,e)},initAddresPopup:function(){let e=BX("change-recipient-modal");if(!e.querySelector(".modal__overlay")){let t=BX.create("DIV",{props:{className:"modal__overlay"}});BX.append(t,e)}if(!e.querySelector(".modal__dialog")){let t=BX.create("BUTTON",{props:{className:"modal__close"},attrs:{type:"button","aria-label":"Закрыть"},html:'\n           <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1ZM15.7071 9.70711C16.0976 9.31658 16.0976 8.68342 15.7071 8.29289C15.3166 7.90237 14.6834 7.90237 14.2929 8.29289L12 10.5858L9.70711 8.29291C9.31658 7.90238 8.68342 7.90238 8.29289 8.29291C7.90237 8.68343 7.90237 9.3166 8.29289 9.70712L10.5858 12L8.2929 14.2929C7.90238 14.6834 7.90238 15.3166 8.2929 15.7071C8.68342 16.0976 9.31659 16.0976 9.70711 15.7071L12 13.4142L14.2929 15.7071C14.6834 16.0976 15.3166 16.0976 15.7071 15.7071C16.0976 15.3166 16.0976 14.6834 15.7071 14.2929L13.4142 12L15.7071 9.70711Z" fill="#090B18"></path>\n\t\t\t\t</svg>\n        '}),i=BX.create("FORM",{props:{className:"modal__dialog"},attrs:{action:"/ajax/order_save_handler.php",role:"dialog","aria-modal":"true","aria-labelledby":"change-recipient-title"},children:[t,BX.create("H2",{props:{id:"change-recipient-title",className:"modal__title"},text:"Адрес доставки"}),BX.create("DIV",{props:{className:"modal-errors"}})]});this.fillPropsPopup(i),BX.append(BX.create("DIV",{props:{className:"modal-row"},children:[BX.create("BUTTON",{attrs:{type:"button"},props:{className:"modal-btn cancel"},text:"Отменить"}),BX.create("BUTTON",{attrs:{type:"submit"},props:{className:"modal-btn save"},text:"Сохранить адрес"})]}),i),BX.append(i,e),BX.bind(document.querySelector(".modal-btn.cancel"),"click",(e=>this.handleClosePopup(e,"change-recipient-modal"))),BX.bind(document.querySelector(".modal-btn.save"),"click",(e=>this.handleOrderSave(e)))}},handleOrderSave:async function(e){e.preventDefault(),e.stopPropagation();const t=document.querySelector(".modal__dialog");try{const i=new FormData(t);i.append("userProfile",JSON.stringify(this.userProfile));const s=await fetch("/ajax/order_save_handler.php",{method:"POST",body:i});s.ok?(console.log(await s.json()),this.handleClosePopup(e,"change-recipient-modal")):console.error(`${s.status}: ${s.statusText}`)}catch(e){console.error("Error in save order:",e)}},handleCitySelect:function(){return BX.create("DIV",{props:{className:"modal-field"},children:[BX.create("LABEL",{attrs:{for:"city-select"},props:{className:"modal-label"},text:"Населённый пункт"}),BX.create("DIV",{props:{className:"custom-select-wrapper"},children:[BX.create("DIV",{props:{className:"custom-select"},text:"Екатеринбург",events:{click:function(){const e=this.parentNode,t=BX.findChild(e,{className:"custom-select-options"},!0,!1),i=BX.findChild(e,{className:"custom-select-icon"},!0,!1);BX.toggleClass(this,"open"),t&&BX.toggleClass(t,"open"),i&&BX.toggleClass(i,"rotate")}}}),BX.create("SPAN",{props:{className:"custom-select-icon"},html:'<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>'}),BX.create("DIV",{props:{className:"custom-select-options"},children:["Екатеринбург","Москва","Санкт-Петербург"].map((e=>BX.create("DIV",{props:{className:"custom-option"},text:e,events:{click:function(){const t=this.parentNode.parentNode,i=BX.findChild(t,{className:"custom-select"},!0,!1),s=BX.findChild(t,{className:"custom-select-options"},!0,!1),a=BX.findChild(t,{className:"custom-select-icon"},!0,!1);i&&BX.html(i,e),i&&BX.removeClass(i,"open"),s&&BX.removeClass(s,"open"),a&&BX.removeClass(a,"rotate")}}})))})]})]})},handleMapSelect:function(){const e=BX.create("DIV",{props:{className:"modal-field"},children:[BX.create("BUTTON",{attrs:{id:"mapButton",type:"button"},props:{className:"map-button"},text:"Указать на карте"})]});return BX.bind(e,"click",(e=>this.handleOpenPopup(e,"map-modal"))),BX.bind(document.querySelector(".modal__close"),"click",(e=>this.handleClosePopup(e,"map-modal"))),e},handlePVZItem:function(e){},editFadeDeliveryContent:function(e){var t,i,s,a,r,o=this.getSelectedDelivery(),l="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?o.NAME:o.OWN_NAME,n=this.deliveryHiddenBlockNode.querySelector("div.alert.alert-danger"),c=this.deliveryHiddenBlockNode.querySelector("div.alert.alert-warning.alert-show");if(n&&n.innerHTML?e.appendChild(n.cloneNode(!0)):this.getErrorContainer(e),c&&c.innerHTML&&e.appendChild(c.cloneNode(!0)),o&&o.NAME){if(s=(i=this.getImageSources(o,"LOGOTIP"))&&i.src_1x||this.defaultDeliveryLogo,a=[BX.create("IMG",{props:{src:s,alt:""},style:{height:"18px"}}),BX.create("STRONG",{text:l})],"Y"==this.params.DELIVERY_FADE_EXTRA_SERVICES&&BX.util.object_keys(o.EXTRA_SERVICES).length)for(r in a.push(BX.create("BR")),o.EXTRA_SERVICES)o.EXTRA_SERVICES.hasOwnProperty(r)&&(t=o.EXTRA_SERVICES[r]).value&&"N"!=t.value&&t.canUserEditValue&&(a.push(BX.create("BR")),a.push(BX.create("STRONG",{text:t.name+": "})),a.push(t.viewControl));e.appendChild(BX.create("DIV",{props:{className:"col-sm-9 bx-soa-pp-company-selected"},children:a})),e.appendChild(BX.create("DIV",{props:{className:"col-sm-3 bx-soa-pp-price"},children:this.getDeliveryPriceNodes(o)}))}else e.appendChild(BX.create("STRONG",{text:BX.message("SOA_DELIVERY_SELECT_ERROR")}));e.appendChild(BX.create("DIV",{style:{clear:"both"}})),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))},selectDelivery:function(e){if(this.orderBlockNode){var t,i,s=e.target||e.srcElement,a=BX.hasClass(s,"bx-soa-pp-company")?s:BX.findParent(s,{className:"bx-soa-pp-company"}),r=this.deliveryBlockNode.querySelector(".bx-soa-pp-company.bx-selected");if(BX.hasClass(a,"bx-selected"))return BX.PreventDefault(e);a&&(t=a.querySelector("input[type=checkbox]"),BX.addClass(a,"bx-selected"),t.checked=!0),r&&(i=r.querySelector("input[type=checkbox]"),BX.removeClass(r,"bx-selected"),i.checked=!1),this.sendRequest()}},getSelectedDelivery:function(){var e,t,i=this.deliveryBlockNode.querySelector("input[type=checkbox][name=DELIVERY_ID]:checked"),s=!1;if(i||(i=this.deliveryHiddenBlockNode.querySelector("input[type=checkbox][name=DELIVERY_ID]:checked")),i||(i=this.deliveryHiddenBlockNode.querySelector("input[type=hidden][name=DELIVERY_ID]")),i)for(t in e=i.value,this.result.DELIVERY)if(this.result.DELIVERY[t].ID==e){s=this.result.DELIVERY[t];break}return s},activatePickUp:function(e){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&(this.pickUpBlockNode.style.display="",this.pickUpBlockNode.querySelector("h2.bx-soa-section-title").innerHTML='<span class="bx-soa-section-title-count"></span>'+BX.util.htmlspecialchars(e),BX.hasClass(this.pickUpBlockNode,"bx-active")||(BX.addClass(this.pickUpBlockNode,"bx-active"),this.pickUpBlockNode.style.display=""))},deactivatePickUp:function(){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&BX.hasClass(this.pickUpBlockNode,"bx-active")&&(BX.removeClass(this.pickUpBlockNode,"bx-active"),this.pickUpBlockNode.style.display="none")},editPickUpBlock:function(e){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&BX.hasClass(this.pickUpBlockNode,"bx-active")&&this.result.DELIVERY&&(this.initialized.pickup=!1,e?this.editActivePickUpBlock(!0):this.editFadePickUpBlock(),this.initialized.pickup=!0)},editActivePickUpBlock:function(e){var t,i,s=e?this.pickUpBlockNode:this.pickUpHiddenBlockNode;this.initialized.pickup?(BX.remove(BX.lastChild(s)),s.appendChild(BX.firstChild(this.pickUpHiddenBlockNode)),"Y"===this.params.SHOW_NEAREST_PICKUP&&this.maps&&!this.maps.maxWaitTimeExpired&&(this.maps.maxWaitTimeExpired=!0,this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()),this.maps&&!this.pickUpMapFocused&&(this.pickUpMapFocused=!0,setTimeout(BX.proxy(this.maps.pickUpMapFocusWaiter,this.maps),200))):((t=s.querySelector(".bx-soa-section-content"))||(t=this.getNewContainer(),s.appendChild(t)),BX.cleanNode(t),i=BX.create("DIV",{props:{className:"col-xs-12"}}),this.editPickUpMap(i),this.editPickUpLoader(i),t.appendChild(BX.create("DIV",{props:{className:"bx_soa_pickup row"},children:[i]})),"Y"==this.params.SHOW_PICKUP_MAP&&"Y"==this.params.SHOW_NEAREST_PICKUP||(this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()),this.getBlockFooter(t))},editFadePickUpBlock:function(){var e,t=this.pickUpBlockNode.querySelector(".bx-soa-section-content");this.initialized.pickup?this.pickUpHiddenBlockNode.appendChild(t):(this.editActivePickUpBlock(!1),BX.remove(BX.lastChild(this.pickUpBlockNode))),e=this.getNewContainer(),this.pickUpBlockNode.appendChild(e),this.editFadePickUpContent(e)},editFadePickUpContent:function(e){var t,i,s=this.getSelectedPickUp(),a="";s&&("Y"==this.params.SHOW_STORES_IMAGES&&(t=this.getImageSources(s,"IMAGE_ID"),a+='<img src="'+(i=t.src_1x||this.defaultStoreLogo)+'" class="bx-soa-pickup-preview-img">'),a+="<strong>"+BX.util.htmlspecialchars(s.TITLE)+"</strong>",s.ADDRESS&&(a+="<br><strong>"+BX.message("SOA_PICKUP_ADDRESS")+":</strong> "+BX.util.htmlspecialchars(s.ADDRESS)),s.PHONE&&(a+="<br><strong>"+BX.message("SOA_PICKUP_PHONE")+":</strong> "+BX.util.htmlspecialchars(s.PHONE)),s.SCHEDULE&&(a+="<br><strong>"+BX.message("SOA_PICKUP_WORK")+":</strong> "+BX.util.htmlspecialchars(s.SCHEDULE)),s.DESCRIPTION&&(a+="<br><strong>"+BX.message("SOA_PICKUP_DESC")+":</strong> "+BX.util.htmlspecialchars(s.DESCRIPTION)),e.innerHTML=a,"Y"==this.params.SHOW_STORES_IMAGES&&BX.bind(e.querySelector(".bx-soa-pickup-preview-img"),"click",BX.delegate((function(e){this.popupShow(e,t&&t.src_orig||i)}),this)))},getPickUpInfoArray:function(e){if(!e||e.length<=0)return[];var t,i=[];for(t=0;t<e.length;t++)this.result.STORE_LIST[e[t]]&&i.push(this.result.STORE_LIST[e[t]]);return i},getSelectedPickUp:function(){var e,t,i,s=BX("BUYER_STORE"),a=this.result.STORE_LIST;if(s&&!(e=a[s.value])&&(t=this.getSelectedDelivery().STORE))for(i in t)if(t.hasOwnProperty(i)){e=a[t[i]],s.setAttribute("value",t[i]);break}return e},checkPickUpShow:function(){var e,t,i=this.getSelectedDelivery();i&&i.STORE&&i.STORE.length&&(t=this.getPickUpInfoArray(i.STORE)),t&&t.length?(e="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?i.NAME:i.OWN_NAME,i.STORE_MAIN=i.STORE,this.activatePickUp(e),this.editSection(this.pickUpBlockNode)):this.deactivatePickUp()},geoLocationSuccessCallback:function(e){var t,i=this.getSelectedDelivery();i&&i.STORE&&(t=this.getPickUpInfoArray(i.STORE)),t&&t.length>=this.options.pickUpMap.minToShowNearestBlock&&this.editPickUpRecommendList(e.geoObjects.get(0)),this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()},geoLocationFailCallback:function(){this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()},initMaps:function(){if(this.maps=BX.Sale.OrderAjaxComponent.Maps.init(this),this.maps){if(this.mapsReady=!0,this.resizeMapContainers(),"Y"===this.params.SHOW_PICKUP_MAP&&BX("pickUpMap")){var e=this.getSelectedDelivery();if(e&&e.STORE&&e.STORE.length)var t=this.getPickUpInfoArray(e.STORE);if(t&&t.length){var i=this.getSelectedPickUp();this.maps.initializePickUpMap(i),"Y"===this.params.SHOW_NEAREST_PICKUP&&this.maps.showNearestPickups(BX.proxy(this.geoLocationSuccessCallback,this),BX.proxy(this.geoLocationFailCallback,this)),this.maps.buildBalloons(t)}}if("Y"===this.params.SHOW_MAP_IN_PROPS&&BX("propsMap")){var s=this.getPropertyMapData();this.maps.initializePropsMap(s)}}},getPropertyMapData:function(){var e,t,i,s=this.options.propertyMap.defaultMapPosition;for(i in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(i)&&"Y"==(e=this.result.ORDER_PROP.properties[i]).IS_LOCATION){t=e.ID;break}if(this.locations[t]&&this.locations[t][0]&&this.locations[t][0].coordinates){e=this.locations[t][0].coordinates;var a=parseFloat(e.LONGITUDE),r=parseFloat(e.LATITUDE);isNaN(a)||isNaN(r)||0==a||0==r||(s.lon=a,s.lat=r)}return s},resizeMapContainers:function(){var e,t,i=BX("pickUpMap"),s=BX("propsMap"),a=this.propsBlockNode;a&&(i||s)&&(e=a.clientWidth,t=parseInt(e/16*9),"Y"===this.params.SHOW_PICKUP_MAP&&i&&(i.style.height=t+"px"),"Y"===this.params.SHOW_MAP_IN_PROPS&&s&&(s.style.height=t+"px"))},editPickUpMap:function(e){e.appendChild(BX.create("DIV",{props:{id:"pickUpMap"},style:{width:"100%",marginBottom:"10px"}}))},editPickUpLoader:function(e){e.appendChild(BX.create("DIV",{props:{id:"pickUpLoader",className:"text-center"},children:[BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})]}))},editPickUpList:function(e){if(this.pickUpPagination.currentPage&&this.pickUpPagination.currentPage.length){BX.remove(BX("pickUpLoader"));var t,i,s,a,r,o,l,n=BX.create("DIV",{props:{className:"bx-soa-pickup-list main"}}),c=BX("BUYER_STORE"),p=!1;if(c&&(t=c.value),(a=this.pickUpBlockNode.querySelector(".bx-soa-pickup-list.recommend"))||(a=this.pickUpHiddenBlockNode.querySelector(".bx-soa-pickup-list.recommend")),a&&a.querySelector(".bx-soa-pickup-list-item.bx-selected"))p=!0;else if((r=this.getSelectedDelivery())&&r.STORE)for(s=0;s<r.STORE.length;s++)r.STORE[s]==t&&(p=!0);for(s=0;s<this.pickUpPagination.currentPage.length;s++)(o=this.pickUpPagination.currentPage[s]).ID!=t&&0!=parseInt(t)&&p||(t=c.value=o.ID,p=!0),l=this.createPickUpItem(o,{selected:o.ID==t}),n.appendChild(l);e?((i=this.pickUpHiddenBlockNode.querySelector(".bx_soa_pickup>.col-xs-12"))||(i=this.pickUpBlockNode.querySelector(".bx_soa_pickup>.col-xs-12")),i.appendChild(BX.create("DIV",{props:{className:"bx-soa-pickup-subTitle"},html:this.params.MESS_PICKUP_LIST})),i.appendChild(n)):(i=this.pickUpBlockNode.querySelector(".bx-soa-pickup-list.main"),BX.insertAfter(n,i),BX.remove(i)),this.pickUpPagination.show&&this.showPagination("pickUp",n)}},pickUpFinalAction:function(){var e,t=this.getSelectedDelivery();t&&(e=this.lastSelectedDelivery!==parseInt(t.ID),this.lastSelectedDelivery=parseInt(t.ID)),e&&this.pickUpBlockNode.id!==this.activeSectionId&&(this.pickUpBlockNode.id!==this.activeSectionId&&this.editFadePickUpContent(BX.lastChild(this.pickUpBlockNode)),BX.removeClass(this.pickUpBlockNode,"bx-step-completed")),this.maps&&this.maps.pickUpFinalAction()},getStoreInfoHtml:function(e){var t="";return e.ADDRESS&&(t+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(e.ADDRESS)+"<br>"),e.PHONE&&(t+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(e.PHONE)+"<br>"),e.SCHEDULE&&(t+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(e.SCHEDULE)+"<br>"),e.DESCRIPTION&&(t+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(e.DESCRIPTION)+"<br>"),t},createPickUpItem:function(e,t){t=t||{};var i,s,a,r,o,l="bx-soa-pickup-l-item-detail",n="bx-soa-pickup-l-item-btn";return"Y"===this.params.SHOW_STORES_IMAGES?(s=this.getImageSources(e,"IMAGE_ID"),o=s&&s.src_1x||this.defaultStoreLogo,i=BX.create("IMG",{props:{src:o,className:"bx-soa-pickup-l-item-img"},events:{click:BX.delegate((function(e){this.popupShow(e,s&&s.src_orig||o)}),this)}})):(l+=" no-image",n+=" no-image"),a=this.getStoreInfoHtml(e),r=BX.create("DIV",{props:{className:"bx-soa-pickup-list-item",id:"store-"+e.ID},children:[BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-adress"},children:t.distance?[BX.util.htmlspecialchars(e.ADDRESS)," ( ~"+t.distance+" "+BX.message("SOA_DISTANCE_KM")+" ) "]:[BX.util.htmlspecialchars(e.ADDRESS)]}),BX.create("DIV",{props:{className:l},children:[i,BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-name"},text:e.TITLE}),BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-desc"},html:a})]}),BX.create("DIV",{props:{className:n},children:[BX.create("A",{props:{href:"",className:"btn btn-sm btn-default"},html:this.params.MESS_SELECT_PICKUP,events:{click:BX.delegate((function(e){this.selectStore(e),this.clickNextAction(e)}),this)}})]})],events:{click:BX.proxy(this.selectStore,this)}}),t.selected&&BX.addClass(r,"bx-selected"),r},editPickUpRecommendList:function(e){if(this.maps&&this.maps.canUseRecommendList()&&e){BX.remove(BX("pickUpLoader"));var t,i,s,a,r,o,l=BX.create("DIV",{props:{className:"bx-soa-pickup-list recommend"}}),n=BX("BUYER_STORE"),c=this.getSelectedDelivery(),p=this.maps.getRecommendedStoreIds(e);for(t=0;t<p.length;t++)s=p[t],i=this.getPickUpInfoArray([s])[0],0===t&&parseInt(c.ID)!==this.lastSelectedDelivery&&(n.value=parseInt(s)),a=this.maps.getDistance(e,s),r=this.createPickUpItem(i,{selected:n.value===s,distance:a}),l.appendChild(r),c.STORE_MAIN&&c.STORE_MAIN.splice(c.STORE_MAIN.indexOf(s),1);(o=this.pickUpHiddenBlockNode.querySelector(".bx_soa_pickup>.col-xs-12"))||(o=this.pickUpBlockNode.querySelector(".bx_soa_pickup>.col-xs-12")),o.appendChild(BX.create("DIV",{props:{className:"bx-soa-pickup-subTitle"},html:this.params.MESS_NEAREST_PICKUP_LIST})),o.appendChild(l)}},selectStore:function(e){var t,i,s,a,r,o,l,n,c,p=BX("BUYER_STORE");if(BX.type.isString(e)){if(!(t=BX("store-"+e))){for(a=0;a<this.pickUpPagination.pages.length;a++)for(o=this.pickUpPagination.pages[a],r=0;r<o.length;r++)if(o[r].ID==e){this.showPickUpItemsPage(++a);break}t=BX("store-"+e)}}else l=e.target||e.srcElement,t=BX.hasClass(l,"bx-soa-pickup-list-item")?l:BX.findParent(l,{className:"bx-soa-pickup-list-item"});if(t&&p){if(BX.hasClass(t,"bx-selected"))return;i=this.pickUpBlockNode.querySelector(".bx-selected"),s=t.id.substr(6),BX.removeClass(i,"bx-selected"),n=t.clientHeight,t.style.overflow="hidden",BX.addClass(t,"bx-selected"),c=t.clientHeight,t.style.height=n+"px",new BX.easing({duration:300,start:{height:n,opacity:0},finish:{height:c,opacity:100},transition:BX.easing.transitions.quad,step:function(e){t.style.height=e.height+"px"},complete:function(){t.removeAttribute("style")}}).animate(),p.setAttribute("value",s),this.maps&&this.maps.selectBalloon(s)}},getDeliverySortedArray:function(e){var t,i=[],s=[],a=function(e,t){var i=parseInt(e.SORT)-parseInt(t.SORT);return 0===i?e.OWN_NAME.toLowerCase()>t.OWN_NAME.toLowerCase()?1:e.OWN_NAME.toLowerCase()<t.OWN_NAME.toLowerCase()?-1:0:i};for(t in e)e.hasOwnProperty(t)&&("L"===this.params.SHOW_NOT_CALCULATED_DELIVERIES&&e[t].CALCULATE_ERRORS?s.push(e[t]):i.push(e[t]));return i.sort(a),s.sort(a),i.concat(s)},editPropsBlock:function(e){this.propsBlockNode&&this.propsHiddenBlockNode&&this.result.ORDER_PROP&&(e?this.editActivePropsBlock(!0):this.editFadePropsBlock(),this.initialized.props=!0)},editActivePropsBlock:function(e){var t,i,s,a,r=e?this.propsBlockNode:this.propsHiddenBlockNode,o=!1;if(this.initialized.props)BX.remove(BX.lastChild(r)),r.appendChild(BX.firstChild(this.propsHiddenBlockNode)),this.maps&&setTimeout(BX.proxy(this.maps.propsMapFocusWaiter,this.maps),200);else{if((t=r.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),r.appendChild(t)),this.getErrorContainer(t),i=BX.create("DIV",{props:{className:"row"}}),(s=this.getSelectedDelivery())&&"Y"===this.params.SHOW_MAP_IN_PROPS&&this.params.SHOW_MAP_FOR_DELIVERIES&&this.params.SHOW_MAP_FOR_DELIVERIES.length)for(a=0;a<this.params.SHOW_MAP_FOR_DELIVERIES.length;a++)if(parseInt(s.ID)===parseInt(this.params.SHOW_MAP_FOR_DELIVERIES[a])){o=!0;break}this.editPropsItems(i),o&&this.editPropsMap(i),t.appendChild(i),this.getBlockFooter(t),"true"===this.propsBlockNode.getAttribute("data-visited")&&(this.isValidPropertiesBlock(!0).length?BX.addClass(this.propsBlockNode,"bx-step-error"):BX.removeClass(this.propsBlockNode,"bx-step-error"))}},editFadePropsBlock:function(){var e,t=this.propsBlockNode.querySelector(".bx-soa-section-content");this.initialized.props?this.propsHiddenBlockNode.appendChild(t):(this.editActivePropsBlock(!1),BX.remove(BX.lastChild(this.propsBlockNode))),e=this.getNewContainer(),this.propsBlockNode.appendChild(e),this.editFadePropsContent(e)},editFadePropsContent:function(e){if(e&&this.locationsInitialized){var t,i,s,a,r,o,l,n,c=this.propsHiddenBlockNode.querySelector(".alert"),p=this.getSelectedPersonType();if(BX.cleanNode(e),c&&e.appendChild(c.cloneNode(!0)),p&&(t="PROPS_FADE_LIST_"+p.ID,i=this.params[t]),i&&0!==i.length)for(r=this.fadedPropertyCollection.getGroupIterator();s=r();)for(o=s.getIterator();a=o();)for(l=0;l<i.length;l++)i[l]==a.getId()&&"Y"!=a.getSettings().IS_ZIP&&this.getPropertyRowNode(a,e,!0);else e.innerHTML+="<strong>"+BX.message("SOA_ORDER_PROPS")+"</strong>";"true"===this.propsBlockNode.getAttribute("data-visited")&&(n=this.isValidPropertiesBlock()).length&&this.showError(this.propsBlockNode,n),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))}},editPropsItems:function(e){if(!this.result.ORDER_PROP||!this.propertyCollection)return;var t,i,s,a=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-customer"}}),r=this.propertyCollection.getGroupIterator(),o=BX.create("DIV",{props:{className:"bx-soa-customer__wrapper"}});this.changeUserData=BX.create("BUTTON",{props:{className:"change-field change__recipient__btn-none-modal md:hidden bg-[#F2F3F5] text-[12px]"},attrs:{type:"button"},text:"Изменить получателя"});const l=BX.create("DIV",{props:{className:"order__content-form"},children:[BX.create("LABEL",{props:{className:"order__content-form-label",htmlFor:"r1"},children:[BX.create("INPUT",{attrs:{id:"r1",type:"radio",name:"radd1"}}),BX.create("DIV",{props:{className:"order__content-form-decor"}}),BX.create("P",{props:{className:"order__content-form-text"},text:"Оповещения через СМС"})]}),BX.create("LABEL",{props:{className:"order__content-form-label",htmlFor:"r2"},children:[BX.create("INPUT",{attrs:{id:"r2",type:"radio",name:"radd1"}}),BX.create("DIV",{props:{className:"order__content-form-decor"}}),BX.create("P",{props:{className:"order__content-form-text"},text:"Подтвердить через Whatsapp"})]}),BX.create("LABEL",{props:{className:"order__content-form-label",htmlFor:"r3"},children:[BX.create("INPUT",{attrs:{id:"r3",type:"radio",name:"radd1"}}),BX.create("DIV",{props:{className:"order__content-form-decor"}}),BX.create("P",{props:{className:"order__content-form-text"},text:"Звонок от менеджера"})]})]});for(a||(a=this.propsBlockNode.querySelector(".col-sm-12.bx-soa-customer"));t=r();)for(s=t.getIterator();i=s();)this.deliveryLocationInfo.loc!=i.getId()&&this.deliveryLocationInfo.zip!=i.getId()&&this.deliveryLocationInfo.city!=i.getId()&&this.getPropertyRowNode(i,o,!1);this.customProperties.length>0&&this.insertCustomProperty(),o.appendChild(this.changeUserData),a.appendChild(o),a.appendChild(l),e.appendChild(a),this.changeUserFields(o)},changeUserFields:function(e){let t=e.querySelectorAll("input[type=text]");this.changeUserData?BX.bind(this.changeUserData,"click",(function(e){e.preventDefault(),e.stopPropagation();for(let e=0;e<t.length;e++)t[e].hasAttribute("disabled")?(t[e].removeAttribute("disabled"),this.innerHTML="Cохранить"):(t[e].setAttribute("disabled",""),this.innerHTML="Изменить получателя")})):console.error("Edit button is not declared")},setPropertyContainers:function(e,t,i){this.customProperties.push({container:e,property:t,disabled:i})},getPropertyRowNode:function(e,t,i){var s,a=BX.create("DIV"),r="",o=e.getType()||"",l=e.getDescription()||"";if(i)a.innerHTML="<strong>"+BX.util.htmlspecialchars(e.getName())+":</strong> ";else if(BX.addClass(a,"form-group bx-soa-customer-field"),r+=BX.util.htmlspecialchars(e.getName()),e.isRequired()&&(r+=' <span class="bx-authform-starrequired">*</span>'),l.length&&"STRING"!=o&&"NUMBER"!=o&&"DATE"!=o&&(r+=" <small>("+BX.util.htmlspecialchars(l)+")</small>"),s=BX.create("LABEL",{attrs:{for:"soa-property-"+e.getId()},props:{className:"bx-soa-custom-label"},html:r}),a.setAttribute("data-property-id-row",e.getId()),a.appendChild(s),![31,32,33].includes(parseInt(e.getId())))return this.setPropertyContainers(a,e,i),void BX.addClass(s,"modal-label");switch(o){case"LOCATION":this.insertLocationProperty(e,a,i);break;case"DATE":this.insertDateProperty(e,a,i);break;case"FILE":this.insertFileProperty(e,a,i);break;case"STRING":this.insertStringProperty(e,a,i);break;case"ENUM":this.insertEnumProperty(e,a,i);break;case"Y/N":this.insertYNProperty(e,a,i);break;case"NUMBER":this.insertNumberProperty(e,a,i)}38!=e.getId()&&t.appendChild(a)},insertLocationProperty:function(e,t,i){var s,a,r,o,l,n,c,p,h=[];if(e.getId()in this.locations)if(i){if(s=this.propsHiddenBlockNode.querySelector('[data-property-id-row="'+e.getId()+'"]'))for(a=s.querySelectorAll("div.bx-soa-loc"),c=0;c<a.length;c++)r=this.getLocationString(a[c]),h.push(r.length?BX.util.htmlspecialchars(r):BX.message("SOA_NOT_SELECTED"));t.innerHTML+=h.join("<br>")}else{for(n=BX.create("DIV",{props:{className:"soa-property-container"}}),s=this.locations[e.getId()],c=0;c<s.length;c++)for(p in o=s[c]?s[c].output:{},l=BX.create("DIV",{props:{className:"bx-soa-loc"},html:o.HTML}),e.isMultiple()&&(l.style.marginBottom="search"==this.locationsTemplate?"5px":"20px"),n.appendChild(l),o.SCRIPT)o.SCRIPT.hasOwnProperty(p)&&BX.evalGlobal(o.SCRIPT[p].JS);e.isMultiple()&&n.appendChild(BX.create("DIV",{attrs:{"data-prop-id":e.getId()},props:{className:"btn btn-sm btn-default"},text:BX.message("ADD_DEFAULT"),events:{click:BX.proxy(this.addLocationProperty,this)}})),t.appendChild(n)}},addLocationProperty:function(e){var t,i,s,a=e.target||e.srcElement,r=a.getAttribute("data-prop-id"),o=BX.previousSibling(a),l=0,n="sls-",c=BX.util.getRandomString(5);if(BX.hasClass(o,"bx-soa-loc")&&("search"==this.locationsTemplate?(s=o.querySelector("input[type=text][class=dropdown-field]"))&&(l=parseInt(s.name.substring(s.name.indexOf("[")+1,s.name.indexOf("]")))+1):(s=o.querySelectorAll("input[type=hidden]")).length&&(s=s[s.length-1],l=parseInt(s.name.substring(s.name.indexOf("[")+1,s.name.indexOf("]")))+1)),this.cleanLocations[r]){for(i in t=BX.create("DIV",{props:{className:"bx-soa-loc"},style:{marginBottom:"search"==this.locationsTemplate?"5px":"20px"},html:this.cleanLocations[r].HTML.split("#key#").join(l).replace(/sls-\d{5}/g,n+c)}),a.parentNode.insertBefore(t,a),BX.saleOrderAjax.addPropertyDesc({id:r+"_"+l,attributes:{id:r+"_"+l,type:"LOCATION",valueSource:"form"}}),this.cleanLocations[r].SCRIPT)this.cleanLocations[r].SCRIPT.hasOwnProperty(i)&&BX.evalGlobal(this.cleanLocations[r].SCRIPT[i].JS.split("_key__").join("_"+l).replace(/sls-\d{5}/g,n+c));BX.saleOrderAjax.initDeferredControl()}},insertDateProperty:function(e,t,i){var s,a,r,o,l,n;if(i){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(r=[],a=s.querySelectorAll("input[type=text]"),o=0;o<a.length;o++)a[o].value&&a[o].value.length&&r.push(a[o].value);t.innerHTML+=this.valuesToString(r)}}else{for(l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),n=l.querySelectorAll("input[type=text]"),o=0;o<n.length;o++)this.alterDateProperty(e.getSettings(),n[o]);this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)}},insertFileProperty:function(e,t,i){var s,a,r,o,l,n,c;if(i){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(r=[],a=s.querySelectorAll("a"),o=0;o<a.length;o++)(l=a[o].innerHTML).length&&r.push(l);t.innerHTML+=this.valuesToString(r)}}else(n=this.savedFilesBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]'))&&(c=n.querySelector("div.soa-property-container")),c?t.appendChild(c):(c=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(c),t.appendChild(c),this.alterProperty(e.getSettings(),c))},insertCustomProperty:function(){let e,t;for(let i=0;i<this.customProperties.length;i++){const{container:s,property:a,disabled:r}=this.customProperties[i];if(r){if(prop=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+a.getId()+'"]'),prop){if(values=[],inputs=prop.querySelectorAll("input[type=text]"),0==inputs.length&&(inputs=prop.querySelectorAll("textarea")),inputs.length)for(i=0;i<inputs.length;i++)inputs[i].value.length&&values.push(inputs[i].value);s.innerHTML+=this.valuesToString(values)}}else{switch(e=BX.create("DIV",{props:{className:"soa-property-container"}}),a.appendTo(e),parseInt(a.getId())){case 38:case 115:t=BX.create("UL",{attrs:{id:`soa-property-${a.getId()}-suggestions`},props:{className:"suggestions-list"}}),e.appendChild(t)}s.appendChild(e),this.alterProperty(a.getSettings(),e),this.bindValidation(a.getId(),e)}this.customPropertiesHtml.push(s)}},insertStringProperty:function(e,t,i){var s,a,r,o,l;if(i){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){if(r=[],0==(a=s.querySelectorAll("input[type=text]")).length&&(a=s.querySelectorAll("textarea")),a.length)for(o=0;o<a.length;o++)a[o].value.length&&r.push(a[o].value);t.innerHTML+=this.valuesToString(r)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)},insertEnumProperty:function(e,t,i){var s,a,r,o,l;if(i){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){if(r=[],(a=s.querySelectorAll("input[type=radio]")).length)for(o=0;o<a.length;o++)a[o].checked&&r.push(a[o].nextSibling.nodeValue);if((a=s.querySelectorAll("option")).length)for(o=0;o<a.length;o++)a[o].selected&&r.push(a[o].innerHTML);t.innerHTML+=this.valuesToString(r)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.bindValidation(e.getId(),l)},insertYNProperty:function(e,t,i){var s,a,r,o,l;if(i){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(r=[],a=s.querySelectorAll("input[type=checkbox]"),o=0;o<a.length;o+=2)r.push(a[o].checked?BX.message("SOA_YES"):BX.message("SOA_NO"));t.innerHTML+=this.valuesToString(r)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)},insertNumberProperty:function(e,t,i){var s,a,r,o,l;if(i){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(r=[],a=s.querySelectorAll("input[type=text]"),o=0;o<a.length;o++)a[o].value.length&&r.push(a[o].value);t.innerHTML+=this.valuesToString(r)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)},valuesToString:function(e){var t=e.join(", ");return t.length?BX.util.htmlspecialchars(t):BX.message("SOA_NOT_SELECTED")},alterProperty:function(e,t){var i,s,a,r,o,l,n,c,p=BX.findChildren(t,{tagName:"DIV"});if(p&&p.length)for(i=0;i<p.length;i++)p[i].style.margin="5px 0";for((s=t.querySelector("input[type=text]"))||(s=t.querySelector("textarea")),s&&(s.id="soa-property-"+e.ID,"Y"==e.IS_ADDRESS&&s.setAttribute("autocomplete","address"),"Y"==e.IS_EMAIL&&s.setAttribute("autocomplete","email"),"Y"==e.IS_PAYER&&s.setAttribute("autocomplete","name"),"Y"==e.IS_PHONE&&s.setAttribute("autocomplete","tel"),e.PATTERN&&e.PATTERN.length&&s.removeAttribute("pattern")),a=t.querySelectorAll("input[type=text]"),i=0;i<a.length;i++)a[i].placeholder=e.DESCRIPTION,BX.addClass(a[i],"form-control bx-soa-customer-input bx-ios-fix");for(a=t.querySelectorAll("select"),i=0;i<a.length;i++)BX.addClass(a[i],"form-control");for(a=t.querySelectorAll("textarea"),i=0;i<a.length;i++)a[i].placeholder=e.DESCRIPTION,BX.addClass(a[i],"form-control bx-ios-fix");for([31,32,33].includes(parseInt(e.ID))?s.setAttribute("disabled",!0):(BX.addClass(s,"modal-input"),BX.removeClass(s,"form-control")),r=t.querySelectorAll("label"),i=0;i<r.length;i++)BX.remove(r[i]);if("FILE"==e.TYPE){if(e.ACCEPT&&e.ACCEPT.length)for(l=t.querySelectorAll("input[type=file]"),n=this.getFileAccepts(e.ACCEPT),i=0;i<l.length;i++)l[i].setAttribute("accept",n);for(c=t.querySelectorAll("a"),i=0;i<c.length;i++)BX.bind(c[i],"click",(function(e){var t=e.target||e.srcElement,i=t&&t.nextSibling&&t.nextSibling.nextSibling;i&&BX.fireEvent(i,"change")}))}for(o=t.querySelectorAll("input[type=button]"),i=0;i<o.length;i++)BX.addClass(o[i],"btn btn-default btn-sm"),"Y"==e.MULTIPLE&&i==o.length-1||"FILE"==e.TYPE&&(BX.prepend(o[i],o[i].parentNode),o[i].style.marginRight="10px");o.length&&(o=o[o.length-1],BX.bind(o,"click",BX.delegate((function(i){var s,a,r,o,l=i.target||i.srcElement,n=BX.findParent(l,{tagName:"div",className:"soa-property-container"}),c=n.querySelector("label"),p=n.querySelectorAll("input[type=button]"),h=n.querySelectorAll("input[type=text]"),d=n.querySelectorAll("textarea"),u=BX.findChildren(n,{tagName:"DIV"});if(u&&u.length)for(s=0;s<u.length;s++)u[s].style.margin="5px 0";if(this.bindValidation(e.ID,n),p.length&&p[p.length-2]&&(BX.prepend(p[p.length-2],p[p.length-2].parentNode),p[p.length-2].style.marginRight="10px",BX.addClass(p[p.length-2],"btn btn-default btn-sm")),c&&BX.remove(c),h.length&&(h[h.length-1].placeholder=e.DESCRIPTION,BX.addClass(h[h.length-1],"form-control bx-soa-customer-input bx-ios-fix"),"DATE"==e.TYPE&&this.alterDateProperty(e,h[h.length-1]),e.PATTERN&&e.PATTERN.length&&h[h.length-1].removeAttribute("pattern")),d.length&&(d[d.length-1].placeholder=e.DESCRIPTION,BX.addClass(d[d.length-1],"form-control bx-ios-fix")),"FILE"==e.TYPE){if(e.ACCEPT&&e.ACCEPT.length)for(r=t.querySelectorAll("input[type=file]"),o=this.getFileAccepts(e.ACCEPT),s=0;s<r.length;s++)r[s].setAttribute("accept",o);a=n.querySelectorAll("a"),BX.bind(a[a.length-1],"click",(function(e){var t=e.target||e.srcElement,i=t&&t.nextSibling&&t.nextSibling.nextSibling;i&&setTimeout((function(){BX.fireEvent(i,"change")}),10)}))}}),this)))},alterDateProperty:function(e,t){var i,s=BX.findParent(t,{tagName:"DIV"});BX.addClass(s,"input-group"),i=BX.create("DIV",{props:{className:"input-group-addon"},children:[BX.create("I",{props:{className:"bx-calendar"}})]}),BX.insertAfter(i,t),BX.remove(s.querySelector("input[type=button]")),BX.bind(i,"click",BX.delegate((function(t){var i=t.target||t.srcElement,s=BX.findParent(i,{tagName:"DIV",className:"input-group"});BX.calendar({node:s.querySelector(".input-group-addon"),field:s.querySelector("input[type=text]").name,form:"",bTime:"Y"==e.TIME,bHideTime:!1})}),this))},isValidForm:function(){if(!this.options.propertyValidation)return!0;var e,t,i=this.isValidRegionBlock(),s=this.isValidPropertiesBlock(),a=!1;if(i.length&&(a=!0,this.animateScrollTo(this.regionBlockNode,800,50)),s.length&&!a)if(this.activeSectionId==this.propsBlockNode.id){for(e=this.propsBlockNode.querySelectorAll("div.tooltip"),t=0;t<e.length;t++)if("opened"==e[t].getAttribute("data-state")){this.animateScrollTo(BX.findParent(e[t],{className:"form-group bx-soa-customer-field"}),800,50);break}}else this.animateScrollTo(this.propsBlockNode,800,50);return i.length&&(this.showError(this.regionBlockNode,i),BX.addClass(this.regionBlockNode,"bx-step-error")),s.length&&(this.activeSectionId!==this.propsBlockNode.id&&this.showError(this.propsBlockNode,s),BX.addClass(this.propsBlockNode,"bx-step-error")),!(i.length+s.length)},isValidRegionBlock:function(){if(!this.options.propertyValidation)return[];var e,t,i,s,a=this.orderBlockNode.querySelectorAll(".bx-soa-location-input-container[data-property-id-row]"),r=[];for(s=0;s<a.length;s++)e=a[s].getAttribute("data-property-id-row"),t=this.validation.properties[e],i=this.getValidationData(t,a[s]),r=r.concat(this.isValidProperty(i,!0));return r},isValidPropertiesBlock:function(e){if(!this.options.propertyValidation)return[];var t,i,s,a,r,o=document.querySelectorAll(".bx-soa-customer-field[data-property-id-row]"),l=[];for(r=0;r<o.length;r++)t=o[r].getAttribute("data-property-id-row"),e&&this.locations[t]||(i=o[r].querySelector(".soa-property-container"))&&(s=this.validation.properties[t],a=this.getValidationData(s,i),l=l.concat(this.isValidProperty(a,!0)));return l},isValidProperty:function(e,t){var i,s,a=[];if(!e||!e.inputs)return a;for(s=0;s<e.inputs.length;s++)(i=e.func(e.inputs[s],!!t)).length&&(a[s]=i.join("<br>"));return this.showValidationResult(e.inputs,a),a},bindValidation:function(e,t){if(this.validation.properties&&this.validation.properties[e]){var i,s,a=this.validation.properties[e],r=this.getValidationData(a,t);if(r&&r.inputs&&r.action)for(i=0;i<r.inputs.length;i++)if(BX.type.isElementNode(r.inputs[i]))BX.bind(r.inputs[i],r.action,BX.delegate((function(){this.isValidProperty(r)}),this));else for(s=0;s<r.inputs[i].length;s++)BX.bind(r.inputs[i][s],r.action,BX.delegate((function(){this.isValidProperty(r)}),this))}},getValidationData:function(e,t){if(e&&t){var i,s={};switch(e.TYPE){case"STRING":if(s.action="change",s.func=BX.delegate((function(t,i){return this.validateString(t,e,i)}),this),(i=t.querySelectorAll("input[type=text]")).length){s.inputs=i;break}(i=t.querySelectorAll("textarea")).length&&(s.inputs=i);break;case"LOCATION":if(s.func=BX.delegate((function(t,i){return this.validateLocation(t,e,i)}),this),(i=t.querySelectorAll("input.bx-ui-sls-fake[type=text]")).length){s.inputs=i,s.action="keyup";break}(i=t.querySelectorAll("div.bx-ui-slst-pool")).length&&(s.inputs=i);break;case"Y/N":s.inputs=t.querySelectorAll("input[type=checkbox]"),s.action="change",s.func=BX.delegate((function(t,i){return this.validateCheckbox(t,e,i)}),this);break;case"NUMBER":s.inputs=t.querySelectorAll("input[type=text]"),s.action="blur",s.func=BX.delegate((function(t,i){return this.validateNumber(t,e,i)}),this);break;case"ENUM":if((i=t.querySelectorAll("input[type=radio]")).length||(i=t.querySelectorAll("input[type=checkbox]")),i.length){s.inputs=[i],s.action="change",s.func=BX.delegate((function(t,i){return this.validateEnum(t,e,i)}),this);break}(i=t.querySelectorAll("option")).length&&(s.inputs=[i],s.action="click",s.func=BX.delegate((function(t,i){return this.validateSelect(t,e,i)}),this));break;case"FILE":s.inputs=t.querySelectorAll("input[type=file]"),s.action="change",s.func=BX.delegate((function(t,i){return this.validateFile(t,e,i)}),this);break;case"DATE":s.inputs=t.querySelectorAll("input[type=text]"),s.action="change",s.func=BX.delegate((function(t,i){return this.validateDate(t,e,i)}),this)}return s}},showErrorTooltip:function(e,t,i){if(e&&t&&i){var s,a,r=BX("tooltip-"+e);i=this.uniqueText(i,"<br>"),r?s=r.querySelector("div.tooltip-inner"):(s=BX.create("DIV",{props:{className:"tooltip-inner"}}),r=BX.create("DIV",{props:{id:"tooltip-"+e,className:"bx-soa-tooltip bx-soa-tooltip-static bx-soa-tooltip-danger tooltip top"},children:[BX.create("DIV",{props:{className:"tooltip-arrow"}}),s]}),(a=t.parentNode.querySelector("div.quick-locations"))&&(t=a),BX.insertAfter(r,t)),s.innerHTML=i,"opened"!=r.getAttribute("data-state")&&(r.setAttribute("data-state","opened"),r.style.opacity=0,r.style.display="block",new BX.easing({duration:150,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.quad,step:function(e){r.style.opacity=e.opacity/100}}).animate())}},closeErrorTooltip:function(e){var t=BX("tooltip-"+e);t&&(t.setAttribute("data-state","closed"),new BX.easing({duration:150,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.quad,step:function(e){t.style.opacity=e.opacity/100},complete:function(){t.style.display="none"}}).animate())},showValidationResult:function(e,t){if(e&&e.length&&t){var i,s,a,r=BX.type.isElementNode(e[0])?e[0]:e[0][0],o=BX.findParent(r,{tagName:"DIV",className:"form-group"}).querySelector("label");for(o&&(i=o.getAttribute("for")),a=0;a<e.length;a++)s=BX.findParent(e[a],{tagName:"DIV",className:"form-group"}),t[a]&&t[a].length?BX.addClass(s,"has-error"):BX.removeClass(s,"has-error");t.length?this.showErrorTooltip(i,o,t.join("<br>")):this.closeErrorTooltip(i)}},validateString:function(e,t,i){if(!e||!t)return[];var s=e.value,a=[],r=BX.util.htmlspecialchars(t.NAME);return"Y"===t.MULTIPLE||("Y"===t.REQUIRED&&0===s.length&&a.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":r}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),s.length&&(t.MINLENGTH&&t.MINLENGTH>s.length&&a.push(BX.Loc.getMessage("SOA_MIN_LENGTH_FIELD_WITH_NAME",{"#NAME#":r,"#LENGTH#":t.MINLENGTH})),t.MAXLENGTH&&t.MAXLENGTH<s.length&&a.push(BX.Loc.getMessage("SOA_MAX_LENGTH_FIELD_WITH_NAME",{"#NAME#":r,"#LENGTH#":t.MAXLENGTH})),"Y"===t.IS_EMAIL&&(e.value=s=BX.util.trim(s),s.length&&(/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(s)||a.push(BX.Loc.getMessage("SOA_INVALID_EMAIL")))),s.length>0&&t.PATTERN&&t.PATTERN.length&&(new RegExp(t.PATTERN).test(s)||a.push(i?BX.Loc.getMessage("SOA_INVALID_PATTERN_FIELD_WITH_NAME",{"#NAME#":r}):BX.Loc.getMessage("SOA_INVALID_PATTERN_FIELD"))))),a},validateLocation:function(e,t,i){if(!e||!t)return[];var s=BX.findParent(e,{tagName:"DIV",className:"form-group"}),a=this.getLocationString(s),r=[];return"Y"===t.MULTIPLE&&"Y"!==t.IS_LOCATION||"Y"!==t.REQUIRED||0!==a.length&&a!==BX.Loc.getMessage("SOA_NOT_SPECIFIED")||r.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":BX.util.htmlspecialchars(t.NAME)}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),r},validateCheckbox:function(e,t,i){if(!e||!t)return[];var s=[];return"Y"===t.MULTIPLE||"Y"!==t.REQUIRED||e.checked||s.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":BX.util.htmlspecialchars(t.NAME)}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),s},validateNumber:function(e,t,i){if(!e||!t)return[];var s=e.value,a=[],r=BX.util.htmlspecialchars(t.NAME);if("Y"===t.MULTIPLE)return a;if("Y"===t.REQUIRED&&0===s.length&&a.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":r}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),s.length&&(/[0-9]|\./.test(s)||a.push(i?BX.Loc.getMessage("SOA_NOT_NUMERIC_FIELD_WITH_TITLE",{"#NAME#":r}):BX.Loc.getMessage("SOA_NOT_NUMERIC_FIELD")),t.MIN&&parseFloat(t.MIN)>parseFloat(s)&&a.push(BX.Loc.getMessage("SOA_MIN_VALUE_FIELD_WITH_NAME",{"#NAME#":r,"#VALUE#":parseFloat(t.MIN)})),t.MAX&&parseFloat(t.MAX)<parseFloat(s)&&a.push(BX.Loc.getMessage("SOA_MAX_VALUE_FIELD_WITH_NAME",{"#NAME#":r,"#VALUE#":parseFloat(t.MAX)})),t.STEP&&parseFloat(t.STEP)>0)){var o=(Math.abs(parseFloat(s)-(t.MIN&&parseFloat(t.MIN)>0?parseFloat(t.MIN):0))/parseFloat(t.STEP)).toPrecision(12);o!==parseInt(o)&&a.push(i?BX.Loc.getMessage("SOA_NUM_STEP_FIELD_WITH_NAME",{"#NAME#":r,"#STEP#":t.STEP}):BX.Loc.getMessage("SOA_NUM_STEP_FIELD",{"#STEP#":t.STEP}))}return a},validateEnum:function(e,t,i){if(!e||!t)return[];var s=[],a=[];if("Y"===t.MULTIPLE)return a;for(var r=0;r<e.length;r++)(e[r].checked||e[r].selected)&&s.push(r);return"Y"===t.REQUIRED&&0===s.length&&a.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":BX.util.htmlspecialchars(t.NAME)}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),a},validateSelect:function(e,t,i){if(!e||!t)return[];var s=[],a=[];if("Y"===t.MULTIPLE)return a;for(var r=0;r<e.length;r++)e[r].selected&&s.push(r);return"Y"===t.REQUIRED&&0===s.length&&a.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":BX.util.htmlspecialchars(t.NAME)}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),a},validateFile:function(e,t,i){if(!e||!t)return[];var s=[],a=e.files||[],r=e.previousSibling.value;if("Y"===t.MULTIPLE)return s;if("Y"!==t.REQUIRED||0!==a.length||""!==r||t.DEFAULT_VALUE&&t.DEFAULT_VALUE.length)for(var o of a){var l=BX.util.htmlspecialchars(o.name),n=o.name.split("."),c=n.length>1?n[n.length-1].toLowerCase():"";t.ACCEPT.length>0&&(0===c.length||"-1"===t.ACCEPT.indexOf(c))&&s.push(BX.Loc.getMessage("SOA_BAD_EXTENSION_NAME_AND_ACCEPT",{"#NAME#":l,"#ACCEPT#":BX.util.htmlspecialchars(t.ACCEPT)})),o.size>parseInt(t.MAXSIZE)&&s.push(BX.Loc.getMessage("SOA_MAX_SIZE_NAME_AND_SIZE",{"#NAME#":l,"#SIZE#":this.getSizeString(t.MAXSIZE,1)}))}else s.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":BX.util.htmlspecialchars(t.NAME)}):BX.Loc.getMessage("SOA_REQUIRED_FIELD"));return s},validateDate:function(e,t,i){if(!e||!t)return[];var s=e.value,a=[];return"Y"===t.MULTIPLE||"Y"===t.REQUIRED&&0===s.length&&a.push(i?BX.Loc.getMessage("SOA_REQUIRED_FIELD_WITH_NAME",{"#NAME#":BX.util.htmlspecialchars(t.NAME)}):BX.Loc.getMessage("SOA_REQUIRED_FIELD")),a},editPropsMap:function(e){var t=BX.create("DIV",{props:{className:"col-sm-12"},style:{marginBottom:"10px"}}),i=BX.create("DIV",{props:{id:"propsMap"},style:{width:"100%"}});t.appendChild(i),e.appendChild(t)},editPropsComment:function(e){var t,i,s,a;t=BX.create("DIV",{props:{className:"col-sm-12"}}),i=BX.create("LABEL",{attrs:{for:"orderDescription"},props:{className:"bx-soa-customer-label"},html:this.params.MESS_ORDER_DESC}),s=BX.create("TEXTAREA",{props:{id:"orderDescription",cols:"4",className:"form-control bx-soa-customer-textarea bx-ios-fix",name:"ORDER_DESCRIPTION"},text:this.result.ORDER_DESCRIPTION?this.result.ORDER_DESCRIPTION:""}),a=BX.create("DIV",{props:{className:"form-group bx-soa-customer-field"},children:[i,s]}),t.appendChild(a),e.appendChild(t)},editTotalBlock:function(){if(this.totalInfoBlockNode&&this.result.TOTAL){var e,t,i,s,a,r,o,l=this.result.TOTAL,n={},c="Y"===this.params.SHOW_TOTAL_ORDER_BUTTON;if(BX.cleanNode(this.totalInfoBlockNode),0===parseFloat(l.ORDER_PRICE)?(e=this.params.MESS_PRICE_FREE,n.free=!0):e=l.ORDER_PRICE_FORMATED,this.options.showPriceWithoutDiscount&&(e+='<br><span class="bx-price-old">'+l.PRICE_WITHOUT_DISCOUNT+"</span>"),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_SUMMARY"),e,n)),this.options.showOrderWeight&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_WEIGHT_SUM"),l.ORDER_WEIGHT_FORMATED)),this.options.showTaxList)for(s=0;s<l.TAX_LIST.length;s++)i=l.TAX_LIST[s].VALUE_MONEY_FORMATED||"",this.totalInfoBlockNode.appendChild(this.createTotalUnit(l.TAX_LIST[s].NAME+(l.TAX_LIST[s].VALUE_FORMATED?" "+l.TAX_LIST[s].VALUE_FORMATED:"")+":",i));n={},(r=(a=this.getSelectedDelivery())&&a.CALCULATE_ERRORS&&a.CALCULATE_ERRORS.length)?(o=BX.message("SOA_NOT_CALCULATED"),n.error=r):(0===parseFloat(l.DELIVERY_PRICE)?(o=this.params.MESS_PRICE_FREE,n.free=!0):o=l.DELIVERY_PRICE_FORMATED,a&&void 0!==a.DELIVERY_DISCOUNT_PRICE&&parseFloat(a.PRICE)>parseFloat(a.DELIVERY_DISCOUNT_PRICE)&&(o+='<br><span class="bx-price-old">'+a.PRICE_FORMATED+"</span>")),this.result.DELIVERY.length&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_DELIVERY"),o,n)),this.options.showDiscountPrice&&(t=this.params.MESS_ECONOMY,l.DISCOUNT_PERCENT_FORMATED&&parseFloat(l.DISCOUNT_PERCENT_FORMATED)>0&&(t+=l.DISCOUNT_PERCENT_FORMATED),this.totalInfoBlockNode.appendChild(this.createTotalUnit(t+":",l.DISCOUNT_PRICE_FORMATED,{highlighted:!0}))),this.options.showPayedFromInnerBudget?(this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_IT"),l.ORDER_TOTAL_PRICE_FORMATED)),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_PAYED"),l.PAYED_FROM_ACCOUNT_FORMATED)),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_LEFT_TO_PAY"),l.ORDER_TOTAL_LEFT_TO_PAY_FORMATED,{total:!0}))):this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_IT"),l.ORDER_TOTAL_PRICE_FORMATED,{total:!0})),parseFloat(l.PAY_SYSTEM_PRICE)>=0&&this.result.DELIVERY.length&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_PAYSYSTEM_PRICE"),"~"+l.PAY_SYSTEM_PRICE_FORMATTED)),this.result.SHOW_AUTH||this.totalInfoBlockNode.appendChild(BX.create("DIV",{props:{className:"bx-soa-cart-total-button-container"+(c?"":" visible-xs")},children:[BX.create("A",{props:{href:"javascript:void(0)",className:"btn btn-default btn-lg btn-order-save"},html:this.params.MESS_ORDER,events:{click:BX.proxy(this.clickOrderSaveAction,this)}})]})),this.editMobileTotalBlock()}},editMobileTotalBlock:function(){this.result.SHOW_AUTH?BX.removeClass(this.mobileTotalBlockNode,"visible-xs"):BX.addClass(this.mobileTotalBlockNode,"visible-xs"),BX.cleanNode(this.mobileTotalBlockNode),this.mobileTotalBlockNode.appendChild(this.totalInfoBlockNode.cloneNode(!0)),BX.bind(this.mobileTotalBlockNode.querySelector("a.bx-soa-price-not-calc"),"click",BX.delegate((function(){this.animateScrollTo(this.deliveryBlockNode)}),this)),BX.bind(this.mobileTotalBlockNode.querySelector("a.btn-order-save"),"click",BX.proxy(this.clickOrderSaveAction,this))},createTotalUnit:function(e,t,i){var s,a="bx-soa-cart-total-line";return e=e||"",t=t||"",s=(i=i||{}).error?[BX.create("A",{props:{className:"bx-soa-price-not-calc"},html:t,events:{click:BX.delegate((function(){this.animateScrollTo(this.deliveryBlockNode)}),this)}})]:i.free?[BX.create("SPAN",{props:{className:"bx-soa-price-free"},html:t})]:[t],i.total&&(a+=" bx-soa-cart-total-line-total"),i.highlighted&&(a+=" bx-soa-cart-total-line-highlighted"),BX.create("DIV",{props:{className:a},children:[BX.create("SPAN",{props:{className:"bx-soa-cart-t"},text:e}),BX.create("SPAN",{props:{className:"bx-soa-cart-d"+(i.total&&this.options.totalPriceChanged?" bx-soa-changeCostSign":"")},children:s})]})},basketBlockScrollCheckEvent:function(e){var t=e.target||e.srcElement,i=t.scrollLeft,s=t.scrollWidth-(i+t.clientWidth),a=t.parentNode;0==i?BX.removeClass(a,"bx-soa-table-fade-left"):BX.addClass(a,"bx-soa-table-fade-left"),0==s?BX.removeClass(a,"bx-soa-table-fade-right"):BX.addClass(a,"bx-soa-table-fade-right")},basketBlockScrollCheck:function(){var e,t,i,s,a,r,o,l,n=this.orderBlockNode.querySelectorAll("div.bx-soa-table-fade"),c=!1;for(a=0;a<n.length;a++)i=(e=n[a]).querySelector("div.bx-soa-item-table"),t=e.clientWidth,s=i.clientWidth||0,(c=c||s>t)?(o=(r=BX.firstChild(e)).scrollLeft,l=r.scrollWidth-(o+r.clientWidth),0==o?BX.removeClass(e,"bx-soa-table-fade-left"):BX.addClass(e,"bx-soa-table-fade-left"),0==l?BX.removeClass(e,"bx-soa-table-fade-right"):BX.addClass(e,"bx-soa-table-fade-right"),0==o&&0==l&&BX.addClass(e,"bx-soa-table-fade-right")):BX.removeClass(e,"bx-soa-table-fade-left bx-soa-table-fade-right")},totalBlockScrollCheck:function(){if(this.totalInfoBlockNode&&this.totalGhostBlockNode){var e,t=BX.GetWindowScrollPos().scrollTop,i=BX.pos(this.totalGhostBlockNode).top;BX.pos(this.orderBlockNode).bottom-this.totalBlockNode.offsetHeight<t+20?BX.addClass(this.totalInfoBlockNode,"bx-soa-cart-total-bottom"):BX.removeClass(this.totalInfoBlockNode,"bx-soa-cart-total-bottom"),t>i&&!BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")?(e=this.totalInfoBlockNode.offsetWidth,BX.addClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed"),this.totalGhostBlockNode.style.paddingTop=this.totalInfoBlockNode.offsetHeight+"px",this.totalInfoBlockNode.style.width=e+"px"):t<i&&BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")&&(BX.removeClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed"),this.totalGhostBlockNode.style.paddingTop=0,this.totalInfoBlockNode.style.width="")}},totalBlockResizeCheck:function(){this.totalInfoBlockNode&&this.totalGhostBlockNode&&BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")&&(this.totalInfoBlockNode.style.width=this.totalGhostBlockNode.offsetWidth+"px")},totalBlockFixFont:function(){var e,t,i=this.totalInfoBlockNode.querySelector(".bx-soa-cart-total-line.bx-soa-cart-total-line-total"),s=[];i&&(t=BX.lastChild(i),s.push({node:t,maxFontSize:28,smallestValue:!1,scaleBy:t.parentNode})),"Y"==this.params.SHOW_TOTAL_ORDER_BUTTON&&(e=this.totalInfoBlockNode.querySelector(".bx-soa-cart-total-button-container"))&&(t=BX.lastChild(e),s.push({node:t,maxFontSize:18,smallestValue:!1})),s.length&&BX.FixFontSize.init({objList:s,onAdaptiveResize:!0})},setAnalyticsDataLayer:function(e,t){if(this.params.DATA_LAYER_NAME){var i,s,a,r,o=[];for(s in this.result.GRID.ROWS)if(this.result.GRID.ROWS.hasOwnProperty(s)){for(r=this.result.GRID.ROWS[s],a=[],s=0;s<r.data.PROPS.length;s++)a.push(r.data.PROPS[s].VALUE);o.push({id:r.data.PRODUCT_ID,name:r.data.NAME,price:r.data.PRICE,brand:(r.data[this.params.BRAND_PROPERTY+"_VALUE"]||"").split(", ").join("/"),variant:a.join("/"),quantity:r.data.QUANTITY})}switch(e){case"checkout":i={event:"checkout",ecommerce:{checkout:{products:o}}};break;case"purchase":i={event:"purchase",ecommerce:{purchase:{actionField:{id:t,revenue:this.result.TOTAL.ORDER_TOTAL_PRICE,tax:this.result.TOTAL.TAX_PRICE,shipping:this.result.TOTAL.DELIVERY_PRICE},products:o}}}}window[this.params.DATA_LAYER_NAME]=window[this.params.DATA_LAYER_NAME]||[],window[this.params.DATA_LAYER_NAME].push(i)}},isOrderSaveAllowed:function(){return!0===this.orderSaveAllowed},allowOrderSave:function(){this.orderSaveAllowed=!0},disallowOrderSave:function(){this.orderSaveAllowed=!1},initUserConsent:function(){BX.ready(BX.delegate((function(){var e=BX.UserConsent&&BX.UserConsent.load(this.orderBlockNode);e&&(BX.addCustomEvent(e,BX.UserConsent.events.save,BX.proxy(this.doSaveAction,this)),BX.addCustomEvent(e,BX.UserConsent.events.refused,BX.proxy(this.disallowOrderSave,this)))}),this))}}}();