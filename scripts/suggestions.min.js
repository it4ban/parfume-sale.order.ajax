var Dadata=function(V){"use strict";const Oe=["country","region","area","city","city_district","settlement","street","house","flat"],Te=["region","area","city","city_district","settlement","planning_structure","street","house"],ee={country:["country_iso_code"],region:["region_iso_code","region_fias_id"],area:["area_fias_id"],city:["city_fias_id"],city_district:["city_district_fias_id"],settlement:["settlement_fias_id"],planning_structure:["planning_structure_fias_id"],street:["street_fias_id"]},te=Object.values(ee).flat(),Ce={country:{digits:0,zeros:13},region:{digits:2,zeros:11},area:{digits:5,zeros:8},city:{digits:8,zeros:5},city_district:{digits:11,zeros:2},settlement:{digits:11,zeros:2},planning_structure:{digits:15,zeros:2},street:{digits:15,zeros:2},house:{digits:19,zeros:0},flat:{digits:19,zeros:0}},se=s=>({type:`${s}_type`,withType:`${s}_with_type`,typeFull:`${s}_type_full`,base:s}),Le=s=>ee[s]||[],T=(s,e,t=!0)=>{const n=se(s),i=e[n.withType],r=t?[e[n.type],e[n.base]]:[e[n.base],e[n.type]],o=e[n.typeFull];return i||r.filter(Boolean).join(" ")||o},P=(s,e,t)=>{var o,a;if(!["address","fias"].includes(e))return[];const n=e==="address"?Oe:Te,i=n.indexOf(((o=s.from_bound)==null?void 0:o.value)||""),r=n.indexOf(((a=s.to_bound)==null?void 0:a.value)||"");return i===-1&&!t||r===-1?[]:n.slice(t?0:i,r+1)},Re=(s,e)=>{const t=Ce[e];if(!(!s||!t))return s.slice(0,t.digits)+"0".repeat(t.zeros)},ne=({bounds:s,suggestion:e,type:t}={})=>{if(!["address","fias"].includes(t)||!e.data||!s||typeof s!="object"||typeof e.data!="object")return e.value;const n=P(s,t);if(!n.length)return e.value;const i={country:e.data.country,region:T("region",e.data,!1),area:T("area",e.data),city:T("city",e.data),settlement:T("settlement",e.data),city_district:T("city_district",e.data),planning_structure:T("planning_structure",e.data),street:T("street",e.data),house:[t==="address"&&e.data.stead_type,t==="address"&&e.data.stead,e.data.house_type,e.data.house,e.data.block_type,e.data.block].filter(Boolean).join(" "),flat:[e.data.flat_type,e.data.flat].filter(Boolean).join(" ")};return e.data.region===e.data.city&&n.includes("city")&&n.includes("region")&&(i.region=""),n.map(r=>i[r]).filter(Boolean).join(", ")},G=({bounds:s,suggestion:e,type:t})=>{var o;if(!["address","fias"].includes(t))return e;const i=P(s,t,!0).map(a=>[...Object.values(se(a)),...Le(a)]).flat(),r=Object.fromEntries(Object.entries(e.data).filter(a=>i.includes(a[0])&&!!a[1]));return r.kladr_id=Re(e.data.kladr_id,(o=s.to_bound)==null?void 0:o.value),{...e,data:r}},m="_optionsProxy",K="_parentInstance",E="granular",Ve=["kladr_id","postal_code","country_iso_code","country","region_iso_code","region_fias_id","region_type_full","region","area_fias_id","area_type_full","area","city_fias_id","city_type_full","city","city_district_fias_id","city_district_type_full","city_district","settlement_fias_id","settlement_type_full","settlement","street_fias_id","street_type_full","street","house"],Pe=["kladr_id","region_fias_id","region_type_full","region","area_fias_id","area_type_full","area","city_fias_id","city_type_full","city","city_district_fias_id","city_district_type_full","city_district","settlement_fias_id","settlement_type_full","settlement","planning_structure_fias_id","planning_structure_type_full","planning_structure","street_fias_id","street_type_full","street"],Ie=(s,e)=>{if(!["address","fias"].includes(e))return{};const t=e==="address"?Ve:Pe,n=te.some(i=>t.includes(i)&&s.data[i]);return!n&&s.data.kladr_id?{kladr_id:s.data.kladr_id}:Object.fromEntries(Object.entries(s.data).filter(([i,r])=>!r||!t.includes(i)?!1:n?te.includes(i):!0))},w=(s,e)=>e?typeof e=="function"?e(s):e:{},Me=(s,e,t)=>{const n=e.find(d=>{const{type:g}=d[m].getOptions(E);return["address","fias"].includes(g)?!!d.getSelection():!1}),i=n==null?void 0:n.getSelection(),r=w(s,n==null?void 0:n.getOptions().params),o=t.type,a=w(s,t.params);let c;const u=a.locations;if(i){const d=G({bounds:r,suggestion:i,type:o});c=[Ie(d,o)]}const h=e.map(d=>{const g=d.getCurrentValue()||"",f=d[m].getOptions(E);return w(g,f.params).locations}).find(Boolean),l=c||h||u;return{locations:l,restrict_value:!!l}},k=s=>["address","fias"].includes(s),B=(s,e)=>{var u;const t=s[m].getOptions(E),n=e[m].getOptions(E);if(!k(t.type)||!k(n.type)||t.type!==n.type)return!1;const i=w(((u=s.getCurrentValue)==null?void 0:u.call(s))||"",t.params),r=w(e.getCurrentValue()||"",n.params),o=P(i,t.type,!0),a=P(r,n.type,!0),c=P(i,t.type).length>0;return o.every(h=>a.includes(h))&&c},I=(s,e)=>{const t=e.split(".");let n=s;for(;t.length&&n;){const i=t.shift();n=typeof n=="object"&&i?n[i]:void 0}return n},M=(s,e)=>typeof s!=typeof e?!1:typeof s=="object"&&s!=null&&e!=null?Object.keys(s).every(t=>{const n=t;return M(s[n],e[n])}):s===e,p=s=>Array.isArray(s)?s.map(p):typeof s=="object"&&s!==null?Object.fromEntries(Object.entries(s).map(([e,t])=>[e,p(t)])):s,Ne=(s,e)=>{const t=e.getSelection();if(!t)return!0;const n=e[m].getOptions(E),i=w(s.value,n.params),r=n.type,o=G({bounds:i,suggestion:s,type:r}),a=G({bounds:i,suggestion:t,type:r});return!M(a==null?void 0:a.data,o.data)},ie=(s,e)=>{Object.defineProperty(s,K,{value:e});const t=()=>{const i=[];let r=e;for(;r;)B(r,s)?(i.push(r),r=r[K]):r=void 0;return i},n={params:i=>{const r=s[m].getOptions(E),o=w(i,r.params);if(!k(r.type))return o;const a=Me(i,t(),r);return{...o,...a}},onSelect:(i,r)=>{const o=s[m].getOptions(E);typeof o.onSelect=="function"&&o.onSelect(i,r),t().forEach(a=>{Ne(i,a)&&a.setSuggestion(p(i))})},formatSelected:i=>{const r=s[m].getOptions(E),o=typeof r.formatSelected=="function"?r.formatSelected(i):null;if(!k(r.type)||o)return o;const a=w(i.value,r.params);return ne({bounds:a,suggestion:i,type:r.type})}};return s[m].subscribe(()=>n,E),s},De=s=>K in s,Ae=(s,e)=>{const t=De(e)?e:ie(e),n=ie(s,t),i=t.getInput(),r=()=>{B(t,n)&&n.clear()},o=c=>{const{suggestionChanged:u}=c.detail;!B(t,n)||!u||n.clear()},a=()=>{B(t,n)&&(i.removeEventListener("suggestions-invalidateselection",r),i.removeEventListener("suggestions-clear",r),i.removeEventListener("suggestions-select",o))};return i.addEventListener("suggestions-invalidateselection",r),i.addEventListener("suggestions-clear",r),i.addEventListener("suggestions-select",o),i.addEventListener("suggestions-dispose",a),n},x=({eventName:s,args:e,inputEl:t})=>{t.dispatchEvent(new CustomEvent(s,e&&{detail:e}))},y=`\\s"'~\\*\\.,:\\|\\[\\]\\(\\)\\{\\}<>№`,re=new RegExp(`[${y}]+`,"g"),F="\\-\\+\\\\\\?!@#$%^&",ke=new RegExp(`[${F}]+`,"g"),oe=()=>new RegExp(`([^${y}]*)([${y}]*)`,"g"),N=(s,e=[])=>{const n=s.toLowerCase().replaceAll("ё","е").replace(/(\d+)([а-я]{2,})/g,"$1 $2").replace(/([а-я]+)(\d+)/g,"$1 $2").split(re).filter(Boolean);if(!n.length)return[];if(!e.length)return n;const i=n.pop(),r=n.filter(o=>!e.includes(o));return r.push(i),r},ae=s=>s.toLowerCase().replace(/[ёЁ]/g,"е"),D=(s,e)=>{const t=ae(s).split(re).filter(Boolean);return e.length&&t.sort((n,i)=>e.includes(n)&&e.includes(i)?0:e.includes(n)?1:-1),t.map(n=>{const i=n.split(y);return i.length>1?[n,...i]:n}).flat()},j=s=>s.map(e=>e.split(ke).filter(Boolean)).flat(),ce=(s,e=[])=>N(s,e).join(" "),ue=(s,e)=>s.length>e.length&&s.toLowerCase().includes(e.toLowerCase()),le=s=>s.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),J=s=>{if(!s)return s;const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};let t=s;return Object.keys(e).forEach(i=>{t=t.replace(new RegExp(i,"g"),e[i])}),t},S=(s,e,t=[])=>{const n=e.map(a=>new RegExp(`^((.*)([${F}]+))?(${le(a)})([^${F}]*[${F}]*)`,"i")),i=[];let r;const o=oe();for(;(r=o.exec(s))&&r[0];){const a=r[1];i.push({text:a,hasUpperCase:a.toLowerCase()!==a,formatted:ae(a),matchable:!0,matched:!1}),r[2]&&i.push({text:r[2],hasUpperCase:!1,formatted:r[2],matchable:!1,matched:!1})}for(let a=0;a<i.length;a++){const c=i[a],u=!t.includes(c.formatted)||c.hasUpperCase;!c.matchable||c.matched||!u||n.every(h=>{let l=a+1;const d=h.exec(c.formatted);if(!d)return!0;const g={before:d[1]||"",beforeText:d[2]||"",beforeDelimiter:d[3]||"",text:d[4]||"",after:d[5]||""};if(g.before){i.splice(a,0,{text:c.text.substr(0,g.beforeText.length),formatted:g.beforeText,matchable:!0,hasUpperCase:!1,matched:!1},{text:g.beforeDelimiter,formatted:g.beforeDelimiter,matchable:!1,hasUpperCase:!1,matched:!1}),l+=2;const{length:R}=g.before;c.text=c.text.substr(R),c.formatted=c.formatted.substr(R),a--}const f=g.text.length+g.after.length;if(c.formatted.length>f&&(i.splice(l,0,{text:c.text.substr(f),formatted:c.formatted.substr(f),matchable:!0,hasUpperCase:!1,matched:!1}),c.text=c.text.substr(0,f),c.formatted=c.formatted.substr(0,f)),g.after){const R=g.text.length;i.splice(l,0,{text:c.text.substr(R),formatted:c.formatted.substr(R),matchable:!1,hasUpperCase:!1,matched:!1}),c.text=c.text.substr(0,R),c.formatted=c.formatted.substr(0,R)}return c.matched=!0,!1})}return i.map(a=>{const{text:c,matched:u}=a;return{text:J(c),rawText:c,matched:u}})},Be=(s,e)=>{const t=JSON.parse(JSON.stringify(s));let n=e,i=0;for(let r=0;r<t.length&&n>=0;r++)if(n-=t[r].rawText.length,i=r,n<0){const o=t[r].rawText.length+n;t[r].rawText=`${t[r].rawText.slice(0,o)}...`,t[r].text=J(t[r].rawText)}return t.slice(0,i+1)},Fe=s=>{let e;const t=[],n=oe();for(;(e=n.exec(s))&&e[0];)t.push(e[1]);return t},H=s=>(e,t)=>{if(t.length===0)return-1;const n=ce(e,s),i=[];return t.every((r,o)=>{const a=r.value.toLowerCase();return ue(e,a)||a.indexOf(n)>0?!1:(n===ce(r.value.toLowerCase(),s)&&i.push(o),!0)}),i.length===1?i[0]:-1},X=s=>(e,t)=>{if(!t.every(o=>o.value.indexOf(t[0].value)===0)||t.length===0)return-1;const i=[],r=j(N(e,s));return t.every((o,a)=>{if(ue(e,o.value))return!1;const c=j(N(o.value,s));return r.every(u=>c.includes(u))&&i.push(a),!0}),i.length===1?i[0]:-1},he=s=>(e,t)=>{if(t.length!==1||!Object.keys(s).length)return-1;const n=j(N(e)),r=Object.entries(s).map(([o,a])=>{const c=I(t[0],o);if(!(!c||typeof c!="string"))return j(N(c,a||[]))}).flat().filter(Boolean);return n.every(o=>r.some(a=>`${a}`.indexOf(o)===0))?0:-1};class C{constructor(e){this.noSuggestionsHint="Неизвестное значение",this.matchers=[H()],this.urlSlug=e,this.labelsDictionary={},this.unformattableTokens=[],this.enrichmentEndpoint=null}getSuggestionLabels(e,t){const n=Object.keys(this.labelsDictionary),i=t.some(a=>a.value===e.value&&a!==e);if(!n||!i||!e.data)return[];const r=[],o=n.reduce((a,c)=>(e.data[c]&&(a[c]=e.data[c]),a),{});return Fe(e.value).forEach(a=>{const c=Object.keys(o).find(u=>o[u]===a);c&&(r.push(this.labelsDictionary[c]),delete o[c])}),r.map(a=>J(a))}getEnrichmentParams(e,t){return{...t,count:1}}isQueryRequestable(e,t){return!0}findQueryMatches(e,t){const n=D(t,[]);return{main:{full:S(e.value,n,[])}}}isDataComplete(e){return!0}formatSelected(e){return e.value}}const b={suggest:"suggest",iplocate:"iplocate/address",status:"status",findById:"findById"},je="https://suggestions.dadata.ru/suggestions/api/4_1/rs",He=3e3,$e={[b.suggest]:{method:"POST",useSlug:!0},[b.iplocate]:{method:"GET",useSlug:!1},[b.status]:{method:"GET",useSlug:!0},[b.findById]:{method:"POST",useSlug:!0}},v=["ао","аобл","дом","респ","а/я","аал","автодорога","аллея","арбан","аул","б-р","берег","бугор","вал","вл","волость","въезд","высел","г","городок","гск","д","двлд","днп","дор","дп","ж/д_будка","ж/д_казарм","ж/д_оп","ж/д_платф","ж/д_пост","ж/д_рзд","ж/д_ст","жилзона","жилрайон","жт","заезд","заимка","зона","к","казарма","канал","кв","кв-л","км","кольцо","комн","кордон","коса","кп","край","линия","лпх","м","массив","местность","мкр","мост","н/п","наб","нп","обл","округ","остров","оф","п","п/о","п/р","п/ст","парк","пгт","пер","переезд","пл","пл-ка","платф","погост","полустанок","починок","пр-кт","проезд","промзона","просек","просека","проселок","проток","протока","проулок","р-н","рзд","россия","рп","ряды","с","с/а","с/мо","с/о","с/п","с/с","сад","сквер","сл","снт","спуск","ст","ст-ца","стр","тер","тракт","туп","у","ул","уч-к","ф/х","ферма","х","ш","бульвар","владение","выселки","гаражно-строительный","город","деревня","домовладение","дорога","квартал","километр","комната","корпус","литер","леспромхоз","местечко","микрорайон","набережная","область","переулок","платформа","площадка","площадь","поселение","поселок","проспект","разъезд","район","республика","село","сельсовет","слобода","сооружение","станица","станция","строение","территория","тупик","улица","улус","участок","хутор","шоссе"],Ue=["settlement_fias_id","settlement","settlement_type","settlement_type_full","settlement_with_type","street_fias_id","street","street_type","street_type_full","street_with_type","house","house_type","house_type_full","block","block_type","flat","flat_type","flat_type_full"];class qe extends C{constructor(e){super(e),this.noSuggestionsHint="Неизвестный адрес",this.matchers=[H(v),X(v)],this.urlSlug="address",this.unformattableTokens=v,this.enrichmentEndpoint=b.suggest}getEnrichmentParams(e,t){return{...t,count:1,query:e.unrestricted_value}}findQueryMatches(e,t){let{value:n}=e;const i=e.data.history_values,r=D(t,v);if(i&&i.length){const u=r.filter(l=>!n.includes(l)),h=this._getFormattedHistoryValues(u,i);h&&(n+=h)}const o=S(n,r,v),a=e.data.city_district_with_type;let c;return a&&Ue.some(u=>!!e.data[u])&&(c=S(a,r,v)),{main:{full:o},extra:c?[{full:c}]:void 0}}isDataComplete({suggestion:e,params:t}){var n;return!!e.data[((n=t.to_bound)==null?void 0:n.value)||"flat"]}_getFormattedHistoryValues(e,t){const n=t.filter(i=>!!e.find(r=>i.toLowerCase().includes(r)));return n.length?` (бывш. ${n.join(", ")})`:""}}class We extends C{constructor(e){super(e),this.noSuggestionsHint="Неизвестный банк",this.matchers=[he({value:null,"data.bic":null,"data.swift":null})],this.urlSlug="bank",this.unformattableTokens=v,this.enrichmentEndpoint=b.findById}getEnrichmentParams(e,t){return{...t,count:1,query:e.data.bic}}formatSelected(e){var t,n;return((n=(t=e.data)==null?void 0:t.name)==null?void 0:n.payment)||null}findQueryMatches(e,t){var h,l,d;const n=D(t,[]),i=S(((h=e.data)==null?void 0:h.bic)||"",n),r=((d=(l=e.data)==null?void 0:l.address)==null?void 0:d.value)||"",o=S(e.value,n);let a=null;if(r){const g=r.replace(/^\d{6}( РОССИЯ)?, /i,""),f=g.replace(new RegExp(`^([^${y}]+[${y}]+[^${y}]+).*`),"$1");a={full:S(g,n,v),short:[{text:f,matched:!1}]}}const c={full:i,short:i};return{main:{full:o},extra:a?[c,a]:[c]}}}const ze=!0;class Qe extends C{constructor(e){super(e),this.noSuggestionsHint="",this.urlSlug="email"}isQueryRequestable(e,t){return!!(t.suggest_local??ze)||e.indexOf("@")>=0}}class Ge extends C{constructor(e){super(e),this.noSuggestionsHint="Неизвестный адрес",this.matchers=[H(v),X(v)],this.urlSlug="fias"}findQueryMatches(e,t){const n=D(t,[]);return{main:{full:S(e.value,n,v)}}}isDataComplete({suggestion:e,params:t}){var n;return!!e.data[((n=t.to_bound)==null?void 0:n.value)||"house"]}}const Ke=(s,e)=>new RegExp(`^${le(e)}([${y}]|$)`,"i").test(s);class Je extends C{constructor(e){super(e),this.noSuggestionsHint="",this.matchers=[H(),X()],this.urlSlug="fio",this.labelsDictionary={surname:"фамилия",name:"имя",patronymic:"отчество"}}isDataComplete({suggestion:e,params:t}){let n;return Array.isArray(t==null?void 0:t.parts)?n=t.parts.map(i=>i.toLowerCase()):(n=["surname","name"],e.data.surname&&Ke(e.value,e.data.surname)&&n.push("patronymic")),n.every(i=>!!e.data[i])}}const Xe={LEGAL:[2,2,5,1],INDIVIDUAL:[2,2,6,2]},$=(s,e)=>{const t=s.some(i=>i.matched);return e.some(i=>i.matched)&&!t?e:s};class Ye extends C{constructor(e){super(e),this.noSuggestionsHint="Неизвестная организация",this.matchers=[he({value:null,"data.address.value":v,"data.inn":null,"data.ogrn":null})],this.urlSlug="party",this.enrichmentEndpoint=b.findById}getEnrichmentParams(e,t){return{...t,count:1,query:e.data.hid}}findQueryMatches(e,t){const n=D(t,[]),i=this._getINNMatches(e,n),r=S(I(e.data,"ogrn")||"",n),o=i?$(i,r):r,a=S(I(e.data,"management.name")||"",n),c=this._getAddressMatches(e,n),u=c?{full:$(c.full,a),short:$(c.short,a)}:{full:a,short:a},h=S(e.value,n),l=S(I(e.data,"name.latin")||"",n),d=$(h,l);return{main:{full:d,short:Be(d,50)},extra:[{full:o,short:o},u]}}_getINNMatches(e,t){var a,c;const n=(a=e.data)==null?void 0:a.inn;if(!n)return null;const i=Xe[(c=e.data)==null?void 0:c.type],r=S(n,t);if(!i)return r;const o=r.map(u=>u.text.split("").map(h=>({text:h,rawText:h,matched:u.matched,groupEnd:!1}))).flat();return i.forEach((u,h)=>{let l=u;const d=i.slice(0,h).reduce((g,f)=>g+f,0);for(let g=d;g<o.length&&l;g++)l===1&&(o[g].groupEnd=!0),l--}),o.reduce((u,h)=>{const l=u[u.length-1];return!l||l.matched!==h.matched||l.groupEnd?(u.push(h),u):(l.text+=h.text,l.groupEnd=h.groupEnd,u)},[])}_getAddressMatches(e,t){var o,a;const n=((a=(o=e.data)==null?void 0:o.address)==null?void 0:a.value)||"";if(!n)return null;const i=n.replace(/^(\d{6}|Россия),\s+/i,""),r=i.replace(new RegExp(`^([^${y}]+[${y}]+[^${y}]+).*`),"$1");return{full:S(i,t,v),short:[{text:r,rawText:r,matched:!1}]}}}const de={address:qe,name:Je,party:Ye,bank:We,email:Qe,fias:Ge,outward:C},ge=s=>{const e=de[s]||de.outward;return new e(s)},Ze="25.8.0",U=(s,e,t)=>{const n=$e[e];let i;if(s.url)i=s.url;else{const c=(s.serviceUrl||je).replace(/\/$/,"");i=n.useSlug&&t?`${c}/${e}/${t}`:`${c}/${e}`}const o={...(typeof s.headers=="function"?s.headers():s.headers)||{},"X-Version":Ze,"Content-Type":"application/json;charset=utf-8"};s.token&&(o.Authorization=`Token ${s.token}`),s.partner&&(o["X-Partner"]=s.partner);const a=new AbortController;return{url:i,method:n.method,params:{headers:o,controller:a,timeout:s.timeout??He}}};class _e extends Error{}const et=(s,e)=>{const t=e.signal.aborted?e.signal.reason||"aborted":"",n=s instanceof SyntaxError?"parsererror":"";return{statusText:s instanceof _e?s.message:"",code:t||n||"error"}},tt=(s,e)=>{let t;try{t=JSON.stringify(e)}catch{t=null}return t&&s!=="GET"?{body:t}:{}},st=(s,e)=>{s&&setTimeout(()=>{e.abort("timeout")},s)},Y=async(s,e,t,n)=>{const i=tt(e,n);st(t.timeout,t.controller);let r;try{if(r=await fetch(s,{method:e,headers:t.headers,signal:t.controller.signal,...i}),!r.ok)throw new _e(r.statusText);return{data:await r.json(),error:null,isAborted:!1,res:r}}catch(o){return{data:null,error:et(o,t.controller),isAborted:t.controller.signal.aborted,res:r}}},pe=()=>{let s;return async(e,t,n,i)=>{s&&s.abort(),s=n.controller;const r=await Y(e,t,n,i);return s=null,r}},fe=(s,e)=>{if(typeof e!="function")return{finalParams:s,canStartRequest:!0};const t=p(s),n=e(t);return{finalParams:t,canStartRequest:n!==!1}},q=s=>{if(typeof s=="string")return{value:s,unrestricted_value:s,data:{}};const e=typeof s.value=="string"?s.value:"",t={value:e,unrestricted_value:s.unrestricted_value??e,data:s.data??{}};return typeof t.unrestricted_value!="string"&&(t.unrestricted_value=e),typeof t.data!="object"&&(t.data={}),t},me=(s,e)=>{const t=s.filter(Boolean).map(q);if(typeof e!="function")return t;const n=p(t),i=e(n);return Array.isArray(i)?i.filter(Boolean).map(q):n};class nt{constructor(e,t,n){this._suggestionsRequestController=null,this.updateOptions=(i,r)=>{this._options=i,this._strategy=r},this._options=e,this._strategy=t,this._cache=n,this._makeRequest=pe()}abortSuggestionsRequest(){this._suggestionsRequestController&&this._suggestionsRequestController.abort()}async suggest(e,t,n){const{finalParams:i,canStartRequest:r}=fe(t,this._options.onSearchStart);if(!r)return;const o=this._getCachedSuggestions(i);if(o)return o;if(this._options.preventBadQueries&&this._cache.badQueries.check(e))return;const{urlSlug:a}=this._strategy,c=U(this._options,b.suggest,a),{url:u,method:h}=c;this._suggestionsRequestController=c.params.controller;const l=await this._makeRequest(u,h,c.params,i);if(this._suggestionsRequestController=null,l.data){const d=me(l.data.suggestions,this._options.onSuggestionsFetch);if(n()&&typeof this._options.onSearchComplete=="function"){this._options.onSearchComplete(e,p(d));return}return this._handleResponse(d,e,t)}!l.isAborted&&typeof this._options.onSearchError=="function"&&this._options.onSearchError(e,l.res,l.error.code,l.error.statusText)}_handleResponse(e,t,n){const i=e.map(this._enrichSuggestionFromCache.bind(this)),{noCache:r,preventBadQueries:o}=this._options;if(!r){const a={suggestions:i};this._cache.suggest.set(n,this._options.type,a),o&&!i.length&&this._cache.badQueries.set(t)}if(typeof this._options.onSearchComplete=="function"){const a=i.map(({suggestion:c})=>c);this._options.onSearchComplete(t,a)}return i}_getCachedSuggestions(e){const t=this._cache.suggest.get(e,this._options.type);if(t)return t.suggestions.map(n=>n.enriched?n:this._enrichSuggestionFromCache(n.suggestion))}_enrichSuggestionFromCache(e){const t=this._options.noCache?null:this._cache.enrich.get(e,this._options.type);return{suggestion:t||e,enriched:!!t}}}class it{constructor(e,t,n){this._enrichRequestController=null,this.updateOptions=(i,r)=>{this._options=i,this._strategy=r},this._options=e,this._strategy=t,this._cache=n,this._makeRequest=pe()}abortEnrichRequest(){this._enrichRequestController&&this._enrichRequestController.abort()}async enrich(e,t,n){const{enrichmentEndpoint:i,urlSlug:r,getEnrichmentParams:o}=this._strategy,{onSearchStart:a}=this._options,c=o(e.suggestion,t);if(!this._canEnrich(e,c.query)||!i)return;const{finalParams:u,canStartRequest:h}=fe(c,a);if(!h)return;const{url:l,method:d,params:g}=U(this._options,i,r);this._enrichRequestController=g.controller;const f=await this._makeRequest(l,d,g,u);if(this._enrichRequestController=null,!(!f.data||n()))return this._handleResponse(f.data,e.suggestion)}_handleResponse(e,t){const n=me(e.suggestions,this._options.onSuggestionsFetch);return this._options.noCache||this._cache.enrich.set(this._options.type,n[0],t),n[0]}_canEnrich(e,t){return e.enriched?!1:this._options.preventBadQueries?!this._cache.badQueries.check(t):!0}}const rt="X-Plan",A={};class ot{constructor(e,t){this._options=e,this._strategy=t,this._fetchStatus()}getStatus(){var e;return(e=A[this._statusCacheKey])==null?void 0:e.result}updateOptions(e,t){this._options=e,this._strategy=t,this._fetchStatus()}async _fetchStatus(){if(A[this._statusCacheKey]){const r=await A[this._statusCacheKey].request;if(!r.error||typeof this._options.onSearchError!="function")return;this._options.onSearchError(null,r.res,"error","");return}const e=this._createRequest();A[this._statusCacheKey]={request:e};const{data:t,error:n,res:i}=await e;if(n||!t.search){typeof this._options.onSearchError=="function"&&this._options.onSearchError(null,i,"error","");return}A[this._statusCacheKey].result={planName:i.headers.get(rt)||""}}get _statusCacheKey(){return this._options.type+(this._options.token||"").trim()}_createRequest(){const{url:e,method:t,params:n}=U(this._options,b.status,this._strategy.urlSlug);return Y(e,t,n)}}const at=()=>{let s={};return{get:(e,t)=>{const n=JSON.stringify(e)+t;return s[n]},set:(e,t,n)=>{const i=JSON.stringify(e)+t;s[i]=n},clear:()=>{s={}}}},ct=()=>{let s={};return{get:(e,t)=>{const n=JSON.stringify(e.data)+t;return s[n]},set:(e,t,n)=>{const i=JSON.stringify(n.data)+e;s[i]=t},clear:()=>{s={}}}},ut=()=>{let s=[];return{check:e=>s.length?s.some(t=>e.startsWith(t)):!1,set:e=>{s.push(e)},clear:()=>{s=[]}}},lt=()=>{const s={suggest:at(),enrich:ct(),badQueries:ut()};return{cache:s,clearCache:()=>{s.suggest.clear(),s.enrich.clear(),s.badQueries.clear()}}},ht=(s,e,t)=>{const{cache:n,clearCache:i}=lt(),r=new nt(s,e,n),o=new it(s,e,n),a=new ot(s,e);return{updateOptions:(l,d)=>{r.updateOptions(l,d),o.updateOptions(l,d),a.updateOptions(l,d)},getSuggestions:async(l,d)=>(o.abortEnrichRequest(),await r.suggest(l,d,()=>t(l))),enrichSuggestion:async(l,d,g)=>(r.abortSuggestionsRequest(),await o.enrich(l,d,()=>t(g))),abortSuggestionsRequest:r.abortSuggestionsRequest.bind(r),clearCache:i,getStatus:a.getStatus.bind(a)}},dt=1,gt="Выберите вариант или продолжите ввод",_t=!1,pt=5,ft=!0;class mt{constructor(e,t){this._options=e,this._strategy=ge(e.type),this._suggestionsService=ht(e,this._strategy,t),this._suggestionsWithState=[],this.chosenSuggestion=null,this.chosenSuggestionIndex=-1,this.suggestionsFetchPromise=Promise.resolve(),this.abortSuggestionsRequest=this._suggestionsService.abortSuggestionsRequest.bind(this._suggestionsService),this.clearCache=this._suggestionsService.clearCache.bind(this._suggestionsService),this.getStatus=this._suggestionsService.getStatus.bind(this._suggestionsService)}getSuggestions(){return this._suggestionsWithState.map(e=>e.suggestion)}getSuggestionsData(e){return this._autoSelectFirst(),this.getSuggestions().map(t=>this._prepareSuggestionData(t,e))}getSelection(){return this.chosenSuggestion}clear(){this._suggestionsService.clearCache(),this._suggestionsWithState=[],this.chosenSuggestion=null,this.chosenSuggestionIndex=-1}getSuggestionsHint(){const{hint:e}=this._options;return e===!1||typeof e=="string"?e:gt}getNoSuggestionsHint(){const e=this._options.noSuggestionsHint;return e===!1||typeof e=="string"?e:this._strategy.noSuggestionsHint}updateOptions(e){this._options=e,this._strategy=ge(e.type),this._suggestionsService.updateOptions(e,this._strategy)}updateChosenSuggestionIndex(e){this.chosenSuggestionIndex=e}invalidateChosenSuggestion(){this.chosenSuggestionIndex=-1,this.chosenSuggestion=null}async fetchSuggestions(e){return this.suggestionsFetchPromise=this._makeSuggestionsRequest(e),await this.suggestionsFetchPromise}async selectSuggestionByIndex(e,t,n=!0){const i=this._suggestionsWithState[e];if(!i)return{selected:!1};let r=null;const o=this._options.enrichmentEnabled??ft,a=this._getParams(t);if(o&&n){const{enrichSuggestion:d}=this._suggestionsService;r=await d(i,a,t)}const c={suggestion:r||i.suggestion,enriched:!!r},u=this._getSuggestionValue(c.suggestion),h=M(c.suggestion,this.chosenSuggestion);this.chosenSuggestion=c.suggestion,this._suggestionsWithState[e]=c,this.chosenSuggestionIndex=e;const l=this._strategy.isDataComplete({suggestion:c.suggestion,params:a});return{selected:!0,suggestionValue:u,areSuggestionsSame:h,isFinal:l}}async selectMatchingSuggestion(e,t=!0){const n=this._findMatchingSuggestionIndex(e);return await this.selectSuggestionByIndex(n,e,t)}setSuggestion(e){if(!this._validateSuggestion(e))return;const t=q(e);this._suggestionsService.abortSuggestionsRequest();const n=this._getSuggestionValue(t);return t.value=n,this.chosenSuggestion=t,this.chosenSuggestionIndex=0,this._suggestionsWithState=[{suggestion:t,enriched:!1}],{suggestionValue:n}}async fixData(e){const t=this._getParams(e),n=await this._suggestionsService.getSuggestions(e,{...t,count:1}),i=n==null?void 0:n[0];if(!i)return{selected:!1};const r=this._getSuggestionValue(i.suggestion);i.suggestion.value=r;const o=M(i.suggestion,this.chosenSuggestion);this.chosenSuggestion=i.suggestion,this._suggestionsWithState=[i];const a=this._strategy.isDataComplete({suggestion:i.suggestion,params:t});return{selected:!0,suggestionValue:r,areSuggestionsSame:o,isFinal:a}}canProcessQuery(e){return e.length>=(this._options.minChars||dt)&&this._strategy.isQueryRequestable(e,this._options)}async _makeSuggestionsRequest(e){const t=await this._suggestionsService.getSuggestions(e,this._getParams(e));return t?(this._suggestionsWithState=t.map(p),{fetched:!0,suggestions:this.getSuggestionsData(e)}):{fetched:!1}}_autoSelectFirst(){(this._options.autoSelectFirst??_t)&&(this.chosenSuggestionIndex=0)}_getSuggestionValue(e){const t=typeof this._options.formatSelected=="function"?this._options.formatSelected(e):this._strategy.formatSelected(e);return typeof t=="string"?t:e.value}_findMatchingSuggestionIndex(e){if(this.chosenSuggestionIndex!==-1)return this.chosenSuggestionIndex;if(!e)return-1;let t=-1;return this._strategy.matchers.some(n=>(t=n(e,this.getSuggestions()),t!==-1)),t}_prepareSuggestionData(e,t){const n=this._strategy.getSuggestionLabels(e,this.getSuggestions());if(typeof this._options.formatResult=="function")return{formattedResult:this._options.formatResult(e.value,t,e,{unformattableTokens:this._strategy.unformattableTokens}),matches:null,labels:n,suggestion:e};let i=e;if(typeof this._options.beforeFormat=="function"){const o=this._options.beforeFormat(p(e),t);this._validateSuggestion(o)&&(i=q(o))}return{formattedResult:null,matches:this._strategy.findQueryMatches(i,t),labels:n,suggestion:e}}_validateSuggestion(e){try{return!e||typeof e!="object"||!("data"in e)||e.data===null?!1:typeof e.data=="object"}catch{return!1}}_getParams(e){const t=typeof this._options.params=="function"?this._options.params(e):this._options.params;return{query:e,count:pt,...t||{}}}}const O=s=>{const e=document.createElement(s.tagName),{dataset:t,...n}=s.attributes||{};return Object.assign(e,n),Object.entries(t||{}).forEach(([i,r])=>{e.dataset[i]=r}),e.innerHTML=s.content||"",e},_={hint:"suggestions-hint",nowrap:"suggestions-nowrap",promo:"suggestions-promo",selected:"suggestions-selected",suggestion:"suggestions-suggestion",subtext:"suggestions-subtext",subtext_inline:"suggestions-subtext suggestions-subtext_inline",subtext_delimiter:"suggestions-subtext-delimiter",subtext_label:"suggestions-subtext suggestions-subtext_label",removeConstraint:"suggestions-remove",value:"suggestions-value",hiddenMobile:"suggestions-suggestion_hidden-mobile",hiddenDesktop:"suggestions-suggestion_hidden-desktop",wrapper:"suggestions-wrapper",wrapper_active:"suggestions-wrapper--active",container:"suggestions-suggestions",containerWithPromo:"suggestions-suggestions--with-promo",containerWithoutHint:"suggestions-suggestions--nohint",input:"suggestions-input",wrapperMobile:"suggestions-wrapper--mobile"},St=100,vt=600,yt=!1,bt=!0,Et=!0,wt=!1,xt=!1,L={ENTER:"Enter",ESC:"Escape",TAB:"Tab",SPACE:"Space",UP:"ArrowUp",DOWN:"ArrowDown"},Ot="FREE",Tt="https://dadata.ru/suggestions/?utm_source=dadata&utm_medium=module&utm_campaign=suggestions-jquery",Ct='<svg version="1.1" viewBox="0 0 128 38" xmlns="http://www.w3.org/2000/svg"><path d="m128 19v16.077c0 1.614-1.302 2.923-2.909 2.923h-122.18c-1.607 0-2.909-1.309-2.909-2.923v-32.154c-0-1.614 1.302-2.923 2.909-2.923h122.18c1.607 0 2.909 1.309 2.909 2.923z" fill="#ef4741"/><path d="m59.52 7.912h-8.902v22.098h9.92c3.724 0 9.872-0.341 9.872-6.703v-8.682c-0.01-6.372-7.166-6.713-10.89-6.713zm5.595 14.81c0 3.186-2.308 3.508-4.936 3.508h-4.276v-14.538h3.287c2.628 0 5.954 0.322 5.954 3.508zm-46.545-14.81h-8.834v22.098h9.871c3.724 0 9.872-0.341 9.872-6.703v-8.682c0-6.372-7.137-6.713-10.88-6.713zm5.595 14.81c0 3.186-2.308 3.508-4.936 3.508h-4.247v-14.538h3.258c2.628 0 5.954 0.322 5.954 3.508zm71.757-13.953h-4.945v16.301c-0.018 0.785 0.113 1.565 0.388 2.3 0.203 0.569 0.535 1.082 0.97 1.5 0.446 0.385 0.962 0.677 1.522 0.858 0.58 0.205 1.182 0.343 1.794 0.409 0.575 0.052 1.248 0.081 2.017 0.088 0.917-1e-3 1.834-0.057 2.744-0.166v-2.796h-1.765c-0.393 0.055-0.795 0.032-1.18-0.071-0.385-0.102-0.745-0.28-1.06-0.524-0.413-0.691-0.59-1.498-0.504-2.299v-8.068h4.509v-3.06h-4.509zm20.364 5.535c-1.176-0.741-3.278-1.108-6.303-1.101h-5.741v0.243l0.708 2.826h5.033c0.837-0.051 1.672 0.117 2.424 0.487 0.259 0.248 0.458 0.553 0.579 0.891 0.121 0.339 0.162 0.701 0.119 1.058v1.12h-5.527c-1.939 0-3.271 0.38-3.995 1.14-0.725 0.76-1.099 2.127-1.125 4.102 0 2.154 0.359 3.06 1.086 3.742 0.728 0.682 2.134 1.188 4.344 1.188h6.847c1.706 0 3.345-0.808 3.345-2.747v-8.584c0-2.176-0.589-3.635-1.765-4.375zm-3.19 12.959h-3.249c-0.735 0.081-1.478-0.036-2.152-0.342-0.285-0.227-0.427-0.876-0.427-1.948s0.136-1.741 0.407-2.007c0.625-0.331 1.336-0.46 2.037-0.371h3.384zm-26.667-12.959c-1.176-0.741-3.277-1.108-6.303-1.101h-5.741v0.243l0.708 2.826h5.033c0.836-0.051 1.672 0.117 2.424 0.487 0.259 0.248 0.457 0.553 0.578 0.891 0.121 0.339 0.162 0.701 0.12 1.058v1.12h-5.556c-1.939 0-3.271 0.38-3.995 1.14s-1.086 2.127-1.086 4.102c0 2.154 0.359 3.06 1.086 3.742s2.133 1.188 4.344 1.188h6.846c1.717 0 3.346-0.808 3.346-2.747v-8.584c-7e-3 -2.176-0.595-3.635-1.765-4.375zm-3.181 12.959h-3.248c-0.735 0.081-1.478-0.037-2.153-0.342-0.284-0.227-0.426-0.876-0.426-1.948s0.135-1.741 0.407-2.007c0.624-0.331 1.336-0.46 2.036-0.371h3.384zm-37.74-12.959c-1.176-0.741-3.278-1.108-6.303-1.101h-5.712v0.243l0.708 2.826h5.033c0.837-0.051 1.672 0.117 2.424 0.487 0.259 0.248 0.457 0.553 0.578 0.891 0.121 0.339 0.162 0.701 0.12 1.058v1.12h-5.556c-1.939 0-3.271 0.38-3.995 1.14s-1.099 2.127-1.125 4.102c0 2.154 0.359 3.06 1.086 3.742s2.133 1.188 4.344 1.188h6.846c1.717 0 3.346-0.808 3.346-2.747v-8.584c0-2.176-0.589-3.635-1.765-4.375zm-3.181 12.959h-3.219c-0.735 0.081-1.478-0.037-2.153-0.342-0.284-0.227-0.427-0.876-0.427-1.948s0.136-1.741 0.408-2.007c0.624-0.331 1.336-0.46 2.036-0.371h3.384z" fill="#fff"/></svg>',Lt=s=>{if(s!==Ot)return;const e=O({tagName:"a",attributes:{href:Tt,tabIndex:-1,target:"_blank"},content:Ct}),t=O({tagName:"div",attributes:{className:_.promo}});return e.addEventListener("click",()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()}),t.append(e),t},Rt=s=>{const e=s.split(", ");return e.length===1?s:e.map(t=>`<span class="${_.nowrap}">${t}</span>`).join(", ")},W=(s,e)=>{const t=s.map(i=>{let r=i.matched?`<strong>${i.text}</strong>`:i.text;return i.groupEnd&&(r+=`<span class="${_.subtext_delimiter}"></span>`),r}).join(""),n=Rt(t);return e?`<span class="${_.subtext_inline}">${n}</span>`:n},Vt=s=>{var i,r;const e={full:W(s.main.full,!1),short:W(s.main.short||[],!1)},t={full:(i=s.extra)==null?void 0:i.map(o=>o.full).map((o,a,{length:c})=>W(o,a!==c-1)),short:(r=s.extra)==null?void 0:r.map(o=>o.short).filter(o=>typeof o<"u").map((o,a,{length:c})=>W(o,a!==c-1))},n=o=>o.flat().filter(a=>a!==void 0).join("");return{mainValue:e,extraValue:s.extra?{full:n(t.full),short:n(t.short)}:null}},Se=({full:s,short:e})=>{if(!e)return s;const{hiddenMobile:t,hiddenDesktop:n}=_;return`<span class="${t}">${s}</span><span class="${n}">${e}</span>`},Pt=s=>{const e=document.createDocumentFragment();if(!s.matches)return e;const{mainValue:t,extraValue:n}=Vt(s.matches),i=I(s.suggestion.data,"state.status");return e.appendChild(O({tagName:"span",attributes:{className:_.value,dataset:i?{suggestionStatus:i}:{}},content:Se(t)})),s.labels.length&&e.appendChild(O({tagName:"span",attributes:{className:_.subtext_label},content:s.labels.join(", ")})),n&&e.appendChild(O({tagName:"div",attributes:{className:_.subtext},content:Se(n)})),e},It=s=>{const e=O({tagName:"div",attributes:{className:_.suggestion+(s.selected?` ${_.selected}`:""),dataset:{index:`${s.index}`}}});return s.formattedResult?e.innerHTML=s.formattedResult:e.appendChild(Pt(s)),{suggestionNode:e,updateSelection:n=>{e.classList.remove(_.selected),n&&e.classList.add(_.selected)}}},ve=s=>s?`<div class="${_.hint}">${s}</div>`:"",Mt=s=>s.suggestions.map((e,t)=>{const n=s.selectedIndex===t,{suggestionNode:i,updateSelection:r}=It({...e,index:t,selected:n}),o=()=>s.onClick(t);return i.addEventListener("click",o),{suggestionNode:i,updateSelection:r,clickHandler:o,index:t}});class Nt{constructor(){this._suggestionsNodes=[],this._closeDelay=0,this.isVisible=!1,this.wrapper=O({tagName:"div",attributes:{className:_.wrapper}}),this._container=O({tagName:"div",attributes:{className:_.container}}),this._container.style.display="none",this.wrapper.appendChild(this._container),this.wrapper.addEventListener("mousedown",e=>{e.preventDefault()})}render(e){if(this._closeDelay=typeof e.closeDelay=="number"?e.closeDelay:0,clearTimeout(this._closeTimer),!e.suggestions.length&&!e.noSuggestionsHint){this.hide();return}if(!e.suggestions.length)this._container.innerHTML=ve(e.noSuggestionsHint);else{const n=ve(e.hint);this._container.innerHTML=n,this._container.classList.toggle(_.containerWithoutHint,!n),this._suggestionsNodes=Mt(e),this._suggestionsNodes.forEach(({suggestionNode:i})=>this._container.appendChild(i))}const t=Lt(e.planName);t&&this._container.appendChild(t),this._container.classList.toggle(_.containerWithPromo,!!t),typeof e.beforeRender=="function"&&e.beforeRender(this._container),this._container.style.display="block",this.wrapper.classList.add(_.wrapper_active),this.isVisible=!0}hide(){this.wrapper.classList.remove(_.wrapper_active),this.isVisible=!1,this._suggestionsNodes.forEach(({suggestionNode:e,clickHandler:t})=>{e.removeEventListener("click",t)}),this._suggestionsNodes=[],this._closeTimer=setTimeout(()=>{this._container.style.display="none",this._container.innerHTML=""},this._closeDelay)}updateSelected(e){this._suggestionsNodes.forEach(({updateSelection:t,index:n})=>{t(n===e)})}}const ye={autocomplete:"new-password",autocorrect:"off",autocapitalize:"off",spellcheck:"false"},Dt=s=>{Object.entries(ye).forEach(([e,t])=>{const n=s.getAttribute(e);n&&(s.dataset[e]=n),s.setAttribute(e,t)})},At=s=>{Object.keys(ye).forEach(e=>{s.dataset[e]?s.setAttribute(e,s.dataset[e]):s.removeAttribute(e)})},kt=(s,e)=>{Object.entries(e).forEach(([t,n])=>s.addEventListener(t,n))},Bt=(s,e)=>{Object.entries(e).forEach(([t,n])=>s.removeEventListener(t,n))};class Ft{constructor(e){this._lastInputValue=null,this._prevHandledValue=null,this._currentListeners={},this._el=e}init(e){this._currentListeners=e,Dt(this._el),kt(this._el,this._currentListeners),this._el.classList.add(_.input)}dispose(){At(this._el),Bt(this._el,this._currentListeners),this._el.classList.remove(_.input)}getValue(){return this._el.value}setValue(e){this._lastInputValue=null,this._el.value=e,this.updateSavedValue(),document.activeElement===this._el&&this.setCursorAtEnd()}isChanged(){return this._prevHandledValue!==this._el.value}updateSavedValue(){this._prevHandledValue=this._el.value}setTemporalValue(e){this._lastInputValue===null&&(this._lastInputValue=this._el.value),this._el.value=e,this.updateSavedValue(),document.activeElement===this._el&&this.setCursorAtEnd()}restoreLastSavedValue(){this._lastInputValue!==null&&this.setValue(this._lastInputValue)}getEl(){return this._el}triggerFocus(){const{focus:e}=this._currentListeners;e&&this._el.removeEventListener("focus",e),this._el.focus(),e&&this._el.addEventListener("focus",e)}setCursorAtEnd(){setTimeout(()=>{try{const{type:e}=this._el;!(this._el instanceof HTMLTextAreaElement)&&e!=="text"&&(this._el.type="text"),this._el.setSelectionRange(-1,-1),!(this._el instanceof HTMLTextAreaElement)&&e!=="text"&&(this._el.type=e)}catch{this._el.value=this.getValue()}})}isCursorAtEnd(){return this._el.selectionStart===this.getValue().length}}const jt=()=>{let s,e=new Promise(a=>{s=a,a("rejected")}),t;return{getPromise:()=>e,reject:()=>{s("rejected")},resolve:()=>(s("resolved"),e),startTimer:a=>(e=new Promise(c=>{if(s=c,!a){c("resolved");return}t=setTimeout(()=>c("resolved"),a)}),e),clearTimer:()=>{clearTimeout(t)}}};class z{constructor(e){this._view=e.view,this._containerView=e.containerView,this._canChooseSuggestion=!0,this._provider=e.provider,this._options=e.options,this._inputDelayTimer=jt()}updateOptions(e){this._options=e}updateProvider(e){this._provider=e}_triggerOnSelectNothing(){this._provider&&(typeof this._options.onSelectNothing=="function"&&this._options.onSelectNothing(this._view.getValue()),x({eventName:"suggestions-selectnothing",args:{query:this._view.getValue()},inputEl:this._view.getEl()}))}_triggerOnSelect(e,t){!this._provider||e||!this._provider.chosenSuggestion||(typeof this._options.onSelect=="function"&&this._options.onSelect(this._provider.chosenSuggestion,t),x({eventName:"suggestions-select",args:{suggestion:this._provider.chosenSuggestion,suggestionChanged:t},inputEl:this._view.getEl()}))}_triggerFixData(e){this._provider&&x({eventName:"suggestions-fixdata",args:{suggestion:e?this._provider.chosenSuggestion:null},inputEl:this._view.getEl()})}_triggerInvalidate(){const{chosenSuggestion:e}=this._provider||{};!this._provider||!e||(this._provider.invalidateChosenSuggestion(),typeof this._options.onInvalidateSelection=="function"&&this._options.onInvalidateSelection(e),x({eventName:"suggestions-invalidateselection",args:{suggestion:e},inputEl:this._view.getEl()}))}}class Ht extends z{async handleNavigate(e){if(!this._canChooseSuggestion||!this._provider)return;const t=this._getNextIndex(e);if(t===null){this._provider.updateChosenSuggestionIndex(-1),this._containerView.updateSelected(-1),this._view.restoreLastSavedValue();return}const n=this._provider.getSuggestions()[t];this._provider.updateChosenSuggestionIndex(t),this._containerView.updateSelected(t),this._view.setTemporalValue(n.value||"")}_getNextIndex(e){if(!this._provider)return null;const t=this._provider.getSuggestions().length,n=t-1,{chosenSuggestionIndex:i}=this._provider;return e==="down"?i===n?null:i+1:i===0||i===-1&&!t?null:i!==-1?i-1:n}}class $t extends z{async chooseSuggestion(e){if(!this._canChooseSuggestion||!this._provider)return;this._canChooseSuggestion=!1;const t=this._view.getValue(),n=await this._provider.selectSuggestionByIndex(e,t);this._view.triggerFocus(),this._handleSelection(n,t,!0),n.selected&&n.suggestionValue&&this._containerView.hide(),this._canChooseSuggestion=!0}async chooseMatchingSuggestion(e){if(!this._provider)return;if(!await this._hasSuggestionsToChoose()){this._containerView.hide();return}this._canChooseSuggestion=!1;const n=this._view.getValue(),i=await this._provider.selectMatchingSuggestion(n);this._provider.abortSuggestionsRequest(),this._handleSelection(i,n,e),this._containerView.hide(),this._canChooseSuggestion=!0}async chooseAndContinue(){if(!await this._hasSuggestionsToChoose()||!this._provider)return;this._canChooseSuggestion=!1;const t=this._view.getValue(),n=await this._provider.selectMatchingSuggestion(t,!1);this._provider.abortSuggestionsRequest(),this._handleSelection(n,t,!0),this._provider.updateChosenSuggestionIndex(-1),this._canChooseSuggestion=!0}async triggerFixData(e){if(!this._canChooseSuggestion||!this._provider)return;this._canChooseSuggestion=!1;const t=this._view.getValue(),n=await this._provider.fixData(e);n.selected&&this._handleSelection(n,t,!0),this._triggerFixData(n.selected),this._containerView.hide(),this._canChooseSuggestion=!0}_handleSelection(e,t,n){let i=e.suggestionValue||"";i&&n&&!e.isFinal&&(i+=" "),e.selected&&this._view.setValue(i),!e.selected||!i?this._triggerOnSelectNothing():this._triggerOnSelect(e.areSuggestionsSame,i!==t)}async _hasSuggestionsToChoose(){if(!this._canChooseSuggestion||!this._provider)return!1;this._inputDelayTimer.clearTimer(),await this._inputDelayTimer.resolve();const e=await this._provider.suggestionsFetchPromise;return!!(e!=null&&e.fetched&&!this._provider.chosenSuggestion)}}class Ut extends z{async handleInput(){if(!(!this._provider||!this._view.isChanged()||(this._view.updateSavedValue(),this._provider.abortSuggestionsRequest(),this._inputDelayTimer.clearTimer(),this._inputDelayTimer.reject(),await this._inputDelayTimer.startTimer(this._options.deferRequestBy??St)!=="resolved"||!this._provider)))return this._triggerInvalidate(),await this.getSuggestionsIfAllowed()}async getSuggestionsIfAllowed(){if(this._provider){if(!this._provider.canProcessQuery(this._view.getValue())){this._containerView.hide();return}return await this._provider.fetchSuggestions(this._view.getValue())}}}class qt extends z{constructor(e,t){super(t),this._getIsMobile=e,this._suggestModel=new Ut(t),this._selectModel=new $t(t),this._navigateModel=new Ht(t),this.triggerFixData=this._selectModel.triggerFixData.bind(this._selectModel)}async updateSuggestions(){var t;const e=await((t=this._provider)==null?void 0:t.fetchSuggestions(this._view.getValue()));e&&this._triggerRender(e)}updateOptions(...e){super.updateOptions(...e),this._suggestModel.updateOptions(...e),this._selectModel.updateOptions(...e),this._navigateModel.updateOptions(...e)}updateProvider(...e){super.updateProvider(...e),this._suggestModel.updateProvider(...e),this._selectModel.updateProvider(...e),this._navigateModel.updateProvider(...e)}getListeners(){const e=()=>{setTimeout(this._handleFocus.bind(this),10)};return{input:this._handleInput.bind(this),focus:e,blur:this._handleBlur.bind(this),keydown:this._handleKeyDown.bind(this)}}_handleKeyDown(e){var i;const n=(i={[L.ENTER]:this._handleEnter,[L.SPACE]:this._handleSpace,[L.ESC]:this._handleEsc,[L.UP]:this._handleUp,[L.DOWN]:this._handleDown,[L.TAB]:this._handleTab}[e.code])==null?void 0:i.bind(this);if(n){n(e);return}Object.values(L).includes(e.code)&&this._cancelKeyDown(e)}_cancelKeyDown(e){e.stopImmediatePropagation(),e.preventDefault()}_handleEnter(){(this._options.triggerSelectOnEnter??Et)&&(this._containerView.isVisible?this._selectModel.chooseMatchingSuggestion(!0):this._triggerOnSelectNothing())}_handleSpace(e){!(this._options.triggerSelectOnSpace??wt)||!this._view.isCursorAtEnd()||(this._cancelKeyDown(e),this._selectModel.chooseAndContinue())}_handleTab(e){(this._options.tabDisabled??xt)&&this._cancelKeyDown(e)}_handleEsc(){this._provider&&(this._view.restoreLastSavedValue(),this._containerView.hide(),this._provider.abortSuggestionsRequest(),this._provider.updateChosenSuggestionIndex(-1))}_handleUp(){this._containerView.isVisible&&this._navigateModel.handleNavigate("up")}_handleDown(){if(this._provider)if(this._containerView.isVisible)this._navigateModel.handleNavigate("down");else{const e=this._provider.getSuggestionsData(this._view.getValue());this._triggerRender({fetched:!0,suggestions:e})}}async _handleFocus(){const e=document.activeElement===this._view.getEl();if(!this._provider||!e)return;const t=await this._suggestModel.getSuggestionsIfAllowed();t&&(this._checkChoosenSuggestion(t),this._triggerRender(t)),this._getIsMobile()&&(this._view.setCursorAtEnd(),(this._options.scrollOnFocus??yt)&&this._view.getEl().scrollIntoView({behavior:"smooth"}))}async _handleBlur(){this._provider&&(this._provider.abortSuggestionsRequest(),this._options.triggerSelectOnBlur??bt?await this._selectModel.chooseMatchingSuggestion():this._containerView.hide())}async _handleInput(){const e=await this._suggestModel.handleInput();e&&this._triggerRender(e)}_checkChoosenSuggestion(e){if(!e.fetched||!this._provider||!this._provider.chosenSuggestion)return;const t=e.suggestions.findIndex(n=>{var i;return M((i=this._provider)==null?void 0:i.chosenSuggestion,n.suggestion)});this._provider.updateChosenSuggestionIndex(t)}_triggerRender(e){var i,r;if(!(e!=null&&e.fetched)||!this._provider)return;const t=this._provider.getSelection(),n=(i=e.suggestions[0])==null?void 0:i.suggestion;e.suggestions.length===1&&(t==null?void 0:t.value)===n.value||this._containerView.render({hint:this._provider.getSuggestionsHint(),noSuggestionsHint:this._provider.getNoSuggestionsHint(),suggestions:e.suggestions,planName:((r=this._provider.getStatus())==null?void 0:r.planName)||"",selectedIndex:this._provider.chosenSuggestionIndex,onClick:this._selectModel.chooseSuggestion.bind(this._selectModel),beforeRender:this._options.beforeRender,closeDelay:this._options.closeDelay})}}const Wt=(s,e)=>{const t=window.matchMedia(`(max-width: ${s}px)`);e(t.matches);const n=i=>{e(i.matches)};return t.addEventListener("change",n),e(t.matches),()=>{t.removeEventListener("change",n)}},zt=(s,e)=>{const t=new Ft(s),n=new Nt;s.after(n.wrapper);let i=!1;const r=h=>Wt(h??vt,l=>{i=l,n.wrapper.classList.toggle(_.wrapperMobile,l)});let o=r(e.mobileWidth);const a=new mt(e,h=>t.getValue()!==h),c=new qt(()=>i,{view:t,containerView:n,provider:a,options:e});return t.init(c.getListeners()),{provider:a,inputModel:c,mobileObserver:{disconnect:()=>o(),reset:h=>{o=r(h)}},containerView:n,inputView:t}},be=(s,e)=>{const t=Object.entries(s).map(([n,i])=>typeof i!="function"?[n,i]:[n,i.bind(e)]);return Object.fromEntries(t)},Qt=s=>{const e=s.getBoundingClientRect();return e.width>0&&e.height>0&&document.body.contains(s)},Gt=(s,e)=>{if(!(s instanceof HTMLInputElement)&&!(s instanceof HTMLTextAreaElement))return()=>{};const t={root:document.documentElement},n=new IntersectionObserver(i=>{i.forEach(r=>{e(r.intersectionRatio>0,()=>n.disconnect())})},t);return Qt(s)?e(!0,()=>n.disconnect()):n.observe(s),()=>n.disconnect()},Kt=(s,e)=>{let t={isEnabled:!1},n=p(be(e,s));const i=()=>({isEnabled:!0,...zt(s,n)}),r=Gt(s,(o,a)=>{t=o?i():{isEnabled:!1},o&&a()});return{setOptions:o=>{n=p({...n,...be(o,s)}),t.isEnabled&&(t.provider.updateOptions(n),t.inputModel.updateOptions(n),t.mobileObserver.disconnect(),t.mobileObserver.reset(n.mobileWidth))},disable:()=>{t.isEnabled&&(t.provider.abortSuggestionsRequest(),t.containerView.hide(),t.inputModel.updateProvider(void 0),t.mobileObserver.disconnect())},enable:()=>{t.isEnabled&&(t.mobileObserver.reset(n.mobileWidth),t.inputModel.updateProvider(t.provider))},dispose:()=>{r(),t.isEnabled&&(x({eventName:"suggestions-dispose",inputEl:t.inputView.getEl()}),t.inputView.dispose(),t.containerView.wrapper.remove(),t.mobileObserver.disconnect(),t={isEnabled:!1})},clear:()=>{if(!t.isEnabled)return;const{provider:o,inputView:a,containerView:c}=t,{chosenSuggestion:u}=o;o.clear(),a.setValue(""),c.hide(),x({eventName:"suggestions-clear",inputEl:a.getEl()}),u&&(typeof n.onInvalidateSelection=="function"&&n.onInvalidateSelection(u),x({eventName:"suggestions-invalidateselection",args:{suggestion:u},inputEl:a.getEl()}))},setSuggestion:o=>{if(!t.isEnabled){if(!s)return;r(),t=i()}const{suggestionValue:a}=t.provider.setSuggestion(o)||{};t.inputView.setValue(a||""),t.provider.abortSuggestionsRequest(),x({eventName:"suggestions-set",inputEl:t.inputView.getEl()})},fixData:o=>{var a;(a=t.inputModel)==null||a.triggerFixData(o)},updateSuggestions:()=>{var o;(o=t.inputModel)==null||o.updateSuggestions()},hide:()=>{var o;(o=t.containerView)==null||o.hide()},clearCache:()=>{var o;(o=t.provider)==null||o.clearCache()},getCurrentValue:()=>s.value,getSelectedIndex:()=>{var o;return((o=t.provider)==null?void 0:o.chosenSuggestionIndex)??-1},getSelection:()=>{var o;return((o=t.provider)==null?void 0:o.getSelection())??null},getSuggestions:()=>t.provider?t.provider.getSuggestions():[],getOptions:()=>p(n),getInput:()=>s}},Ee=async(s={})=>{const{url:e,method:t,params:n}=U(s,b.iplocate),{data:i}=await Y(e,t,n);return(i==null?void 0:i.location)||null},Jt=!0,Xt=["address","party","bank"],Z="geolocate";let Q=null;const we=s=>Xt.includes(s.type)?"geolocation"in s?!!s.geolocation:Jt:!1,Yt=s=>{let e;const t=async r=>{if(!we(r))return;const o=s[m].getOptions(Z);Q=Q||Ee(o),e=await Q},n={params:r=>{const o=s[m].getOptions(Z),a=w(r,o.params);if(!we(o))return a;const c=e?[{kladr_id:e.data.kladr_id}]:null;return c&&(a.locations_boost=c),a}};s[m].subscribe(r=>(t(r),n),Z);const i=s;return i.getLocation=()=>Q||Promise.resolve(null),i},xe=s=>{const e=[],t=s.getOptions(),n=s.setOptions;s.setOptions=a=>{Object.assign(t,p(a));const c=p(t);e.forEach(u=>{Object.assign(c,u.cb(c)||{})}),n(c)};const i=a=>{const c=e.findIndex(l=>l.id===a);if(c===-1)return t;const u=e.slice(0,c),h=p(t);return u.forEach(l=>{Object.assign(h,l.cb(h)||{})}),h};return Object.defineProperty(s,m,{value:{subscribe:(a,c)=>{e.push({cb:a,id:c});const u=i(c),h=a(p(u));h&&n(h)},getOptions:i}}),s.getOptions=()=>p(t),s},Zt=s=>m in s;class es{}const ts=(s,...[e,t])=>{const n=Kt(s,e);Object.setPrototypeOf(n,es);const i=xe(n),r=Yt(i),o=t&&Object.getPrototypeOf(t)===Object.getPrototypeOf(n);if(!t||!o)return r;const a=Zt(t)?t:xe(t);return Ae(r,a)};return V.createSuggestions=ts,V.getBoundedValue=ne,V.getLocation=Ee,Object.defineProperty(V,Symbol.toStringTag,{value:"Module"}),V}({});
